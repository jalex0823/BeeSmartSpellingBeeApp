{% extends "base.html" %}

{% block title %}Aja's Magical Spelling Bee - BeeSmart{% endblock %}

{% block extra_css %}
<style>
    .quiz-main-container {
        max-width: 700px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--hive-card);
        border-radius: 20px;
        box-shadow: var(--hive-shadow);
        backdrop-filter: blur(10px);
        position: relative;
    }
    
    .quiz-header {
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .quiz-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-amber);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .saved-lists-section {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .saved-lists-title {
        color: var(--accent-color);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .word-list-selector {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--secondary-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        margin-bottom: 1rem;
        background: white;
    }
    
    .list-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }
    
    .list-action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .use-list-btn {
        background: var(--primary-color);
        color: white;
    }
    
    .delete-list-btn {
        background: #FF6B6B;
        color: white;
    }
    
    .refresh-lists-btn {
        background: var(--secondary-color);
        color: white;
    }
    
    .list-action-btn:hover {
        transform: translateY(-1px);
        opacity: 0.9;
    }
    
    .back-menu-btn {
        background: #9CA3AF;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 2rem;
    }
    
    .back-menu-btn:hover {
        background: #6B7280;
    }
    
    .spelling-challenge {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .challenge-title {
        color: var(--accent-color);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .progress-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .progress-stats span {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .word-definition {
        background: rgba(255, 182, 193, 0.2);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-primary);
    }
    
    .audio-controls {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .audio-progress {
        width: 100%;
        height: 8px;
        background: #333;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .audio-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00BFFF, #1E90FF);
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .audio-ready {
        background: #333;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .spelling-input {
        width: 100%;
        max-width: 400px;
        padding: 1rem;
        border: 2px solid var(--secondary-color);
        border-radius: var(--border-radius);
        font-size: 1.2rem;
        text-align: center;
        margin-bottom: 2rem;
        background: white;
    }
    
    .spelling-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
    }
    
    .quiz-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .quiz-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 140px;
        justify-content: center;
    }
    
    .submit-btn {
        background: var(--primary-color);
        color: white;
    }
    
    .speak-btn {
        background: #8B5CF6;
        color: white;
    }
    
    .skip-btn {
        background: #06B6D4;
        color: white;
    }
    
    .reset-btn {
        background: var(--accent-color);
        color: white;
    }
    
    .quiz-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }
    
    .fairy-decoration {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-8px) rotate(5deg); }
    }
    
    .hidden {
        display: none;
    }
    
    @media (max-width: 768px) {
        .quiz-main-container {
            margin: 1rem;
            padding: 1rem;
        }
        
        .list-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .quiz-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .quiz-btn {
            width: 100%;
            max-width: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-main-container">
    <div class="fairy-decoration">üßö‚Äç‚ôÄÔ∏è</div>
    
    <div class="quiz-header">
        <h1 class="quiz-title">üåü Aja's Magical Spelling Bee ‚ú®</h1>
    </div>
    
    <!-- Saved Word Lists Section -->
    <div class="saved-lists-section">
        <h2 class="saved-lists-title">üìö Saved Word Lists</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Select from your saved word lists:</p>
        
        <select class="word-list-selector" id="wordListSelector">
            <option value="">50Words_kidfriendly (51 words) - Current</option>
        </select>
        
        <div class="list-actions">
            <button class="list-action-btn use-list-btn" id="useListBtn">
                ‚úì Use This List
            </button>
            <button class="list-action-btn delete-list-btn" id="deleteListBtn">
                üóëÔ∏è Delete List
            </button>
            <button class="list-action-btn refresh-lists-btn" id="refreshListsBtn">
                üîÑ Refresh Lists
            </button>
        </div>
        
        <button class="back-menu-btn" onclick="window.location.href='/'">
            ‚Üê Back to Menu
        </button>
    </div>
    
    <!-- Spelling Challenge Section -->
    <div class="spelling-challenge">
        <h2 class="challenge-title">üéØ Spelling Challenge</h2>
        
        <div class="progress-stats">
            <span>‚ú® Word <span id="currentWord">1</span> of <span id="totalWords">51</span></span>
            <span>üèÜ Correct: <span id="correctCount">0</span></span>
            <span>üìù Tries: <span id="triesCount">0</span></span>
            <span>üî• Streak: <span id="streakCount">0</span></span>
        </div>
        
        <div class="word-definition" id="wordDefinition">
            A yearly book with calendars and weather facts. Example: Grandpa checked the ______ to see when to plant crops.
        </div>
        
        <div class="audio-controls">
            <div style="text-align: center;">
                <div class="audio-progress">
                    <div class="audio-progress-fill" id="audioProgress"></div>
                </div>
                <button class="audio-ready" id="audioBtn">
                    üéµ Ready
                </button>
            </div>
        </div>
        
        <input type="text" class="spelling-input" id="spellingInput" placeholder="Type your spelling here...">
        
        <div class="quiz-actions">
            <button class="quiz-btn submit-btn" id="submitBtn">
                üìù Submit Answer
            </button>
            <button class="quiz-btn speak-btn" id="speakBtn">
                üó£Ô∏è Speak Word
            </button>
            <button class="quiz-btn skip-btn" id="skipBtn">
                ‚è≠Ô∏è Skip Word
            </button>
        </div>
        
        <div class="quiz-actions">
            <button class="quiz-btn reset-btn" id="resetBtn">
                üîÑ Reset Quiz
            </button>
            <button class="quiz-btn speak-btn" id="muteBtn" title="Toggle audio feedback">
                üîä Audio On
            </button>
        </div>
    </div>
    
    <div id="quizStatus" style="text-align: center; margin-top: 1rem;"></div>
</div>

<script>
class MagicalSpellingBee {
    constructor() {
        this.currentWordIndex = 0;
        this.words = [];
        this.stats = {
            correct: 0,
            tries: 0,
            streak: 0
        };
        
        // Audio system for feedback
        this.audioEnabled = true;
        this.audioContext = null;
        
        // Check for reduced motion preference
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
            this.audioEnabled = false;
        }
        
        this.initializeAudio();
        this.initializeEventListeners();
        this.loadWordList();
    }
    
    initializeAudio() {
        try {
            // Create audio context on user interaction (required by browsers)
            document.addEventListener('click', () => {
                if (!this.audioContext && this.audioEnabled) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }, { once: true });
        } catch (error) {
            console.log('Audio context not available:', error);
            this.audioEnabled = false;
        }
    }
    
    playCorrectSound() {
        if (!this.audioEnabled || !this.audioContext) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            // Happy ascending notes
            oscillator.frequency.setValueAtTime(523.25, this.audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, this.audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, this.audioContext.currentTime + 0.2); // G5
            
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + 0.5);
        } catch (error) {
            console.log('Error playing correct sound:', error);
        }
    }
    
    playIncorrectSound() {
        if (!this.audioEnabled || !this.audioContext) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            // Sad descending notes
            oscillator.frequency.setValueAtTime(392.00, this.audioContext.currentTime); // G4
            oscillator.frequency.setValueAtTime(329.63, this.audioContext.currentTime + 0.15); // E4
            
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + 0.4);
        } catch (error) {
            console.log('Error playing incorrect sound:', error);
        }
    }
    
    toggleAudio() {
        this.audioEnabled = !this.audioEnabled;
        const muteBtn = document.getElementById('muteBtn');
        if (this.audioEnabled) {
            muteBtn.textContent = 'üîä Audio On';
            this.showStatus('üîä Audio feedback enabled', 'info');
        } else {
            muteBtn.textContent = 'üîá Audio Off';
            this.showStatus('üîá Audio feedback muted', 'info');
        }
    }

        };
        this.initializeEventListeners();
        this.loadWordList();
    }
    
    initializeEventListeners() {
        document.getElementById('useListBtn').addEventListener('click', () => this.loadWordList());
        document.getElementById('deleteListBtn').addEventListener('click', () => this.deleteList());
        document.getElementById('refreshListsBtn').addEventListener('click', () => this.refreshLists());
        document.getElementById('submitBtn').addEventListener('click', () => this.submitAnswer());
        document.getElementById('speakBtn').addEventListener('click', () => this.speakWord());
        document.getElementById('skipBtn').addEventListener('click', () => this.skipWord());
        document.getElementById('resetBtn').addEventListener('click', () => this.resetQuiz());
        document.getElementById('audioBtn').addEventListener('click', () => this.playAudio());
        document.getElementById('muteBtn').addEventListener('click', () => this.toggleAudio());
        
        // Enter key to submit
        document.getElementById('spellingInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.submitAnswer();
            }
        });
    }
    
    async loadWordList() {
        try {
            const response = await fetch('/api/wordbank');
            if (response.ok) {
                const data = await response.json();
                this.words = data.words || [];
                if (this.words.length > 0) {
                    this.currentWordIndex = 0;
                    this.updateDisplay();
                    this.showCurrentWord();
                } else {
                    this.showStatus('No words available. Please upload a word list first.', 'error');
                }
            }
        } catch (error) {
            this.showStatus('Error loading word list: ' + error.message, 'error');
        }
    }
    
    updateDisplay() {
        document.getElementById('currentWord').textContent = this.currentWordIndex + 1;
        document.getElementById('totalWords').textContent = this.words.length;
        document.getElementById('correctCount').textContent = this.stats.correct;
        document.getElementById('triesCount').textContent = this.stats.tries;
        document.getElementById('streakCount').textContent = this.stats.streak;
    }
    
    async showCurrentWord() {
        if (this.currentWordIndex >= this.words.length) {
            this.showQuizComplete();
            return;
        }
        
        const currentWord = this.words[this.currentWordIndex];
        
        // Get definition/hint
        try {
            const response = await fetch('/api/pronounce', { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                document.getElementById('wordDefinition').textContent = data.definition || currentWord.sentence || 'Spell the word you hear.';
            }
        } catch (error) {
            document.getElementById('wordDefinition').textContent = currentWord.sentence || 'Spell the word you hear.';
        }
        
        // Clear input
        document.getElementById('spellingInput').value = '';
        document.getElementById('spellingInput').focus();
        
        this.updateDisplay();
    }
    
    async submitAnswer() {
        const input = document.getElementById('spellingInput').value.trim();
        if (!input) return;
        
        this.stats.tries++;
        
        try {
            const response = await fetch('/api/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_input: input,
                    method: 'keyboard',
                    elapsed_ms: 0
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.correct) {
                    this.stats.correct++;
                    this.stats.streak++;
                    this.playCorrectSound(); // Play success sound
                    this.showStatus(`‚úÖ Correct! "${data.expected}"`, 'success');
                    setTimeout(() => {
                        this.currentWordIndex++;
                        this.showCurrentWord();
                    }, 1500);
                } else {
                    this.stats.streak = 0;
                    this.playIncorrectSound(); // Play error sound
                    this.showStatus(`‚ùå Try again! ${data.feedback_message}`, 'error');
                }
                this.updateDisplay();
            }
        } catch (error) {
            this.showStatus('Error submitting answer: ' + error.message, 'error');
        }
    }
    
    async speakWord() {
        try {
            // Use Web Speech API for TTS
            if ('speechSynthesis' in window) {
                const currentWord = this.words[this.currentWordIndex];
                if (!currentWord) {
                    this.showStatus('‚ùå No word to speak', 'error');
                    return;
                }
                
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create utterance
                const utterance = new SpeechSynthesisUtterance(currentWord.word);
                utterance.rate = 0.8; // Slower for spelling practice
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = 'en-US';
                
                // Add event handlers
                utterance.onstart = () => {
                    this.showStatus('üó£Ô∏è Speaking word...', 'info');
                };
                
                utterance.onend = () => {
                    this.showStatus('‚úÖ Word spoken', 'success');
                };
                
                utterance.onerror = (event) => {
                    this.showStatus('‚ùå Speech error: ' + event.error, 'error');
                };
                
                // Speak the word
                window.speechSynthesis.speak(utterance);
                
                // Also fetch phonetic pronunciation from API
                try {
                    const response = await fetch('/api/pronounce', { method: 'POST' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.phonetic) {
                            // Display phonetic pronunciation after speaking
                            setTimeout(() => {
                                this.showStatus(`üìñ Pronunciation: ${data.phonetic}`, 'info');
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.log('Phonetic fetch failed:', error);
                }
                
            } else {
                // Fallback for browsers without Web Speech API
                this.showStatus('‚ùå Speech synthesis not supported in this browser', 'error');
                
                // Try to fetch and display phonetic instead
                const response = await fetch('/api/pronounce', { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.phonetic) {
                        this.showStatus(`ÔøΩ Pronunciation: ${data.phonetic} (Audio not available)`, 'info');
                    } else {
                        this.showStatus('üó£Ô∏è Pronunciation not available', 'error');
                    }
                }
            }
        } catch (error) {
            this.showStatus('Error speaking word: ' + error.message, 'error');
        }
    }
    
    skipWord() {
        this.currentWordIndex++;
        this.stats.streak = 0;
        this.showCurrentWord();
        this.showStatus('‚è≠Ô∏è Word skipped', 'info');
    }
    
    async resetQuiz() {
        this.currentWordIndex = 0;
        this.stats = { correct: 0, tries: 0, streak: 0 };
        
        try {
            await fetch('/api/reset', { method: 'POST' });
            this.showCurrentWord();
            this.showStatus('üîÑ Quiz reset', 'info');
        } catch (error) {
            this.showStatus('Error resetting quiz: ' + error.message, 'error');
        }
    }
    
    playAudio() {
        // Simulate audio progress
        const progressBar = document.getElementById('audioProgress');
        progressBar.style.width = '0%';
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 2;
            progressBar.style.width = progress + '%';
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }, 50);
        
        this.showStatus('üéµ Playing word audio', 'info');
    }
    
    deleteList() {
        if (confirm('Are you sure you want to delete this word list?')) {
            this.showStatus('üóëÔ∏è List deletion not implemented yet', 'info');
        }
    }
    
    refreshLists() {
        this.loadWordList();
        this.showStatus('üîÑ Lists refreshed', 'info');
    }
    
    showQuizComplete() {
        const accuracy = this.stats.tries > 0 ? Math.round((this.stats.correct / this.stats.tries) * 100) : 0;
        document.getElementById('wordDefinition').innerHTML = `
            <h3>üéâ Quiz Complete!</h3>
            <p><strong>Final Score:</strong></p>
            <p>Correct: ${this.stats.correct}/${this.words.length}</p>
            <p>Accuracy: ${accuracy}%</p>
            <p>Total Tries: ${this.stats.tries}</p>
        `;
        
        // Hide input and some buttons
        document.getElementById('spellingInput').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('speakBtn').style.display = 'none';
        document.getElementById('skipBtn').style.display = 'none';
    }
    
    showStatus(message, type) {
        const statusDiv = document.getElementById('quizStatus');
        statusDiv.textContent = message;
        statusDiv.className = `status-${type}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide after 3 seconds for info messages
        if (type === 'info' || type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new MagicalSpellingBee();
});
</script>
{% endblock %}