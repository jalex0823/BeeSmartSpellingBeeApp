<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BeeSmart Spelling App</title>
    
    <!-- Favicon for all platforms -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/BeeSmart.css') }}">
    <!-- Three.js for 3D Bees - Updated CDN for iOS Safari compatibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <!-- Expose model base path for OBJ/MTL/texture assets -->
    <script>
        window.BEE_MODEL_BASE = "{{ url_for('static', filename='models') }}/";
    </script>
    <!-- Mascot Bee 3D Component -->
    <script src="{{ url_for('static', filename='js/mascot-3d.js') }}"></script>
    <!-- User Avatar Loader -->
    <script src="{{ url_for('static', filename='js/user-avatar-loader.js') }}"></script>
    <script>
        // Early version + fetch interceptor (loads before rest of page JS)
        (function(){
            const VERSION = 'unified_menu_v2.1-' + Date.now();
            console.log('\u2728 BeeSmart unified_menu.html loaded (early) VERSION=', VERSION);
            // Disable distracting floating decorations on the home screen
            // This hides sparkles/fairies and prevents their initialization later.
            window.DISABLE_FLOATING_DECOR = true;
            if (!window._originalFetch){
                window._originalFetch = window.fetch.bind(window);
                window.fetch = function(resource, init){
                    try { console.log('[EARLY FETCH]', resource, init && init.method); } catch(e){}
                    return window._originalFetch(resource, init).then(r=>{
                        try { console.log('[EARLY FETCH RESPONSE]', resource, r.status); } catch(e){}
                        return r;
                    });
                };
            }
            // Detect any legacy calls by monkey patching FormData send (best-effort)
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--hive-background);
            color: var(--dark-brown);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 0;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Magical background particles */
        .magic-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #FFD700, transparent);
            border-radius: 50%;
            animation: sparkleFloat 8s linear infinite;
            opacity: 0;
        }
        
        .sparkle:nth-child(odd) {
            background: radial-gradient(circle, #FF69B4, transparent);
            animation-duration: 6s;
            animation-delay: -2s;
        }
        
        .sparkle:nth-child(3n) {
            background: radial-gradient(circle, #87CEEB, transparent);
            animation-duration: 10s;
            animation-delay: -4s;
        }

        /* Content Filter Modal Animation */
        @keyframes modalBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-10deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.1) rotate(5deg);
            }
            70% {
                transform: scale(0.95) rotate(-2deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        /* Status Badge Hover Effects */
        #contentFilterStatusBadge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* Button Hover Effects */
        .content-filter-popup button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes sparkleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Fairy trail animation */
        .fairy-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            overflow: hidden;
        }
        
        .fairy {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFD700, transparent);
            border-radius: 50%;
            opacity: 0.8;
            animation: fairyFlight 15s linear infinite;
        }
        
        .fairy::before {
            content: '✨';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 12px;
            animation: fairySparkle 2s ease-in-out infinite;
        }
        
        .fairy::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            transform: translate(-50%, -50%);
            opacity: 0.6;
        }
        
        @keyframes fairyFlight {
            0% {
                transform: translateX(-50px) translateY(80vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            50% {
                transform: translateX(50vw) translateY(20vh) rotate(180deg);
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateX(calc(100vw + 50px)) translateY(70vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes fairySparkle {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: hue-rotate(0deg);
            }
            50% { 
                transform: scale(1.2) rotate(180deg);
                filter: hue-rotate(90deg);
            }
        }
        
        /* Main container */
        .main-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Single unified card containing logo and menu */
        .content-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(255, 240, 246, 0.7) 100%);
            border-radius: 30px;
            overflow: visible;        /* Changed from hidden to visible for avatar visibility */
            box-shadow: 0 18px 45px rgba(255, 170, 200, 0.32);
            border: 3px solid rgba(255, 220, 238, 0.65);
            position: relative;
            z-index: 5;              /* Lowered from 10 to 5 to stay below avatar (z-index: 15) */
            animation: cardFloat 6s ease-in-out infinite;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }
        
        @keyframes cardFloat {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }
            50% {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            }
        }
        
        .content-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 24px 50px rgba(255, 170, 200, 0.38);
        }
        
        /* Magical shimmer overlay for card */
        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 8s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        
        /* ANTI-CLIP: Ensure containers do not clip the avatar */
        .main-card, .page-card, .container-card, .logo-section {
            position: relative;
            overflow: visible !important;
        }
        
        /* Logo section at top of card */
        .logo-section {
            background: transparent;
            text-align: center;
            padding: 1rem 2rem 0.75rem 2rem; /* reduced bottom padding to tighten spacing */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Avatar container fixes */
            overflow: visible !important;        /* Prevent clipping of 3D avatar */
            z-index: 30;              /* Ensure the avatar/name area sits above following sections */
        }
        
        /* 3D Mascot container - permanently centered with flexbox */
        #mascotBee3D {
            width: 200px;
            height: 200px;
            margin: 0;
            position: relative;
            transform: translateY(0);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Avatar visibility fixes */
            z-index: 100;              /* Keep well above name plate and tiles */
            overflow: visible !important;        /* Prevent clipping */
            max-height: none !important;
            height: auto !important;
            clip-path: none !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }
        
        /* Three.js canvas styling for proper layering */
        #mascotBee3D canvas {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            pointer-events: none;     /* Allow clicks through to UI */
            z-index: 100 !important;   /* Ensure visibility above all cards */
            object-fit: contain !important;
        }
        
        #mascotBee3D:hover {
            transform: translateY(-15px) scale(1.05);
        }
        
        /* Bee click FX: pop + glow */
        .bee-pop {
            animation: beePop 900ms ease-out;
        }
        .bee-glow {
            animation: beeGlowPulse 1200ms ease-in-out;
            filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.9))
                    drop-shadow(0 0 22px rgba(255, 165, 0, 0.55));
        }
        @keyframes beePop {
            0%   { transform: translateY(0) scale(1) rotate(0deg); }
            30%  { transform: translateY(-6px) scale(1.08) rotate(-3deg); }
            60%  { transform: translateY(-2px) scale(1.04) rotate(2deg); }
            100% { transform: translateY(0) scale(1) rotate(0deg); }
        }
        @keyframes beeGlowPulse {
            0%, 100% { filter: drop-shadow(0 0 6px rgba(255, 215, 0, 0.6)); }
            50%      { filter: drop-shadow(0 0 16px rgba(255, 215, 0, 1)); }
        }

        /* Burst sparkles emitted from the bee on click */
        .bee-burst {
            position: absolute;
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: radial-gradient(circle, #FFD700, transparent 60%);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: beeBurst 900ms ease-out forwards;
            z-index: 120;
        }
        .bee-burst.pink  { background: radial-gradient(circle, #FF7AC3, transparent 60%); }
        .bee-burst.blue  { background: radial-gradient(circle, #7EC8FF, transparent 60%); }
        .bee-burst.orange{ background: radial-gradient(circle, #FFA500, transparent 60%); }
        @keyframes beeBurst {
            from { opacity: 1; transform: translate(-50%, -50%) scale(0.6); }
            to   { opacity: 0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2); }
        }

        /* Caption click feedback */
        .caption-highlight { animation: captionPulse 650ms ease-out; }
        @keyframes captionPulse {
            0% { transform: scale(1); color: #FF6B00; }
            50% { transform: scale(1.12); color: #FFB347; }
            100% { transform: scale(1); color: #FF6B00; }
        }

        /* Temporarily re-enable background decor when FX are active */
        .fx-enabled .magic-background,
        .fx-enabled .fairy-container { display: block !important; }

        @keyframes gentlePulse {
            0%, 100% {
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }
        
        #mascotCaption {
            position: relative;
            z-index: 5;              /* Below avatar (15) to prevent overlap */
        }

        /* Ensure avatar name/status badge stays behind the 3D avatar */
        #avatarSystemStatus { position: relative; z-index: 10; }

        /* Reduce distraction: remove floating sparkles/fairies on home screen */
        .magic-background,
        .fairy-container,
        .sparkle,
        .fairy { display: none !important; }
        /* Hide any inline decorative elements using the sparkleFloat animation */
        [style*="sparkleFloat"] { display: none !important; }
        
        #mascotCaption:hover {
            color: #FFB347;
            transform: scale(1.1);
        }
        
        .logo-section img {
            width: 280px;
            height: auto;
            max-width: 320px;
        }
        
        /* Menu options container */
        .menu-container {
            padding: 0 2rem 2rem 2rem;
            background: transparent;
        }
        
        /* Individual menu options */
        .menu-option {
            --tile-bg: linear-gradient(135deg, #FFE3F5, #FFD6EB);
            --tile-border: rgba(255, 255, 255, 0.7);
            --tile-shadow: rgba(255, 105, 180, 0.25);
            --tile-hover-shadow: rgba(255, 105, 180, 0.4);
            --tile-text: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.6rem;
            margin-bottom: 1.5rem;
            border: 3px solid var(--tile-border);
            border-radius: 24px;
            background: var(--tile-bg);
            color: var(--tile-text);
            transition: all 0.35s ease;
            cursor: pointer;
            text-align: center;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 22px var(--tile-shadow);
        }

        /* Tiny badge for counts on tiles (e.g., Saved Lists) */
        .option-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #5A2C15;
            font-weight: 800;
            font-size: 12px;
            border: 2px solid rgba(255, 255, 255, 0.95);
            border-radius: 999px;
            padding: 2px 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            pointer-events: none;
            min-width: 22px;
            text-align: center;
        }
        
        .menu-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.2), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s ease;
            pointer-events: none;
        }
        
        .menu-option:last-child {
            margin-bottom: 0;
        }
        
        .menu-option:hover {
            border-color: rgba(255, 255, 255, 0.95);
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 18px 32px var(--tile-hover-shadow);
            animation: magicalPulse 1.5s ease-in-out infinite;
        }
        
        .menu-option:hover::before {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.1), transparent);
        }
        
        @keyframes magicalPulse {
            0%, 100% {
                box-shadow: 0 10px 24px var(--tile-shadow);
            }
            50% {
                box-shadow: 0 16px 36px var(--tile-hover-shadow), 0 0 28px rgba(255, 255, 255, 0.25);
            }
        }

        .menu-option.active {
            border-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 14px 30px var(--tile-hover-shadow);
        }

        /* Kid-friendly color themes */
        .menu-option.theme-berry {
            --tile-bg: linear-gradient(135deg, #FF7DEB 0%, #FF4FB1 45%, #F72585 100%);
            --tile-border: rgba(255, 255, 255, 0.65);
            --tile-shadow: rgba(247, 37, 133, 0.35);
            --tile-hover-shadow: rgba(247, 37, 133, 0.55);
            --tile-text: #ffffff;
        }

        .menu-option.theme-ocean {
            --tile-bg: linear-gradient(135deg, #6EE7FF 0%, #4FC6FF 45%, #3A8BFF 100%);
            --tile-border: rgba(255, 255, 255, 0.7);
            --tile-shadow: rgba(74, 144, 226, 0.32);
            --tile-hover-shadow: rgba(74, 144, 226, 0.5);
            --tile-text: #ffffff;
        }

        .menu-option.theme-sunshine {
            --tile-bg: linear-gradient(135deg, #FFE17D 0%, #FFC94D 45%, #FF9A3C 100%);
            --tile-border: rgba(255, 255, 255, 0.8);
            --tile-shadow: rgba(255, 171, 64, 0.35);
            --tile-hover-shadow: rgba(255, 171, 64, 0.55);
            --tile-text: #5A2C15;
        }

        .menu-option.theme-lavender {
            --tile-bg: linear-gradient(135deg, #C7A0FF 0%, #A982FF 45%, #7C5CFF 100%);
            --tile-border: rgba(255, 255, 255, 0.75);
            --tile-shadow: rgba(124, 92, 255, 0.34);
            --tile-hover-shadow: rgba(124, 92, 255, 0.5);
            --tile-text: #ffffff;
        }

        .menu-option.theme-random {
            --tile-bg: linear-gradient(135deg, #FF6B9D 0%, #C44569 45%, #FFA07A 100%);
            --tile-border: rgba(255, 255, 255, 0.8);
            --tile-shadow: rgba(255, 107, 157, 0.38);
            --tile-hover-shadow: rgba(255, 107, 157, 0.6);
            --tile-text: #ffffff;
            animation: randomPulse 3s ease-in-out infinite;
        }

        @keyframes randomPulse {
            0%, 100% {
                box-shadow: 0 10px 22px rgba(255, 107, 157, 0.38);
            }
            50% {
                box-shadow: 0 12px 28px rgba(255, 107, 157, 0.5);
            }
        }

        .menu-option.theme-battle {
            --tile-bg: linear-gradient(135deg, #FF4500 0%, #DC143C 45%, #FF8C00 100%);
            --tile-border: rgba(255, 215, 0, 0.9);
            --tile-shadow: rgba(255, 69, 0, 0.45);
            --tile-hover-shadow: rgba(255, 69, 0, 0.7);
            --tile-text: #ffffff;
            animation: battleGlow 2.5s ease-in-out infinite;
        }

        @keyframes battleGlow {
            0%, 100% {
                box-shadow: 0 10px 22px rgba(255, 69, 0, 0.45), 0 0 15px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 12px 30px rgba(255, 69, 0, 0.65), 0 0 25px rgba(255, 215, 0, 0.5);
            }
        }

        .menu-option.theme-lightning {
            --tile-bg: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF6B00 100%);
            --tile-border: rgba(255, 215, 0, 0.9);
            --tile-shadow: rgba(255, 140, 0, 0.45);
            --tile-hover-shadow: rgba(255, 107, 0, 0.7);
            --tile-text: #ffffff;
            animation: lightningGlow 2.5s ease-in-out infinite;
        }

        @keyframes lightningGlow {
            0%, 100% {
                box-shadow: 0 10px 22px rgba(255, 140, 0, 0.45), 0 0 15px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 12px 30px rgba(255, 107, 0, 0.65), 0 0 25px rgba(255, 215, 0, 0.5);
            }
        }

        @keyframes quoteFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 24px rgba(76, 175, 80, 0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 32px rgba(76, 175, 80, 0.8);
            }
        }

        @keyframes highlightFlash {
            0%, 100% {
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            }
            50% {
                background: linear-gradient(135deg, #66BB6A 0%, #5cb85c 100%);
            }
        }

        /* Quiz Ready Notification Banner */
        .quiz-ready-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 500;
            animation: slideDown 0.4s ease;
            max-width: 90%;
        }

        .quiz-ready-banner strong {
            color: #FFF59D;
            font-weight: 700;
        }

        .inline-link-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            white-space: nowrap;
        }

        .inline-link-btn:hover {
            background: white;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pulse-attention {
            animation: pulseGlow 1.5s ease-in-out infinite !important;
        }

        .highlight-flash {
            animation: highlightFlash 1s ease 3 !important;
        }

        .quiz-ready-banner .close-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .quiz-ready-banner .close-btn:hover {
            opacity: 1;
        }

        /* Custom Range Slider Styling */
        #difficultySlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B9D 0%, #FFA07A 100%);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.5);
            border: 3px solid white;
            transition: all 0.3s ease;
        }

        #difficultySlider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.7);
        }

        #difficultySlider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B9D 0%, #FFA07A 100%);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.5);
            border: 3px solid white;
            transition: all 0.3s ease;
        }

        #difficultySlider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.7);
        }

        #difficultySlider:hover {
            opacity: 1 !important;
        }

        .menu-option.theme-sunshine .option-title,
        .menu-option.theme-sunshine .option-description,
        .menu-option.theme-sunshine .kid-tip,
        .menu-option.theme-sunshine .option-icon {
            color: #5A2C15;
            text-shadow: none;
        }

        .menu-option.theme-sunshine .kid-tip {
            background: rgba(255, 255, 255, 0.5);
            border-color: rgba(90, 44, 21, 0.2);
        }
        
        .option-icon {
            font-size: 2.8rem;
            margin-bottom: 0.65rem;
            opacity: 1;
            color: inherit;
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.18));
        }
        
        .option-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--tile-text);
            margin-bottom: 0.4rem;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.18);
        }
        
        .option-description {
            color: rgba(255, 255, 255, 0.92);
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.45;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.18);
        }
        
        .kid-tip {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.6rem;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.22);
            border-radius: 14px;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            animation: kidTipGlow 3s ease-in-out infinite;
        }
        
        @keyframes kidTipGlow {
            0%, 100% {
                background: rgba(255, 255, 255, 0.22);
                transform: scale(1);
            }
            50% {
                background: rgba(255, 255, 255, 0.32);
                transform: scale(1.05);
            }
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem 2rem 2rem 2rem;
            background: white;
        }
        
        .action-btn {
            width: 100%;
            padding: 1.2rem 2rem;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            text-align: center;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #FFB300, #FFD54F);
            color: #3b2b04;
            box-shadow: 0 6px 20px rgba(255, 179, 0, 0.4);
            border: 2px solid rgba(255, 215, 0, 0.5);
            font-weight: 700;
        }

        .action-btn.primary.ready-to-play {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.45);
            border: 2px solid rgba(46, 204, 113, 0.3);
        }
        
        /* Kid-Safe Content Badge */
        .kid-safe-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-top: 0.8rem;
            animation: safetyPulse 3s ease-in-out infinite;
        }
        
        .kid-safe-badge::before {
            content: '✓';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 900;
        }
        
        @keyframes safetyPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            }
            50% {
                box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5), 0 0 15px rgba(76, 175, 80, 0.2);
            }
        }
        
        .action-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            animation: magicalGlow 1s ease-in-out infinite;
        }

        .action-btn.primary.ready-to-play:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.6), 0 0 25px rgba(255, 255, 255, 0.35);
            animation: beeGlow 1s ease-in-out infinite;
        }
        
        .action-btn.primary:hover:not(:disabled)::before {
            width: 100px;
            height: 100px;
        }
        
        @keyframes magicalGlow {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(255, 105, 180, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 10px 30px rgba(255, 105, 180, 0.6), 0 0 25px rgba(255, 215, 0, 0.5);
            }
        }

        @keyframes beeHover {
            0%, 100% {
                transform: translateY(0px) rotate(-2deg);
            }
            50% {
                transform: translateY(-8px) rotate(2deg);
            }
        }

        @keyframes beeGlow {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(46, 204, 113, 0.6), 0 0 25px rgba(255, 255, 255, 0.35);
            }
            50% {
                box-shadow: 0 12px 35px rgba(46, 204, 113, 0.8), 0 0 30px rgba(255, 255, 255, 0.5);
            }
        }

        @keyframes battleGlow {
            0%, 100% { 
                transform: scale(1); 
                filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.6));
            }
            50% { 
                transform: scale(1.1); 
                filter: drop-shadow(0 8px 20px rgba(255, 215, 0, 0.9)) drop-shadow(0 4px 16px rgba(255, 165, 0, 0.7));
            }
        }
        
        .action-btn.primary:disabled {
            background: #7F8C8D;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
            pointer-events: none;
        }

        .action-btn.primary.waiting-to-play {
            background: linear-gradient(45deg, #95A5A6, #7F8C8D);
            color: #ECF0F1;
        }
        
        /* Mobile fix: ensure enabled button is fully interactive */
        .action-btn.primary:not(:disabled) {
            pointer-events: auto !important;
            opacity: 1 !important;
            cursor: pointer !important;
        }
        
        .action-btn.primary.ready-to-play:not(:disabled) {
            pointer-events: auto !important;
            opacity: 1 !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
        }
        
        .action-btn.secondary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 193, 7, 0.15));
            color: #B8860B;
            border: 2px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        }
        
        .action-btn.secondary:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.25));
            border-color: #FFD700;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        
        .action-btn.secondary:hover::before {
            width: 100px;
            height: 100px;
        }
        
        .action-btn.info {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(52, 152, 219, 0.12));
            color: #2980B9;
            border: 2px solid rgba(52, 152, 219, 0.3);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }
        
        .action-btn.info:hover {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498DB;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                margin: 0 auto;
                padding: 0 0.5rem;
            }
            
            .logo-section {
                padding: 1rem 1.5rem 1.5rem 1.5rem;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            #mascotBee3D {
                width: 140px;
                height: 140px;
                margin: 0 auto 1.2rem auto;
                transform: translateY(0);
                position: relative;
                left: 0;
                right: 0;
                /* Maintain avatar visibility on mobile */
                z-index: 15;
                overflow: visible;
            }
            
            .logo-section img {
                width: 150px;
            }
            
            .card-header {
                padding: 1.5rem;
            }
            
            .card-header h1 {
                font-size: 1.5rem;
            }
            
            .menu-container {
                padding: 1.5rem;
            }
            
            .menu-option {
                padding: 1.2rem;
                min-height: 90px;
                /* Ensure minimum touch target size for mobile */
                min-height: 44px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(255, 182, 193, 0.3);
            }
            
            .option-icon {
                font-size: 2rem;
            }
            
            /* Mobile button sizing */
            .action-btn {
                min-height: 44px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(255, 105, 180, 0.3);
            }
            
            input, textarea, select {
                font-size: 16px !important; /* Prevent zoom on focus in iOS */
            }
        }
        
        /* Mobile-specific fixes */
        @media (hover: none) and (pointer: coarse) {
            /* This targets touch devices only */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
            
            button, .menu-option, .action-btn {
                -webkit-tap-highlight-color: rgba(255, 182, 193, 0.3);
                cursor: pointer;
            }
            
            /* Prevent text selection on buttons */
            button, .action-btn, .menu-option {
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Smooth scrolling for mobile */
            html {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <!-- Content Filter Warning Modal (Similar to "Attention, spelling bee!" popup) -->
    <div id="contentFilterModal" class="modal-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    ">
        <div class="content-filter-popup" style="
            background: linear-gradient(135deg, #FFE4B5 0%, #FFF8DC 50%, #FFFFE0 100%);
            border: 5px solid #FFD700;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            padding: 30px;
            text-align: center;
            position: relative;
            animation: modalBounceIn 0.5s ease-out;
        ">
            <!-- Bee Guardian Icon -->
            <div style="font-size: 4rem; margin-bottom: 15px;">
                🛡️🐝
            </div>
            
            <!-- Warning Title -->
            <div style="
                color: #8B4513;
                font-size: 1.8rem;
                font-weight: bold;
                margin-bottom: 20px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            ">
                🐝 Hive Guardian Alert! 🐝
            </div>
            
            <!-- Warning Message Container -->
            <div id="contentFilterMessage" style="
                background: rgba(255, 255, 255, 0.8);
                border: 2px solid #FFA500;
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                color: #444;
                font-size: 1.1rem;
                line-height: 1.5;
                text-align: left;
            ">
                <!-- Dynamic content will be inserted here -->
            </div>
            
            <!-- Violation Count Display -->
            <div id="violationCountDisplay" style="
                background: linear-gradient(135deg, #FFB6C1 0%, #FFA07A 100%);
                border-radius: 15px;
                padding: 15px;
                margin: 20px 0;
                border: 2px solid #FF6347;
                display: none;
            ">
                <div style="font-weight: bold; color: #8B0000; margin-bottom: 5px;">
                    ⚠️ Warning Level: <span id="warningLevelText">Low</span>
                </div>
                <div style="color: #B22222;">
                    Inappropriate attempts in last 24 hours: <span id="violationCountText">0</span>
                </div>
            </div>
            
            <!-- Guardian Report Notice -->
            <div id="guardianReportNotice" style="
                background: linear-gradient(135deg, #FF6B6B 0%, #FF4757 100%);
                color: white;
                border-radius: 15px;
                padding: 20px;
                margin: 20px 0;
                border: 3px solid #DC143C;
                font-weight: bold;
                display: none;
            ">
                📧 <strong>Important:</strong> A report about these inappropriate attempts has been sent to your parent or guardian.
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="dismissContentFilterModal()" style="
                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 25px;
                    font-size: 1.1rem;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    transition: all 0.3s ease;
                ">
                    🐝 I Understand
                </button>
                
                <button onclick="showEducationalWords()" style="
                    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 25px;
                    font-size: 1.1rem;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    transition: all 0.3s ease;
                ">
                    📚 Show Good Words
                </button>
            </div>
        </div>
    </div>
    
    <!-- Content Filter Status Indicator (Subtle indicator on main menu) -->
    <div id="contentFilterStatusBadge" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        display: none;
    " onclick="showContentFilterStatus()">
        🛡️ <span id="statusBadgeText">Safe Hive</span>
    </div>

    <!-- Background Music Player -->
    <div id="musicControls" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 20px rgba(255, 165, 0, 0.4);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid rgba(255, 255, 255, 0.8);
    " onclick="toggleMusic()" title="Toggle Background Music">
        <div id="musicIcon" style="font-size: 1.8rem; display: flex; align-items: center; justify-content: center;">
            🎵
        </div>
    </div>
    
    <audio id="backgroundMusic" loop preload="auto" style="display: none;">
        <!-- We'll generate music programmatically using Web Audio API -->
    </audio>

    <!-- Magical background effects -->
    <!-- Honey Pot Loading Screen -->
    <div id="honeyLoader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #FFF5D7 0%, #FFE1F2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: 16px 12px;
        box-sizing: border-box;
        z-index: 10000;
        transition: opacity 0.5s ease, visibility 0.5s ease;
    ">
        <!-- Sticky voice status banner -->
        <div id="voiceReadyBanner" style="
            position: sticky;
            top: 8px;
            z-index: 10001;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(90, 44, 21, 0.15);
            border-radius: 999px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            color: #5A2C15;
            font-weight: 700;
            backdrop-filter: blur(6px);
            max-width: 90%;
            margin: 0 auto 10px;
            text-align: center;
        ">🎤 Voice input ready</div>
        <!-- Animated Bee -->
        <div style="
            font-size: 4rem;
            animation: loaderBeeFloat 2s ease-in-out infinite;
            margin-bottom: 1rem;
        ">🐝</div>
        
        <!-- Honey Pot -->
        <div style="
            position: relative;
            width: 260px;
            height: 230px;
            min-width: 240px;
            min-height: 210px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 25px 25px 50px 50px;
            border: 5px solid #8B4513;
            box-shadow: 0 15px 40px rgba(255, 165, 0, 0.5), inset 0 -30px 50px rgba(139, 69, 19, 0.3);
            overflow: hidden;
        ">
            <!-- Honey Fill Animation -->
            <div id="honeyFillLoader" style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 0%;
                background: linear-gradient(180deg, rgba(255, 223, 0, 0.9) 0%, rgba(255, 193, 7, 1) 100%);
                border-radius: 0 0 45px 45px;
                transition: height 0.3s ease-out;
                box-shadow: inset 0 10px 20px rgba(255, 255, 255, 0.4);
            ">
                <!-- Honey Shine -->
                <div style="
                    position: absolute;
                    top: 15px;
                    left: 25px;
                    width: 80px;
                    height: 40px;
                    background: rgba(255, 255, 255, 0.5);
                    border-radius: 50%;
                    filter: blur(15px);
                "></div>
            </div>
            
            <!-- Percentage Text -->
            <div id="loadingPercentage" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3.4rem;
                font-weight: 900;
                color: #8B4513;
                text-shadow: 3px 3px 6px rgba(255, 255, 255, 0.6);
                z-index: 10;
            ">0%</div>
            
            <!-- Pot Rim -->
            <div style="
                position: absolute;
                top: -10px;
                left: -5px;
                right: -5px;
                height: 25px;
                background: linear-gradient(135deg, #A0522D 0%, #8B4513 100%);
                border-radius: 25px 25px 0 0;
                border: 3px solid #654321;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            "></div>
        </div>
        
        <!-- Loading Text -->
        <div id="loadingText" style="
            margin-top: 1.25rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #5A2C15;
            text-align: center;
            animation: loadingTextPulse 1.5s ease-in-out infinite;
        ">
            Loading BeeSmart Spelling App! Please Wait.....
        </div>
        
        <!-- Loading Message -->
        <div id="loadingStatus" style="
            margin-top: 0.5rem;
            font-size: 1rem;
            color: #8B4513;
            font-weight: 600;
        ">
            🍯 Filling the honey pot...
        </div>
        
        <!-- System Checks Display -->
        <div id="systemChecks" style="
            margin-top: 0.75rem;
            width: clamp(360px, 94vw, 720px);
            max-width: 720px;
            max-height: 90vh;
            overflow-y: auto;
            background: #000;
            color: #00ff88;
            border-radius: 14px;
            border: 3px solid rgba(0, 255, 136, 0.45);
            padding: 1.5rem 1.25rem;
            box-shadow: 0 16px 40px rgba(0, 255, 136, 0.18);
            font-family: Consolas, "Liberation Mono", Menlo, monospace;
        ">
            <div style="
                font-size: 1.25rem;
                font-weight: 900;
                color: #00ff88;
                margin-bottom: 1rem;
                text-align: center;
                letter-spacing: 0.3px;
            ">🔍 System Checks</div>
            
            <div id="checksList" style="
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                font-size: 1.1rem;
                line-height: 1.5;
            ">
                <!-- Checks will be added dynamically -->
            </div>
        </div>
    </div>
    
    <style>
        @keyframes loaderBeeFloat {
            0%, 100% {
                transform: translateY(0px) rotate(-5deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        /* Keep System Checks moderately narrow but tall across displays */
        @media (min-width: 1024px) {
            #systemChecks { width: 720px !important; }
        }
        
        @keyframes loadingTextPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
    </style>
    
    <div class="magic-background"></div>
    <div class="fairy-container"></div>
    
    <!-- Main container -->
    <div class="main-container">
        <!-- Single unified card with logo and menu -->
        <div class="content-card">
            <!-- Logo at top of card -->
            <section class="logo-section">
                <!-- Unified Avatar Stage: All 5 elements together -->
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 18px;
                    padding: 10px;
                    padding-top: 30px;
                ">
                    <!-- 1. Welcome Header (swapped with name badge) -->
                    <div style="
                        background: linear-gradient(135deg, #FFE5B4 0%, #FFD700 100%);
                        border: 3px solid #FFA500;
                        border-radius: 20px;
                        padding: 12px 20px;
                        box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
                        margin-top: 18px;
                    ">
                        <div style="
                            font-size: 24px;
                            font-weight: bold;
                            color: #5A2C15;
                            text-align: center;
                            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
                        ">
                            🐝 <span id="welcomeMessage">Welcome, NewBee!</span>
                        </div>
                    </div>
                    
                    <!-- Mid stack: Avatar + Caption (centered between Welcome and Logo) -->
                    <div id="heroMidStack" style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 16px;
                        margin-top: auto;
                        margin-bottom: auto;
                    ">
                        <!-- 2. 3D Avatar Display -->
                        <div id="mascotBee3D" style="cursor: pointer;" onclick="playMascotShow()" title="Click me to see what I do!"></div>

                        <!-- Avatar System Status Badge (HIDDEN - kept for diagnostics only) -->
                        <div id="avatarSystemStatus" style="display: none !important;"></div>

                        <!-- Avatar Refresh Button (HIDDEN - kept for emergency fallback only) -->
                        <button id="avatarRefreshBtn" style="display: none !important;"></button>

                        <!-- 3. Interactive Caption -->
                        <div id="mascotCaption" style="
                            font-size: 14px;
                            color: #FF6B00;
                            font-weight: 600;
                            text-align: center;
                            animation: gentlePulse 2s ease-in-out infinite;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onclick="playMascotCaptionCombo()">
                            ✨ Click on me to see what I do! ✨
                        </div>
                    </div>
                    
                    <!-- 4. Avatar Name Badge (swapped with welcome) -->
                    <div id="avatarNameBadge" style="
                        background: linear-gradient(135deg, #FF8C42 0%, #FF6B35 100%);
                        border: 2px solid #FF5722;
                        border-radius: 15px;
                        padding: 8px 16px;
                        box-shadow: 0 3px 8px rgba(255, 87, 34, 0.3);
                        display: none;
                        margin-bottom: 28px;
                    ">
                        <div style="
                            font-size: 16px;
                            font-weight: 600;
                            color: white;
                            text-align: center;
                            font-family: 'Segoe UI', sans-serif;
                        ">
                            <span id="avatarNameDisplay"></span>
                        </div>
                    </div>
                    
                    <!-- 5. BeeSmart Logo -->
                    <img src="/static/BeeSmartTitle.png" alt="BeeSmart Logo" style="margin-top: 24px;" />
                </div>
                
                <!-- Website URL Badge -->
                <div style="margin-top: 12px; font-size: 16px; font-weight: 600; color: #FF6B00; font-family: 'Segoe UI', sans-serif; letter-spacing: 0.5px;">
                    🌐 <a href="https://beesmartspelling.app" target="_blank" rel="noopener noreferrer" style="color: #FF6B00; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#FFB347'" onmouseout="this.style.color='#FF6B00'">beesmartspelling.app</a>
                </div>
                
                <!-- Version badge below website -->
                <div id="versionBadge" style="margin-top: 8px; font-size: 11px; color: rgba(0,0,0,0.4); font-family: monospace; letter-spacing: 0.5px;">
                    v2.1
                </div>
                
                <!-- Kid-Safe Content Badge -->
                <div class="kid-safe-badge">
                    <span>Kid-Safe Content</span>
                </div>
                <div style="font-size: 0.75rem; color: rgba(0,0,0,0.5); margin: 0.5rem auto 0; text-align: center; max-width: 300px;">
                    All words are automatically filtered for age-appropriate content
                </div>
            </section>

            <!-- Bee Quote Banner -->
            <section class="menu-container" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <div id="beeQuoteBanner" style="
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                    border: 3px solid rgba(255, 215, 0, 0.8);
                    border-radius: 20px;
                    padding: 1.5rem 2rem;
                    text-align: center;
                    box-shadow: 0 8px 25px rgba(255, 140, 0, 0.3);
                    animation: quoteFadeIn 0.8s ease;
                ">
                    <div style="
                        font-size: 1.3rem;
                        font-weight: 800;
                        color: #5A2C15;
                        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
                        line-height: 1.4;
                    " id="beeQuoteText">
                        🐝 Loading bee wisdom...
                    </div>
                </div>
            </section>

            <!-- Authentication Section -->
            <section class="menu-container" style="padding-top: 0; margin-top: 0;">
                <div style="text-align: center;">
                    {% if current_user.is_authenticated %}
                        <!-- Logged In View -->
                        <div style="
                            background: linear-gradient(135deg, #FFE5B4 0%, #FFDAB9 100%);
                            border: 3px solid rgba(255, 215, 0, 0.5);
                            border-radius: 25px;
                            padding: 2rem 1.5rem;
                            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.2);
                            max-width: 800px;
                            margin: 0 auto;
                        ">
                            <!-- Welcome Message -->
                            <div style="
                                font-size: 1.6rem; 
                                font-weight: 700; 
                                color: #5A2C15; 
                                margin-bottom: 1.5rem;
                                text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
                            ">
                                🐝 Welcome back, {{ current_user.display_name or 'Friend' }}!
                            </div>
                            
                            <!-- Stats Row -->
                            <div style="
                                display: flex; 
                                gap: 2rem; 
                                justify-content: center; 
                                align-items: center; 
                                flex-wrap: wrap;
                                margin-bottom: 1.5rem;
                            ">
                                <div style="
                                    background: rgba(255, 255, 255, 0.6);
                                    padding: 0.8rem 1rem;
                                    border-radius: 15px;
                                    border: 2px solid rgba(255, 215, 0, 0.3);
                                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                                    min-width: 140px;
                                    text-align: center;
                                ">
                                    <div style="font-size: 0.85rem; color: #8B4513; font-weight: 600; margin-bottom: 0.3rem;">
                                        Grade
                                    </div>
                                    <div style="font-size: 1.8rem; font-weight: 700; color: #9C27B0; margin-bottom: 0.2rem;">
                                        {{ current_user.cumulative_gpa|gpa_to_grade }} 🎓
                                    </div>
                                    <div style="font-size: 0.75rem; color: #8B4513; font-weight: 500;">
                                        GPA: {{ "%.2f"|format(current_user.cumulative_gpa|float) if current_user.cumulative_gpa and current_user.cumulative_gpa != None else "0.00" }}
                                    </div>
                                </div>
                                
                                <div style="
                                    background: rgba(255, 255, 255, 0.6);
                                    padding: 0.8rem 1rem;
                                    border-radius: 15px;
                                    border: 2px solid rgba(255, 215, 0, 0.3);
                                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                                    min-width: 140px;
                                    text-align: center;
                                ">
                                    <div style="font-size: 0.85rem; color: #8B4513; font-weight: 600; margin-bottom: 0.3rem;">
                                        Points
                                    </div>
                                    <div style="font-size: 1.4rem; font-weight: 700; color: #FF8C00; margin-bottom: 0.2rem;">
                                        {{ current_user.total_lifetime_points|format_number or 0 }} 🏆
                                    </div>
                                    <div style="font-size: 0.75rem; color: #8B4513; font-weight: 500; opacity: 0;">
                                        &nbsp;
                                    </div>
                                </div>
                                
                                <div style="
                                    background: rgba(255, 255, 255, 0.6);
                                    padding: 0.8rem 1rem;
                                    border-radius: 15px;
                                    border: 2px solid rgba(255, 215, 0, 0.3);
                                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                                    min-width: 140px;
                                    text-align: center;
                                ">
                                    <div style="font-size: 0.85rem; color: #8B4513; font-weight: 600; margin-bottom: 0.3rem;">
                                        Quizzes
                                    </div>
                                    <div style="font-size: 1.4rem; font-weight: 700; color: #4CAF50; margin-bottom: 0.2rem;">
                                        {{ current_user.total_quizzes_completed|format_number or 0 }} 📝
                                    </div>
                                    <div style="font-size: 0.75rem; color: #8B4513; font-weight: 500; opacity: 0;">
                                        &nbsp;
                                    </div>
                                </div>
                                
                                <div style="
                                    background: rgba(255, 255, 255, 0.6);
                                    padding: 0.8rem 1rem;
                                    border-radius: 15px;
                                    border: 2px solid rgba(255, 215, 0, 0.3);
                                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                                    min-width: 140px;
                                    text-align: center;
                                ">
                                    <div style="font-size: 0.85rem; color: #8B4513; font-weight: 600; margin-bottom: 0.3rem;">
                                        Accuracy
                                    </div>
                                    <div style="font-size: 1.4rem; font-weight: 700; color: #2196F3; margin-bottom: 0.2rem;">
                                        {{ "%.1f"|format(current_user.average_accuracy|float) if current_user.average_accuracy and current_user.average_accuracy != None else "0.0" }}% 🎯
                                    </div>
                                    <div style="font-size: 0.75rem; color: #8B4513; font-weight: 500; opacity: 0;">
                                        &nbsp;
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Teacher/Parent Access Key Display -->
                            {% if current_user.role in ['teacher', 'parent', 'admin'] and current_user.teacher_key %}
                            <div style="
                                background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
                                border: 3px solid rgba(156, 39, 176, 0.3);
                                border-radius: 20px;
                                padding: 1.2rem;
                                margin: 1.5rem auto 0;
                                max-width: 600px;
                                box-shadow: 0 8px 20px rgba(156, 39, 176, 0.3);
                            ">
                                <div style="font-size: 0.9rem; color: #FFF; font-weight: 600; margin-bottom: 0.5rem; opacity: 0.9;">
                                    🔑 Your {{ current_user.role|title }} Access Key
                                </div>
                                <div style="font-size: 1.6rem; font-weight: 800; color: #FFF; margin-bottom: 0.5rem; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-family: monospace;">
                                    {{ current_user.teacher_key or 'Not Available' }}
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.85);">
                                    Share this key with students/children to link their accounts
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem;">
                                <a href="{% if current_user.role == 'admin' %}/admin/dashboard{% else %}/auth/dashboard{% endif %}" style="
                                    padding: 0.8rem 2rem;
                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                    color: white;
                                    border-radius: 15px;
                                    text-decoration: none;
                                    font-weight: 700;
                                    font-size: 1rem;
                                    box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
                                    transition: all 0.3s ease;
                                    display: inline-block;
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(76, 175, 80, 0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 15px rgba(76, 175, 80, 0.3)'">
                                    📊 Dashboard
                                </a>
                                <a href="/auth/logout" style="
                                    padding: 0.8rem 2rem;
                                    background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%);
                                    color: white;
                                    border-radius: 15px;
                                    text-decoration: none;
                                    font-weight: 700;
                                    font-size: 1rem;
                                    box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
                                    transition: all 0.3s ease;
                                    display: inline-block;
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(255, 107, 107, 0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 15px rgba(255, 107, 107, 0.3)'">
                                    🚪 Sign Out
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <!-- Guest View -->
                        <div style="
                            background: linear-gradient(135deg, #FFF9E6 0%, #FFF0CC 100%);
                            border: 3px solid rgba(255, 215, 0, 0.3);
                            border-radius: 20px;
                            padding: 1.5rem;
                            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.1);
                        ">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #5A2C15; margin-bottom: 1rem;">
                                🌟 Save Your Progress!
                            </div>
                            <div style="font-size: 0.95rem; color: #8B4513; margin-bottom: 1.2rem; line-height: 1.5;">
                                Sign in to track your points, view your history, and unlock achievements! 🏆
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <a href="/auth/login" style="
                                    padding: 0.8rem 2rem;
                                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                                    color: #5A2C15;
                                    border-radius: 15px;
                                    text-decoration: none;
                                    font-weight: 700;
                                    font-size: 1.05rem;
                                    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
                                    transition: all 0.3s ease;
                                    display: inline-block;
                                    border: 3px solid rgba(255, 215, 0, 0.6);
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 215, 0, 0.5)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)'">
                                    🔑 Sign In
                                </a>
                                <a href="/auth/register" style="
                                    padding: 0.8rem 2rem;
                                    background: linear-gradient(135deg, #87CEEB 0%, #4FC3F7 100%);
                                    color: white;
                                    border-radius: 15px;
                                    text-decoration: none;
                                    font-weight: 700;
                                    font-size: 1.05rem;
                                    box-shadow: 0 6px 20px rgba(135, 206, 235, 0.4);
                                    transition: all 0.3s ease;
                                    display: inline-block;
                                    border: 3px solid rgba(135, 206, 235, 0.6);
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(135, 206, 235, 0.5)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(135, 206, 235, 0.4)'">
                                    ✨ Register
                                </a>
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.85rem; color: #999;">
                                Or continue as guest (progress won't be saved)
                            </div>
                            
                            <!-- Instructional Information -->
                            <div style="
                                margin-top: 1.25rem;
                                padding: 1rem;
                                background: rgba(255, 249, 230, 0.6);
                                border: 2px dashed #FFD700;
                                border-radius: 10px;
                                font-size: 0.85rem;
                                color: #5A2C15;
                                line-height: 1.5;
                                text-align: left;
                            ">
                                <div style="font-weight: 700; margin-bottom: 0.5rem; color: #FF8C00; text-align: center;">
                                    💡 Quick Guide
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>🔑 Sign In:</strong> If you have an account, sign in to access your progress, points, and badges!
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>✨ Register:</strong> Create a free account to track your spelling journey and compete with friends!
                                </div>
                                <div>
                                    <strong>👋 Guest:</strong> Try the app without registering - perfect for your first visit! Your progress won't be saved.
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </section>

            <!-- Student Name Input -->
            <section class="menu-container" style="padding-top: 0;">
                <div class="menu-option" style="
                    background: linear-gradient(135deg, #FFF5D7 0%, #FFE1F2 100%);
                    border-color: rgba(255, 182, 193, 0.4);
                    cursor: default;
                    min-height: auto;
                ">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #5A2C15; margin-bottom: 0.5rem;">
                        👋 What's your name, spelling champion?
                    </div>
                    <input 
                        type="text" 
                        id="studentName" 
                        placeholder="Enter your name here..."
                        style="
                            width: 100%;
                            max-width: 400px;
                            padding: 1rem 1.5rem;
                            font-size: 1.1rem;
                            border: 3px solid #FFB6C1;
                            border-radius: 15px;
                            background: white;
                            color: #5A2C15;
                            font-weight: 600;
                            text-align: center;
                            box-shadow: inset 0 2px 8px rgba(210, 105, 30, 0.15);
                            transition: all 0.3s ease;
                        "
                        onkeyup="saveStudentName()"
                        onfocus="this.style.borderColor='#FF69B4'; this.style.boxShadow='0 0 0 4px rgba(255, 182, 193, 0.3), inset 0 2px 8px rgba(210, 105, 30, 0.15)'"
                        onblur="this.style.borderColor='#FFB6C1'; this.style.boxShadow='inset 0 2px 8px rgba(210, 105, 30, 0.15)'"
                    />
                    <div style="margin-top: 0.8rem; font-size: 0.95rem; color: #8B4513;">
                        🐝 The announcer will use your name during the quiz!
                    </div>
                </div>
            </section>

            <!-- Menu options -->
            <section class="menu-container">
                <!-- Upload Text File -->
                <div class="menu-option theme-berry" onclick="selectOption('text', this)" title="📄 Upload your word list from a text file, CSV, or paste words directly!">
                    <div class="option-icon">📄</div>
                    <div class="option-title">Upload Text File</div>
                    <div class="option-description">Plain text, CSV, comma/space separated, Word docs</div>
                    <div class="kid-tip">📝 Perfect for spelling lists from school!</div>
                </div>

                <!-- Type Words Manually -->
                <div class="menu-option" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-color: rgba(129, 199, 132, 0.5);" onclick="selectOption('manual', this)" title="✍️ Type or paste your spelling words directly!">
                    <div class="option-icon">✍️</div>
                    <div class="option-title">Type Words Manually</div>
                    <div class="option-description">Type or paste your word list</div>
                    <div class="kid-tip">⌨️ Quick and easy! Just type your words!</div>
                </div>

                <!-- Upload Image -->
                <div class="menu-option theme-ocean" onclick="selectOption('image', this)" title="📷 Take a photo of a book page or worksheet and we'll find the words for you!">
                    <div class="option-icon">📷</div>
                    <div class="option-title">Upload Image</div>
                    <div class="option-description">Extract words from photos</div>
                    <div class="kid-tip">📚 Magic word finder from pictures!</div>
                </div>

                <!-- Dictionary Search -->
                <div class="menu-option theme-sunshine" onclick="selectOption('dictionary', this)" title="🔍 Look up any word to learn its meaning and add it to your spelling practice!">
                    <div class="option-icon">🔍</div>
                    <div class="option-title">Dictionary Search</div>
                    <div class="option-description">Look up word definitions</div>
                    <div class="kid-tip">📖 Discover new words to learn!</div>
                </div>

                <!-- Saved Word Lists -->
                <div class="menu-option theme-lavender" onclick="selectOption('saved', this)" title="📚 Access your previously saved spelling lists and continue practicing!">
                    <span id="savedListsBadge" class="option-badge" style="display:none;">0</span>
                    <div class="option-icon">📚</div>
                    <div class="option-title">Saved Word Lists</div>
                    <div class="option-description">Use previously uploaded lists</div>
                    <div class="kid-tip">⭐ Your favorite word collections!</div>
                </div>

                <!-- Random Play -->
                <div class="menu-option theme-random" onclick="selectOption('random', this)" title="🎲 Let the app pick random words for you based on difficulty!">
                    <div class="option-icon">🎲</div>
                    <div class="option-title">Random Play</div>
                    <div class="option-description">AI picks 10 words by difficulty level</div>
                    <div class="kid-tip">🎯 Challenge yourself with surprise words!</div>
                </div>

                <!-- Battle of the Bees -->
                <div class="menu-option theme-battle" onclick="selectOption('battle', this)" title="⚔️ Compete with classmates in an epic spelling battle!">
                    <div class="option-icon">⚔️</div>
                    <div class="option-title">Battle of the Bees</div>
                    <div class="option-description">Compete with friends & classmates!</div>
                    <div class="kid-tip">🏆 Who will be the champion?</div>
                </div>

                <!-- Speed Round Challenge -->
                <div class="menu-option theme-lightning" onclick="selectOption('speed', this)" title="⚡ Race against time in a fast-paced spelling challenge!">
                    <div class="option-icon">⚡</div>
                    <div class="option-title">Speed Round Challenge</div>
                    <div class="option-description">Race against time! Earn bonus points!</div>
                    <div class="kid-tip">⏱️ How fast can you spell?</div>
                </div>
            </section>

            <!-- Action buttons -->
            <section class="action-buttons">
                <button type="button" class="action-btn secondary" onclick="exportWordList()" title="💾 Save your word list with definitions">
                    💾 Export List
                </button>
                <button type="button" class="action-btn secondary" onclick="importWordList()" title="📥 Load a previously saved CSV word list">
                    📥 Import CSV File
                </button>
                <button type="button" class="action-btn secondary" onclick="clearAll()" title="🗑️ Start fresh with a new word list">
                    🧹 Start Fresh
                </button>
                
                <!-- Help & Documentation Section -->
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 10px 0;">
                    <a href="/help" class="action-btn info" title="❓ Quick help and tips" style="text-decoration: none; display: inline-block; font-size: 0.9rem; padding: 10px 16px;">
                        ❓ Quick Help
                    </a>
                    <a href="/guide" class="action-btn info" title="📖 Complete user guide with detailed instructions" style="text-decoration: none; display: inline-block; font-size: 0.9rem; padding: 10px 16px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); border-color: rgba(33, 150, 243, 0.3);">
                        📖 User Guide
                    </a>
                    <a href="/admin-guide" class="action-btn info" title="🔧 Technical administrator guide" style="text-decoration: none; display: inline-block; font-size: 0.9rem; padding: 10px 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); border-color: rgba(156, 39, 176, 0.3);">
                        🔧 Admin Guide
                    </a>
                </div>
                
                <button type="button" class="action-btn primary waiting-to-play" id="startQuizBtn" onclick="startQuiz()" disabled title="🚀 Begin your spelling adventure!">
                    🐝 Let's Get Buzzing Spelling Some Words!
                </button>
            </section>
            
            <!-- Hidden file input for import -->
            <input type="file" id="importFileInput" accept=".json,.csv" style="display: none;" onchange="handleImportFile(this)">
        </div>
    </div>

    <script>
        // Rotating Bee Quotes System
        const beeQuotes = [
            "🐝 Bee Cool - Stay Calm and Spell On!",
            "🐝 Bee Different - Embrace Your Unique Spelling Style!",
            "🐝 To Bee or Not to Bee - That is the Question!",
            "🐝 Bee-lieve in Yourself - You Can Do It!",
            "🐝 Bee Amazing - Every Word is a Step Forward!",
            "🐝 Bee Happy - Learning is Fun!",
            "🐝 Bee Strong - Mistakes Help You Grow!",
            "🐝 Bee Brave - Try New Words!",
            "🐝 Bee Smart - Practice Makes Perfect!",
            "🐝 Bee Kind - To Yourself and Others!",
            "🐝 Bee Patient - Good Things Take Time!",
            "🐝 Bee Curious - Ask Questions!",
            "🐝 Bee Positive - You're Getting Better Every Day!",
            "🐝 Bee Awesome - Because You Already Are!",
            "🐝 Bee Yourself - That's Your Superpower!",
            "🐝 Don't Worry, Bee Happy!",
            "🐝 The Bee-st is Yet to Come!",
            "🐝 You're Un-bee-lievable!",
            "🐝 Bee the Change You Want to Spell!",
            "🐝 Spell it Like You Mean It!",
            "🐝 Every Expert Speller Was Once a Bee-ginner!",
            "🐝 Bee Proud of Every Word You Learn!",
            "🐝 Keep Calm and Buzz On!",
            "🐝 Bee-lieve in the Power of Practice!",
            "🐝 You're Creating Your Own Buzz!",
            "🐝 Bee Confident - You've Got This!",
            "🐝 Mind Your Bees-ness and Keep Spelling!",
            "🐝 It's a Beautiful Day to Bee Learning!",
            "🐝 Bee Legendary - One Word at a Time!",
            "🐝 You're the Bee's Knees!",
            "🐝 You Can Bee Whatever You Want to Bee!",
            "🐝 Bee Fantastic!"
        ];

        function showRandomBeeQuote() {
            const quoteElement = document.getElementById('beeQuoteText');
            if (!quoteElement) return;
            
            const randomQuote = beeQuotes[Math.floor(Math.random() * beeQuotes.length)];
            quoteElement.textContent = randomQuote;
        }

        // Content Filter Modal System (Similar to "Attention, spelling bee!" popup)
        let currentFilterStatus = null;
        
        function checkContentFilterStatus() {
            // Use async IIFE to avoid syntax errors with await outside async context
            (async () => {
                try {
                    const response = await fetch('/api/content-filter-status');
                    const data = await response.json();
                    
                    if (data.ok && data.status) {
                        currentFilterStatus = data.status;
                        updateContentFilterBadge(data.status, data.messages);
                    }
                } catch (error) {
                    console.log('Content filter status check failed:', error);
                    // Fail silently - don't disrupt user experience
                }
            })();
        }

        function updateContentFilterBadge(status, messages) {
            const badge = document.getElementById('contentFilterStatusBadge');
            const badgeText = document.getElementById('statusBadgeText');
            
            if (!badge || !badgeText) return;
            
            // Update badge based on warning level
            let backgroundColor, text;
            switch (status.warning_level) {
                case 'yellow':
                    backgroundColor = 'linear-gradient(135deg, #FFA500 0%, #FF8C00 100%)';
                    text = `⚠️ Warning (${status.violation_count_24h})`;
                    badge.style.display = 'block';
                    break;
                case 'red':
                    backgroundColor = 'linear-gradient(135deg, #FF4444 0%, #CC0000 100%)';
                    text = `🚨 Alert (${status.violation_count_24h})`;
                    badge.style.display = 'block';
                    break;
                default: // green
                    backgroundColor = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    text = '🛡️ Safe Hive';
                    // Only show green badge briefly for first-time users
                    if (!localStorage.getItem('contentFilterSeen')) {
                        badge.style.display = 'block';
                        localStorage.setItem('contentFilterSeen', 'true');
                        setTimeout(() => {
                            badge.style.display = 'none';
                        }, 5000);
                    } else {
                        badge.style.display = 'none';
                    }
            }
            
            badge.style.background = backgroundColor;
            badgeText.textContent = text;
        }

        function showContentFilterStatus() {
            // Show current status when badge is clicked
            if (currentFilterStatus) {
                showContentFilterModal('Status Check', 
                    `🛡️ Current hive safety status:\n\n• Warning Level: ${currentFilterStatus.warning_level.toUpperCase()}\n• Violations (24h): ${currentFilterStatus.violation_count_24h}\n• Session ID: ${currentFilterStatus.session_id}\n\n${currentFilterStatus.guardian_notification_triggered ? '📧 Guardian has been notified of repeated violations.' : '✅ No guardian notification needed.'}`,
                    false, currentFilterStatus.violation_count_24h, currentFilterStatus.guardian_notification_triggered
                );
            }
        }

        function showViolationWarning(violationMessage) {
            // Parse the violation message to show in modal format
            const lines = violationMessage.split('\n').filter(line => line.trim());
            const title = lines[0] || '🐝 Hive Guardian Alert!';
            const content = lines.slice(1).join('\n') || violationMessage;
            
            // Refresh status and show modal
            checkContentFilterStatus().then(() => {
                showContentFilterModal(title, content, true, 
                    currentFilterStatus?.violation_count_24h || 1, 
                    currentFilterStatus?.guardian_notification_triggered || false
                );
            });
        }

        function showContentFilterModal(title, message, isViolation = false, violationCount = 0, guardianNotified = false) {
            const modal = document.getElementById('contentFilterModal');
            const messageDiv = document.getElementById('contentFilterMessage');
            const violationDisplay = document.getElementById('violationCountDisplay');
            const guardianNotice = document.getElementById('guardianReportNotice');
            const warningLevelText = document.getElementById('warningLevelText');
            const violationCountText = document.getElementById('violationCountText');
            
            if (!modal || !messageDiv) return;
            
            // Set the message content
            messageDiv.innerHTML = `
                <div style="font-weight: bold; color: #8B4513; margin-bottom: 10px;">${title}</div>
                <div style="white-space: pre-wrap; color: #444;">${message}</div>
            `;
            
            // Show violation count if this is a violation
            if (isViolation && violationCount > 0) {
                violationDisplay.style.display = 'block';
                violationCountText.textContent = violationCount;
                
                // Set warning level text and color
                let level, color;
                if (violationCount >= 3) {
                    level = 'HIGH';
                    color = '#8B0000';
                } else if (violationCount >= 2) {
                    level = 'MEDIUM';
                    color = '#FF4500';
                } else {
                    level = 'LOW';
                    color = '#DAA520';
                }
                warningLevelText.textContent = level;
                warningLevelText.style.color = color;
            } else {
                violationDisplay.style.display = 'none';
            }
            
            // Show guardian notice if applicable
            guardianNotice.style.display = guardianNotified ? 'block' : 'none';
            
            // Show the modal
            modal.style.display = 'flex';
            
            // Add escape key listener
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    dismissContentFilterModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        function dismissContentFilterModal() {
            const modal = document.getElementById('contentFilterModal');
            if (modal) {
                modal.style.display = 'none';
                
                // Refresh status to update badge
                checkContentFilterStatus();
            }
        }

        function showEducationalWords() {
            // Show examples of good educational words
            const educationalWords = [
                '📚 Subject Words: mathematics, science, history, geography, literature',
                '🌍 Nature Words: butterfly, mountain, ocean, forest, sunshine',
                '🎨 Creative Words: imagination, creativity, adventure, discovery',
                '💭 Feeling Words: happiness, curiosity, excitement, wonder',
                '🏠 Family Words: friendship, kindness, respect, responsibility',
                '⭐ Achievement Words: success, progress, learning, growth, achievement'
            ];
            
            const content = `Here are some wonderful word categories for spelling practice:\n\n${educationalWords.join('\n\n')}\n\n✨ These words help you learn and grow your vocabulary in positive ways!`;
            
            showContentFilterModal('📚 Great Words for Spelling!', content, false, 0, false);
        }

        // Initialize page components on load
        function initializePage() {
            showRandomBeeQuote();
            // Temporarily disable content filter check to troubleshoot loading issue
            // checkContentFilterStatus();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // Cache buster: 2025-10-14-v3 (force refresh)
        (function(){
            const V='v2.1-'+Date.now();
            console.log('BeeSmart App JavaScript loaded -', V);
            // Update version badge below logo instead of top corner
            const versionBadge = document.getElementById('versionBadge');
            if (versionBadge) {
                versionBadge.textContent = 'v2.1 (build: ' + Date.now().toString().slice(-6) + ')';
            }
            // Install fetch override to detect any legacy /upload usage
            if(!window.__uploadPatched){
                window.__uploadPatched=true;
                const ofetch=window.fetch.bind(window);
                window.fetch=function(resource, init){
                    let url=typeof resource==='string'?resource:(resource && resource.url)||'';
                    if(/\/upload(?![a-z])/i.test(url) && !/\/api\/upload/.test(url)){
                        console.warn('[PATCH] Rewriting legacy /upload -> /api/upload', url);
                        url=url.replace('/upload','/api/upload');
                        if(typeof resource==='string'){ resource=url; }
                        else { resource=new Request(url, resource); }
                    }
                    return ofetch(resource, init);
                }
            }
        })();

        // Saved Lists count badge helpers
        async function refreshSavedListsBadge(){
            try {
                const res = await fetch('/api/saved-lists');
                const data = await res.json();
                const badge = document.getElementById('savedListsBadge');
                if (!badge) return;
                if (data && data.ok && Array.isArray(data.lists)){
                    const count = data.lists.length;
                    if (count > 0){
                        badge.textContent = count > 99 ? '99+' : String(count);
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            } catch(e){
                const badge = document.getElementById('savedListsBadge');
                if (badge) badge.style.display = 'none';
            }
        }
        
        let currentSelection = null;
        
        function selectOption(type, element) {
            console.log('selectOption called with type:', type);
            
            // Play magical sound
            if (window.magicalEffects) {
                window.magicalEffects.playMagicalSound(880, 0.2, 'sine');
            }
            
            // Remove active from all options
            document.querySelectorAll('.menu-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Add active to clicked option
            if (element) {
                element.classList.add('active');
            }
            currentSelection = type;
            
            // Show upload interface based on selection
            switch(type) {
                case 'manual':
                    showManualWordEntry();
                    break;
                case 'text':
                    showTextUploadInterface();
                    break;
                case 'image':
                    showImageUploadInterface();
                    break;
                case 'dictionary':
                    showDictionaryInterface();
                    break;
                case 'saved':
                    showSavedListsInterface();
                    break;
                case 'random':
                    showRandomPlayInterface();
                    break;
                case 'battle':
                    showBattleInterface();
                    break;
                case 'speed':
                    showSpeedRoundInterface();
                    break;
            }
        }
        
        function saveStudentName() {
            const nameInput = document.getElementById('studentName');
            const name = nameInput.value.trim();
            
            // Save to localStorage
            if (name) {
                localStorage.setItem('studentName', name);
                console.log('📝 Student name saved:', name);
            } else {
                localStorage.removeItem('studentName');
            }
        }
        
        function showManualWordEntry() {
            // First check if there are existing words
            fetch('/api/wordbank')
                .then(response => response.json())
                .then(data => {
                    const existingWordCount = data.words ? data.words.length : 0;
                    
                    if (existingWordCount > 0) {
                        // Show kid-friendly confirmation
                        showBeeConfirm({
                            title: '🐝 Attention, spelling bee! 🐝',
                            message: 
                                `You already have ${existingWordCount} word(s) in your collection!\n\n` +
                                '✍️ If you type new words, they will replace your current list! 📝\n\n' +
                                '❓ What would you like to do?\n' +
                                '• Type new words (replaces current list)?\n' +
                                '• Or stick with your current words?\n\n' +
                                "🍯 It's your hive, you decide!",
                            confirmText: 'Type New Words',
                            cancelText: 'Keep Current Words'
                        }).then(confirmed => {
                            if (confirmed) {
                                // User wants to replace, show the prompt
                                showManualWordPrompt();
                            } else {
                                showNotification('✅ Keeping your current words safe! 🐝💛', 'info');
                            }
                        });
                    } else {
                        // No existing words, show prompt directly
                        showManualWordPrompt();
                    }
                })
                .catch(error => {
                    console.error('Error checking wordbank:', error);
                    // If error checking, show prompt anyway
                    showManualWordPrompt();
                });
        }
        
        function showManualWordPrompt() {
            showBeePrompt({
                title: '✍️ Type Your Spelling Words',
                message: 
                    '✏️ Type or paste your words here!\n\n' +
                    '📝 One word per line, or separate with commas/spaces.\n\n' +
                    'Example:\n' +
                    'cat, dog, elephant\n' +
                    'or\n' +
                    'cat\n' +
                    'dog\n' +
                    'elephant',
                placeholder: 'Type or paste your words here...',
                multiline: true
            }).then(wordsText => {
                if (wordsText && wordsText.trim()) {
                    processManualWords(wordsText.trim());
                }
            });
        }
        
        function processManualWords(text) {
            showLoadingMessage('🐝 Processing your words...');
            
            // Parse words from text (support newlines, commas, spaces)
            let words = text
                .replace(/[,;]/g, '\n')  // Replace commas/semicolons with newlines
                .split(/[\n\s]+/)         // Split on newlines and spaces
                .map(w => w.trim())       // Trim whitespace
                .filter(w => w.length > 0) // Remove empty strings
                .filter(w => /^[a-zA-Z]+$/.test(w)); // Only allow letters
            
            if (words.length === 0) {
                hideLoadingMessage();
                showErrorMessage('No valid words found! Please enter words using only letters.');
                return;
            }
            
            console.log('📝 Manual words parsed:', words);
            
            // Send to backend
            fetch('/api/upload-manual-words', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin',  // Ensure session cookie is sent
                body: JSON.stringify({ words: words })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingMessage();
                if (data.ok) {
                    const messages = [
                        `Buzz-tastic! ${data.count} word${data.count > 1 ? 's' : ''} added to your hive! 🐝`,
                        `Sweet! ${data.count} word${data.count > 1 ? 's are' : ' is'} ready to spell! 🍯`,
                        `Amazing! ${data.count} new word${data.count > 1 ? 's' : ''} collected! ✨`
                    ];
                    const message = messages[Math.floor(Math.random() * messages.length)];
                    showSuccessMessage(message);
                    
                    // Enable Start Quiz button IMMEDIATELY (mobile fix)
                    if (data.count > 0) {
                        const btn = document.getElementById('startQuizBtn');
                        btn.disabled = false;
                        btn.removeAttribute('disabled');
                        btn.innerHTML = `🚀 Start Quiz (${data.count} words)`;
                        btn.classList.add('ready-to-play');
                        btn.classList.remove('waiting-to-play');
                        
                        // Force style update for mobile
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                        
                        console.log('✅ Quiz button enabled after manual entry:', {
                            disabled: btn.disabled,
                            hasDisabledAttr: btn.hasAttribute('disabled'),
                            classes: btn.className,
                            wordCount: data.count
                        });
                        
                        // Force immediate visual update
                        btn.offsetHeight; // Trigger reflow
                        
                        // Show quiz-ready notification
                        showQuizReadyNotification(data.count);
                    }
                    
                    // DON'T call updateWordCount() - causes race condition and re-disables button
                    // Button already enabled above with correct count from upload response
                    console.log('✅ Manual entry complete - quiz button enabled with', data.count, 'words');
                } else {
                    // Check if this is a content violation warning
                    if (data.violation_warning && data.error) {
                        // Show violation in modal popup (like "Attention, spelling bee!")
                        showViolationWarning(data.error);
                    } else {
                        showErrorMessage(data.error || "Oops! Something went wrong. Let's try again!");
                    }
                }
            })
            .catch(error => {
                hideLoadingMessage();
                console.error('Manual word upload error:', error);
                showErrorMessage('Hmm, something went wrong. Please try again! 🤔');
            });
        }
        
        function showTextUploadInterface() {
            // Create file input for text files
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt,.csv,.doc,.docx,text/*';
            fileInput.multiple = false;
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadTextFile(file);
                }
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        function showImageUploadInterface() {
            // Create file input for images
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = false;
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadImageFile(file);
                }
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        function showDictionaryInterface() {
            // Use kid-friendly prompt for dictionary search
            showBeePrompt({
                title: '🔍 Dictionary Search',
                message: 'Enter a word to look up in the dictionary:',
                placeholder: 'Type a word here...',
                expectedValue: '', // No validation, accept any input
                caseSensitive: false
            }).then(searchTerm => {
                if (searchTerm && searchTerm.trim()) {
                    searchDictionary(searchTerm.trim());
                }
            });
        }
        
        function showSavedListsInterface() {
            // Build Saved Lists modal with Save Current + List of saved
            let modal = document.getElementById('savedListsModal');
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = 'savedListsModal';
            modal.style.cssText = `
                position: fixed; inset: 0; z-index: 10040;
                background: rgba(255, 240, 245, 0.9);
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.25s ease;
            `;
            modal.innerHTML = `
                <div style="
                    width: 92%; max-width: 720px; background: linear-gradient(135deg, #FFF0F6 0%, #FFFAE3 100%);
                    border-radius: 24px; padding: 1.5rem; box-shadow: 0 18px 40px rgba(255, 182, 193, 0.45);
                    border: 3px solid rgba(255, 107, 157, 0.4); position: relative; animation: slideUp 0.25s ease;
                ">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 1rem;">
                        <h2 style="margin:0; color:#FF6B9D; font-weight:800;">📚 Saved Word Lists</h2>
                        <button id="savedCloseBtn" style="background: transparent; border:none; font-size:1.5rem; cursor:pointer;">×</button>
                    </div>

                    <div style="
                        display:flex; gap:1rem; flex-wrap:wrap; align-items:stretch;
                    ">
                        <div style="flex:1 1 260px; background: rgba(255,255,255,0.75); border:2px solid rgba(255,107,157,0.3); border-radius:16px; padding:1rem;">
                            <h3 style="margin-top:0; color:#8B4513;">Save Current List</h3>
                            <label style="display:block; font-weight:700; color:#FF4500; margin-top:0.25rem;">List Name</label>
                            <input id="saveListName" placeholder="e.g., Week 5 - Silent E" style="width:100%; padding:0.6rem; border-radius:10px; border:2px solid rgba(255,140,0,0.35);" />
                            <label style="display:block; font-weight:700; color:#FF4500; margin-top:0.75rem;">Description (optional)</label>
                            <textarea id="saveListDesc" rows="3" placeholder="Short description..." style="width:100%; padding:0.6rem; border-radius:10px; border:2px solid rgba(255,140,0,0.35);"></textarea>
                            <div style="display:flex; gap:0.75rem; margin-top:1rem; flex-wrap:wrap;">
                                <button id="saveCurrentBtn" class="action-btn primary" style="min-width:180px;">💾 Save Current</button>
                                <button id="refreshSavedBtn" class="action-btn secondary" style="min-width:160px;">↻ Refresh</button>
                            </div>
                            <div id="saveStatus" style="margin-top:0.75rem; color:#5A2C15; font-weight:600;"></div>
                        </div>

                        <div style="flex:2 1 340px; background: rgba(255,255,255,0.75); border:2px solid rgba(255,107,157,0.3); border-radius:16px; padding:1rem; min-height:220px;">
                            <h3 style="margin-top:0; color:#8B4513;">Your Saved Lists</h3>
                            <div id="savedListsContainer" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);

            document.getElementById('savedCloseBtn').onclick = () => modal.remove();

            const statusEl = document.getElementById('saveStatus');
            const container = document.getElementById('savedListsContainer');

            function renderLists(lists){
                container.innerHTML = '';
                if (!lists || lists.length === 0){
                    container.innerHTML = '<div style="opacity:0.8;">No saved lists yet. Save your current list on the left!</div>';
                    return;
                }
                lists.forEach(l => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:0.5rem; border:2px dashed rgba(255,140,0,0.3); padding:0.6rem 0.75rem; border-radius:12px; background: rgba(255,255,255,0.65)';
                    row.innerHTML = `
                        <div>
                            <div style="font-weight:800; color:#5A2C15;">${l.name} <span style="opacity:0.7; font-weight:600;">(${l.word_count} words)</span></div>
                            <div style="opacity:0.8; font-size:0.9rem;">${l.description || ''}</div>
                        </div>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <button class="action-btn primary" style="min-width:140px; padding:0.6rem 0.9rem;" data-id="${l.id}" data-uuid="${l.uuid}">Use in Quiz</button>
                            <button class="action-btn secondary" style="min-width:110px; padding:0.6rem 0.9rem;" data-del="${l.id}">Delete</button>
                        </div>`;
                    container.appendChild(row);
                });
                // Wire load buttons
                container.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        try {
                            const res = await fetch('/api/saved-lists/load', {
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ id })
                            });
                            const data = await res.json();
                            if (data.ok){
                                showSuccessMessage('Loaded "' + data.loaded.name + '". Starting quiz…');
                                window.location.href = '/quiz';
                            } else {
                                showErrorMessage(data.error || 'Failed to load list');
                            }
                        } catch(e){ showErrorMessage('Failed to load list'); }
                    });
                });
                // Wire delete buttons (iOS-compatible - no async/await)
                container.querySelectorAll('button[data-del]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-del');
                        showBeeConfirm({ 
                            title:'Delete List?', 
                            message:'This will remove the saved list from your account.', 
                            confirmText:'Delete', 
                            cancelText:'Cancel' 
                        }).then(confirmed => {
                            if (!confirmed) return;
                            fetch('/api/saved-lists/delete', {
                                method: 'POST', 
                                headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ id })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.ok) { 
                                    loadSaved(); 
                                    try { refreshSavedListsBadge(); } catch(e) {}
                                } else { 
                                    showErrorMessage(data.error || 'Delete failed'); 
                                }
                            })
                            .catch(e => showErrorMessage('Delete failed'));
                        });
                    });
                });
            }

            async function loadSaved(){
                try {
                    const res = await fetch('/api/saved-lists');
                    const data = await res.json();
                    if (data.ok){ renderLists(data.lists); }
                    else { container.innerHTML = '<div>Could not load lists.</div>'; }
                } catch(e){ container.innerHTML = '<div>Error loading lists.</div>'; }
            }

            function saveCurrent(){
                const name = document.getElementById('saveListName').value.trim();
                const description = document.getElementById('saveListDesc').value.trim();
                if (!name){ statusEl.textContent = 'Please enter a list name.'; return; }
                
                // iOS Fix: Perform actual save function without await to maintain user gesture context
                function doActualSave() {
                    statusEl.textContent = 'Saving…';
                    fetch('/api/saved-lists/save', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ list_name: name, description })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.ok){ 
                            statusEl.textContent = 'Saved "' + data.saved.name + '" (' + data.saved.word_count + ' words).'; 
                            loadSaved(); 
                            try{ refreshSavedListsBadge(); }catch(e){}
                            // Clear form after successful save
                            document.getElementById('saveListName').value = '';
                            document.getElementById('saveListDesc').value = '';
                        }
                        else { statusEl.textContent = data.error || 'Save failed'; }
                    })
                    .catch(e => { 
                        console.error('Save error:', e);
                        statusEl.textContent = 'Save failed - check connection'; 
                    });
                }
                
                // Check if it's the default word list (iOS-compatible: no await)
                fetch('/api/wordbank')
                    .then(checkRes => checkRes.json())
                    .then(checkData => {
                        if (checkData.words && checkData.words.length === 50 && checkData.words[0].word === 'verdict') {
                            // This is the default 50-word list - show confirmation
                            showBeeConfirm({
                                title: 'Save Default Word List?',
                                message: "You haven't uploaded your own word list yet. This will save the default 50-word demo list. Upload your own words first if you want to save a custom list.",
                                confirmText: 'Save Default List',
                                cancelText: 'Cancel'
                            }).then(confirmed => {
                                if (confirmed) {
                                    doActualSave();
                                } else {
                                    statusEl.textContent = 'Save cancelled. Upload your own word list first!';
                                }
                            });
                        } else {
                            // Not default list, save immediately
                            doActualSave();
                        }
                    })
                    .catch(e => {
                        console.error('Error checking wordbank:', e);
                        // If check fails, try to save anyway
                        doActualSave();
                    });
            }

            // iOS Fix: Add both click and touchend events for better mobile support
            const saveBtn = document.getElementById('saveCurrentBtn');
            const refreshBtn = document.getElementById('refreshSavedBtn');
            
            saveBtn.onclick = saveCurrent;
            saveBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                saveCurrent();
            }, {passive: false});
            
            refreshBtn.onclick = loadSaved;
            refreshBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                loadSaved();
            }, {passive: false});
            
            loadSaved();
        }

        function showRandomPlayInterface() {
            // Create difficulty selection modal
            let modal = document.getElementById('randomPlayModal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'randomPlayModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(255, 240, 245, 0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10020;
                padding: 1.5rem;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    max-width: 450px;
                    width: 100%;
                    background: linear-gradient(135deg, #FFF0F6 0%, #FFFAE3 100%);
                    border-radius: 24px;
                    padding: 2rem;
                    text-align: center;
                    box-shadow: 0 18px 40px rgba(255, 182, 193, 0.45);
                    border: 3px solid rgba(255, 107, 157, 0.4);
                    position: relative;
                    animation: slideUp 0.3s ease;
                ">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🎲</div>
                    <h2 style="
                        font-size: 1.8rem;
                        color: #FF6B9D;
                        margin-bottom: 1rem;
                        font-weight: 700;
                    ">Random Play Mode</h2>
                    <p style="
                        color: #5A2C15;
                        line-height: 1.6;
                        margin-bottom: 2rem;
                        font-weight: 500;
                    ">
                        Choose your difficulty level and we'll pick 10 random words for you!
                    </p>
                    
                    <!-- Difficulty Level Display -->
                    <div id="difficultyDisplay" style="
                        margin-bottom: 1rem;
                        padding: 1rem;
                        background: rgba(255, 255, 255, 0.7);
                        border-radius: 16px;
                        border: 2px solid rgba(255, 107, 157, 0.3);
                    ">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;" id="starDisplay">⭐⭐⭐</div>
                        <div style="
                            font-size: 1.4rem;
                            font-weight: 700;
                            color: #FF6B9D;
                            margin-bottom: 0.25rem;
                        " id="levelName">Level 3 - Normal</div>
                        <div style="
                            font-size: 0.9rem;
                            color: #8B4513;
                        " id="levelDesc">7-8 letter words with moderate complexity</div>
                    </div>
                    
                    <!-- Slider Control -->
                    <div style="
                        padding: 1.5rem 1rem;
                        margin-bottom: 1.5rem;
                    ">
                        <input 
                            type="range" 
                            id="difficultySlider" 
                            min="1" 
                            max="5" 
                            value="3" 
                            step="1"
                            style="
                                width: 100%;
                                height: 12px;
                                border-radius: 10px;
                                background: linear-gradient(to right, #A0D9A0 0%, #FFD166 25%, #FFA07A 50%, #FF8C94 75%, #C44569 100%);
                                outline: none;
                                opacity: 0.9;
                                transition: opacity 0.2s;
                                cursor: pointer;
                                -webkit-appearance: none;
                                appearance: none;
                            "
                        />
                        <!-- Level markers -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            margin-top: 0.5rem;
                            padding: 0 0.25rem;
                            font-size: 0.85rem;
                            color: #8B4513;
                            font-weight: 600;
                        ">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="
                        display: flex;
                        gap: 1rem;
                        justify-content: center;
                        margin-top: 1.5rem;
                    ">
                        <button id="randomPlaySubmit" style="
                            flex: 1;
                            background: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%);
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 15px;
                            font-size: 1.1rem;
                            font-weight: 700;
                            cursor: pointer;
                            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
                            transition: all 0.3s ease;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        ">
                            🚀 Let's Play!
                        </button>
                        <button id="randomPlayClose" style="
                            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
                            color: #374151;
                            border: none;
                            padding: 1rem 1.5rem;
                            border-radius: 15px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                            transition: all 0.3s ease;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Level data for display
            const levelData = {
                1: { name: 'Easy', desc: '3-4 letter words, simple patterns', stars: '⭐', color: '#A0D9A0' },
                2: { name: 'Medium-Easy', desc: '5-6 letter words, basic patterns', stars: '⭐⭐', color: '#FFD166' },
                3: { name: 'Normal', desc: '7-8 letter words, moderate complexity', stars: '⭐⭐⭐', color: '#FFA07A' },
                4: { name: 'Hard', desc: '9-10 letter words, complex patterns', stars: '⭐⭐⭐⭐', color: '#FF8C94' },
                5: { name: 'Expert', desc: '11+ letter words, very challenging', stars: '⭐⭐⭐⭐⭐', color: '#C44569' }
            };

            // Update display based on slider value
            const slider = document.getElementById('difficultySlider');
            const starDisplay = document.getElementById('starDisplay');
            const levelName = document.getElementById('levelName');
            const levelDesc = document.getElementById('levelDesc');
            const difficultyDisplay = document.getElementById('difficultyDisplay');

            function updateDisplay(level) {
                const data = levelData[level];
                starDisplay.textContent = data.stars;
                levelName.textContent = `Level ${level} - ${data.name}`;
                levelDesc.textContent = data.desc;
                difficultyDisplay.style.borderColor = data.color;
                difficultyDisplay.style.background = `linear-gradient(135deg, ${data.color}22, ${data.color}11)`;
            }

            // Slider event listener
            slider.addEventListener('input', (e) => {
                const level = parseInt(e.target.value);
                updateDisplay(level);
            });

            // Submit button
            document.getElementById('randomPlaySubmit').addEventListener('click', () => {
                const level = parseInt(slider.value);
                console.log('🎲 Submit button clicked! Level:', level);
                modal.remove();
                generateRandomWords(level);
            });

            // Hover effect for submit button
            const submitBtn = document.getElementById('randomPlaySubmit');
            submitBtn.addEventListener('mouseenter', () => {
                submitBtn.style.transform = 'translateY(-3px) scale(1.05)';
                submitBtn.style.boxShadow = '0 10px 30px rgba(255, 107, 157, 0.6)';
            });
            submitBtn.addEventListener('mouseleave', () => {
                submitBtn.style.transform = '';
                submitBtn.style.boxShadow = '0 6px 20px rgba(255, 107, 157, 0.4)';
            });

            // Close button
            document.getElementById('randomPlayClose').addEventListener('click', () => {
                modal.remove();
            });

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function generateRandomWords(difficulty) {
            console.log(`🎲 Generating random words at difficulty level ${difficulty}`);
            
            // Show loading with bee animation (check if loadingSystem exists and is ready)
            if (window.loadingSystem && typeof window.loadingSystem.show === 'function') {
                try {
                    window.loadingSystem.show();
                    window.loadingSystem.updateProgress(10, '🎲 Rolling the dice...');
                } catch (e) {
                    console.warn('Loading system not ready:', e);
                }
            }

            // Call API to generate random words
            fetch('/api/random-words', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    difficulty: difficulty,
                    count: 10
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('✅ Random words generated:', data);
                    
                    if (window.loadingSystem && typeof window.loadingSystem.updateProgress === 'function') {
                        try {
                            window.loadingSystem.updateProgress(50, '🐝 Bees picking perfect words...');
                        } catch (e) {
                            console.warn('Loading system update failed:', e);
                        }
                    }

                    // Wait a bit to show progress
                    setTimeout(() => {
                        if (window.loadingSystem && typeof window.loadingSystem.updateProgress === 'function') {
                            try {
                                window.loadingSystem.updateProgress(100, `✨ ${data.count} words ready!`);
                            } catch (e) {
                                console.warn('Loading system update failed:', e);
                            }
                        }

                        // Update Start Quiz button
                        const startBtn = document.getElementById('startQuizBtn');
                        if (startBtn) {
                            startBtn.disabled = false;
                            startBtn.classList.remove('waiting-to-play');
                            startBtn.classList.add('ready-to-play');
                            startBtn.innerHTML = `🚀 Start Quiz (${data.count} words)`;
                            
                            // Show quiz-ready notification
                            showQuizReadyNotification(data.count);
                        }

                        // Show success message
                        setTimeout(() => {
                            if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                                try {
                                    window.loadingSystem.hide();
                                } catch (e) {
                                    console.warn('Loading system hide failed:', e);
                                }
                            }

                            openFriendlyInfoModal({
                                title: `🎉 ${data.count} Random Words Ready!`,
                                message: `We've picked ${data.count} awesome words at difficulty level ${difficulty} just for you! Click "Start Quiz" to begin your spelling adventure! 🐝`,
                                buttonText: "Let's Go!"
                            });
                        }, 500);
                    }, 800);
                } else {
                    throw new Error(data.message || 'Failed to generate random words');
                }
            })
            .catch(error => {
                console.error('❌ Error generating random words:', error);
                
                if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                    try {
                        window.loadingSystem.hide();
                    } catch (e) {
                        console.warn('Loading system hide failed:', e);
                    }
                }

                openFriendlyInfoModal({
                    title: '😞 Oops!',
                    message: `Something went wrong: ${error.message}. Please try again!`,
                    buttonText: 'OK'
                });
            });
        }

        // --- Battle of the Bees Interface ---
        
        function showBattleInterface() {
            // Create battle interface modal with tabs
            let modal = document.getElementById('battleModal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'battleModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(255, 69, 0, 0.08);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10020;
                padding: 1.5rem;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    background: linear-gradient(135deg, #FFF5F0 0%, #FFFAF5 100%);
                    border-radius: 24px;
                    padding: 0;
                    box-shadow: 0 20px 50px rgba(255, 69, 0, 0.3);
                    border: 3px solid rgba(255, 140, 0, 0.5);
                    position: relative;
                    animation: slideUp 0.3s ease;
                    overflow-y: auto;
                    overflow-x: hidden;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
                        padding: 1.5rem;
                        text-align: center;
                        border-bottom: 3px solid rgba(255, 215, 0, 0.5);
                        position: relative;
                        overflow: hidden;
                    ">
                        <!-- Floating battle icons -->
                        <div style="position: absolute; top: 15px; left: 15px; font-size: 1.2rem; animation: beeHover 2s ease-in-out infinite 0.5s; color: #FFD700;">🐝</div>
                        <div style="position: absolute; top: 20px; right: 20px; font-size: 1rem; animation: sparkleFloat 3s ease-in-out infinite; color: #FFA500;">⚡</div>
                        <div style="position: absolute; bottom: 15px; left: 20px; font-size: 1rem; animation: sparkleFloat 3s ease-in-out infinite 1s; color: #FFD700;">🏆</div>
                        <div style="position: absolute; bottom: 15px; right: 15px; font-size: 1.2rem; animation: beeHover 2s ease-in-out infinite 1.5s; color: #FFA500;">🐝</div>
                        
                        <!-- Main battle icon -->
                        <div style="
                            font-size: 3rem; 
                            margin-bottom: 0.5rem; 
                            animation: battleGlow 2.5s ease-in-out infinite;
                            filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.6));
                        ">⚔️</div>
                        <h2 style="
                            font-size: 1.9rem;
                            color: #ffffff;
                            margin: 0;
                            font-weight: 700;
                            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                        ">Battle of the Bees</h2>
                        <p style="
                            color: rgba(255, 255, 255, 0.95);
                            margin: 0.5rem 0 0;
                            font-weight: 600;
                        ">⚡ Compete with friends & classmates!</p>
                    </div>
                    
                    <!-- Tabs -->
                    <div style="
                        display: flex;
                        gap: 0.75rem;
                        background: rgba(255, 140, 0, 0.1);
                        border-bottom: 2px solid rgba(255, 140, 0, 0.3);
                        padding: 0.5rem;
                    ">
                        <button id="createTab" onclick="switchBattleTab('create')" style="
                            flex: 1;
                            padding: 0.9rem 1rem;
                            background: linear-gradient(135deg, #FF6347 0%, #FF4500 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 0.95rem;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(255, 69, 0, 0.3);
                        ">
                            🏆 Start a Battle
                        </button>
                        <button id="joinTab" onclick="switchBattleTab('join')" style="
                            flex: 1;
                            padding: 0.9rem 1rem;
                            background: rgba(255, 255, 255, 0.9);
                            color: #FF4500;
                            border: 2px solid #FFD700;
                            border-radius: 12px;
                            font-size: 0.95rem;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
                        ">
                            ⚔️ Join the Battle
                        </button>
                    </div>
                    
                    <!-- Create Battle Panel -->
                    <div id="createPanel" style="padding: 2.5rem 2rem; position: relative; overflow: hidden;">
                        <!-- Floating decorative elements -->
                        <div style="position: absolute; top: 20px; left: 15px; font-size: 1.4rem; animation: beeHover 2.5s ease-in-out infinite; color: #FFD700; opacity: 0.8;">🐝</div>
                        <div style="position: absolute; top: 10px; right: 20px; font-size: 1.2rem; animation: sparkleFloat 3s ease-in-out infinite 0.5s; color: #FFA500;">✨</div>
                        <div style="position: absolute; bottom: 30px; left: 25px; font-size: 1rem; animation: sparkleFloat 3.5s ease-in-out infinite 1s; color: #FFD700;">⭐</div>
                        <div style="position: absolute; bottom: 15px; right: 15px; font-size: 1.3rem; animation: beeHover 2.8s ease-in-out infinite 1.5s; color: #FF8C00;">🐝</div>
                        
                        <p style="
                            color: #8B4513;
                            margin-bottom: 1.75rem;
                            font-weight: 500;
                            line-height: 1.7;
                            font-size: 1rem;
                            position: relative;
                            z-index: 1;
                        ">
                            👩‍🏫 Teachers: Create a battle and share the code with your students!
                        </p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="
                                display: block;
                                color: #FF4500;
                                font-weight: 700;
                                margin-bottom: 0.75rem;
                                font-size: 1.05rem;
                            ">Battle Name:</label>
                            <input type="text" id="battleName" placeholder="e.g., Mrs. Smith's Vocabulary Test" style="
                                width: 100%;
                                padding: 1rem 1.25rem;
                                border: 2px solid rgba(255, 140, 0, 0.4);
                                border-radius: 12px;
                                font-size: 1.05rem;
                                box-sizing: border-box;
                            "/>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="
                                display: block;
                                color: #FF4500;
                                font-weight: 700;
                                margin-bottom: 0.75rem;
                                font-size: 1.05rem;
                            ">Your Name:</label>
                            <input type="text" id="creatorName" placeholder="e.g., Mrs. Smith" style="
                                width: 100%;
                                padding: 1rem 1.25rem;
                                border: 2px solid rgba(255, 140, 0, 0.4);
                                border-radius: 12px;
                                font-size: 1.05rem;
                                box-sizing: border-box;
                            "/>
                        </div>
                        
                        <div style="
                            margin-bottom: 2rem;
                            padding: 1.25rem 1.5rem;
                            background: rgba(255, 215, 0, 0.15);
                            border-radius: 12px;
                            border: 2px dashed rgba(255, 140, 0, 0.4);
                        ">
                            <p style="
                                color: #8B4513;
                                font-weight: 600;
                                margin: 0;
                                font-size: 0.95rem;
                                line-height: 1.6;
                            ">
                                📝 Word List: Will use your current word list<br/>
                                <span style="font-size: 0.9rem; opacity: 0.9;">(Make sure you've uploaded or generated words first!)</span>
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                            <button onclick="createBattle()" style="
                                flex: 1;
                                min-width: 180px;
                                background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
                                color: white;
                                border: none;
                                padding: 1.25rem 1.5rem;
                                border-radius: 15px;
                                font-size: 1.15rem;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 6px 20px rgba(255, 69, 0, 0.4);
                                transition: all 0.3s ease;
                                position: relative;
                                overflow: hidden;
                            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(255, 69, 0, 0.6)'; this.style.background='linear-gradient(135deg, #FF6500 0%, #FF143C 100%)'"
                              onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 6px 20px rgba(255, 69, 0, 0.4)'; this.style.background='linear-gradient(135deg, #FF4500 0%, #DC143C 100%)'">
                                ⚔️ Create Battle!
                            </button>
                            <button onclick="closeBattleModal()" style="
                                min-width: 140px;
                                background: rgba(128, 128, 128, 0.2);
                                color: #555;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 15px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Join Battle Panel -->
                    <div id="joinPanel" style="padding: 2.5rem 2rem; display: none; position: relative; overflow: hidden;">
                        <!-- Floating decorative elements -->
                        <div style="position: absolute; top: 15px; left: 20px; font-size: 1.3rem; animation: beeHover 2.2s ease-in-out infinite; color: #FFD700; opacity: 0.8;">🐝</div>
                        <div style="position: absolute; top: 25px; right: 15px; font-size: 1rem; animation: sparkleFloat 3.2s ease-in-out infinite 0.8s; color: #FFA500;">🌟</div>
                        <div style="position: absolute; bottom: 20px; left: 10px; font-size: 1.1rem; animation: sparkleFloat 3.8s ease-in-out infinite 1.2s; color: #FFD700;">✨</div>
                        <div style="position: absolute; bottom: 30px; right: 20px; font-size: 1.2rem; animation: beeHover 2.6s ease-in-out infinite 1.8s; color: #FF8C00;">🐝</div>
                        
                        <p style="
                            color: #8B4513;
                            margin-bottom: 1.75rem;
                            font-weight: 500;
                            line-height: 1.7;
                            font-size: 1rem;
                            position: relative;
                            z-index: 1;
                        ">
                            🎯 Students: Enter the battle code from your teacher!
                        </p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="
                                display: block;
                                color: #FF4500;
                                font-weight: 700;
                                margin-bottom: 0.75rem;
                                font-size: 1.05rem;
                            ">Battle Code:</label>
                            <input type="text" id="battleCode" placeholder="e.g., BATTLE123" maxlength="10" style="
                                width: 100%;
                                padding: 1rem 1.25rem;
                                border: 2px solid rgba(255, 140, 0, 0.4);
                                border-radius: 12px;
                                font-size: 1.2rem;
                                text-transform: uppercase;
                                font-weight: 700;
                                letter-spacing: 2px;
                                text-align: center;
                                box-sizing: border-box;
                            "/>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="
                                display: block;
                                color: #FF4500;
                                font-weight: 700;
                                margin-bottom: 0.75rem;
                                font-size: 1.05rem;
                            ">Your Name:</label>
                            <input type="text" id="playerName" placeholder="e.g., Alice" style="
                                width: 100%;
                                padding: 1rem 1.25rem;
                                border: 2px solid rgba(255, 140, 0, 0.4);
                                border-radius: 12px;
                                font-size: 1.05rem;
                                box-sizing: border-box;
                            "/>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                            <button onclick="joinBattle()" style="
                                flex: 1;
                                min-width: 180px;
                                background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
                                color: white;
                                border: none;
                                padding: 1.25rem 1.5rem;
                                border-radius: 15px;
                                font-size: 1.15rem;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 6px 20px rgba(255, 69, 0, 0.4);
                                transition: all 0.3s ease;
                                position: relative;
                                overflow: hidden;
                            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(255, 69, 0, 0.6)'; this.style.background='linear-gradient(135deg, #FF6500 0%, #FF143C 100%)'"
                              onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 6px 20px rgba(255, 69, 0, 0.4)'; this.style.background='linear-gradient(135deg, #FF4500 0%, #DC143C 100%)'">
                                ⚡ Join Battle!
                            </button>
                            <button onclick="closeBattleModal()" style="
                                min-width: 140px;
                                background: rgba(128, 128, 128, 0.2);
                                color: #555;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 15px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function switchBattleTab(tab) {
            if (tab === 'join') {
                // Redirect to battles page to view and join ongoing battles
                window.location.href = '/battles';
                return;
            }
            
            const createTab = document.getElementById('createTab');
            const joinTab = document.getElementById('joinTab');
            const createPanel = document.getElementById('createPanel');
            const joinPanel = document.getElementById('joinPanel');

            if (tab === 'create') {
                // Active create tab
                createTab.style.background = 'linear-gradient(135deg, #FF6347 0%, #FF4500 100%)';
                createTab.style.color = 'white';
                createTab.style.border = 'none';
                createTab.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.3)';
                createTab.style.transform = 'translateY(-2px)';
                
                // Inactive join tab
                joinTab.style.background = 'rgba(255, 255, 255, 0.9)';
                joinTab.style.color = '#FF4500';
                joinTab.style.border = '2px solid #FFD700';
                joinTab.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.2)';
                joinTab.style.transform = 'translateY(0)';
                
                createPanel.style.display = 'block';
                joinPanel.style.display = 'none';
            } else if (tab === 'join') {
                // Active join tab
                joinTab.style.background = 'linear-gradient(135deg, #FF6347 0%, #FF4500 100%)';
                joinTab.style.color = 'white';
                joinTab.style.border = 'none';
                joinTab.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.3)';
                joinTab.style.transform = 'translateY(-2px)';
                
                // Inactive create tab
                createTab.style.background = 'rgba(255, 255, 255, 0.9)';
                createTab.style.color = '#FF4500';
                createTab.style.border = '2px solid #FFD700';
                createTab.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.2)';
                createTab.style.transform = 'translateY(0)';
                
                joinPanel.style.display = 'block';
                createPanel.style.display = 'none';
            }
        }

        function closeBattleModal() {
            const modal = document.getElementById('battleModal');
            if (modal) {
                modal.remove();
            }
        }

        function createBattle() {
            console.log('🎯 createBattle() called');
            const battleName = document.getElementById('battleName')?.value?.trim();
            const creatorName = document.getElementById('creatorName')?.value?.trim();
            
            console.log('Battle Name:', battleName);
            console.log('Creator Name:', creatorName);

            if (!battleName) {
                console.log('⚠️ Battle name is missing');
                openFriendlyInfoModal({
                    title: '⚠️ Missing Info',
                    message: 'Please enter a battle name!',
                    buttonText: 'OK'
                });
                return;
            }

            if (!creatorName) {
                console.log('⚠️ Creator name is missing');
                openFriendlyInfoModal({
                    title: '⚠️ Missing Info',
                    message: 'Please enter your name!',
                    buttonText: 'OK'
                });
                return;
            }

            // Show loading
            if (window.loadingSystem && typeof window.loadingSystem.show === 'function') {
                try {
                    window.loadingSystem.show('⚔️ Creating Battle of the Bees...');
                } catch (e) {
                    console.warn('Loading system show failed:', e);
                }
            }

            // Create battle
            console.log('📡 Sending battle creation request...');
            fetch('/api/battles/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    battle_name: battleName,
                    creator_name: creatorName,
                    use_current_words: true
                })
            })
            .then(response => {
                console.log('📡 Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('📡 Response data:', data);
                if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                    try {
                        window.loadingSystem.hide();
                    } catch (e) {
                        console.warn('Loading system hide failed:', e);
                    }
                }

                if (data.status === 'success') {
                    closeBattleModal();
                    
                    // Store battle code for teacher
                    const battleCode = data.battle_code;
                    
                    // Show success with battle code and redirect option
                    openFriendlyInfoModal({
                        title: '🏆 Battle Created!',
                        message: `
                            <div style="text-align: center;">
                                <p style="margin-bottom: 1rem;">Your Battle Code is:</p>
                                <div style="font-size: 2rem; font-weight: 900; color: #FF4500; margin: 1rem 0; letter-spacing: 3px; font-family: monospace; background: rgba(255,69,0,0.1); padding: 1rem; border-radius: 10px;">${battleCode}</div>
                                <p style="margin-top: 1rem; font-size: 0.95rem; color: #666;">
                                    📋 Share this code with your students!<br/>
                                    ⏰ Battle lasts for 24 hours<br/>
                                    👥 Students enter their name when joining
                                </p>
                                <button onclick="window.location.href='/battle/${battleCode}'" style="
                                    margin-top: 1.5rem;
                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                    color: white;
                                    border: none;
                                    padding: 1rem 2rem;
                                    border-radius: 15px;
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                    cursor: pointer;
                                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                ">
                                    👀 View Leaderboard & Track Students
                                </button>
                            </div>
                        `,
                        buttonText: 'Close'
                    });
                } else {
                    throw new Error(data.message || 'Failed to create battle');
                }
            })
            .catch(error => {
                console.error('❌ Error creating battle:', error);
                
                if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                    try {
                        window.loadingSystem.hide();
                    } catch (e) {
                        console.warn('Loading system hide failed:', e);
                    }
                }

                openFriendlyInfoModal({
                    title: '😞 Oops!',
                    message: `Something went wrong: ${error.message}. Make sure you have words loaded first!`,
                    buttonText: 'OK'
                });
            });
        }

        function joinBattle() {
            const battleCode = document.getElementById('battleCode').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim();

            if (!battleCode) {
                openFriendlyInfoModal({
                    title: '⚠️ Missing Info',
                    message: 'Please enter the battle code!',
                    buttonText: 'OK'
                });
                return;
            }

            if (!playerName) {
                openFriendlyInfoModal({
                    title: '⚠️ Missing Info',
                    message: 'Please enter your name!',
                    buttonText: 'OK'
                });
                return;
            }

            // Show loading
            if (window.loadingSystem && typeof window.loadingSystem.show === 'function') {
                try {
                    window.loadingSystem.show('⚡ Joining Battle...');
                } catch (e) {
                    console.warn('Loading system show failed:', e);
                }
            }

            // Join battle
            fetch('/api/battles/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    battle_code: battleCode,
                    player_name: playerName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                    try {
                        window.loadingSystem.hide();
                    } catch (e) {
                        console.warn('Loading system hide failed:', e);
                    }
                }

                if (data.status === 'success') {
                    closeBattleModal();
                    
                    // Store battle info
                    const battleCode = data.battle_code;
                    const playerName = data.player_name;
                    
                    // Store battle info in sessionStorage for quiz page
                    sessionStorage.setItem('battle_code', battleCode);
                    sessionStorage.setItem('battle_player_name', playerName);
                    
                    // Update Start Quiz button
                    const startBtn = document.getElementById('startQuizBtn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.classList.remove('waiting-to-play');
                        startBtn.classList.add('ready-to-play');
                        startBtn.innerHTML = `⚔️ Start Battle (${data.word_count} words)`;
                        // Update onclick to pass battle parameters
                        startBtn.onclick = () => window.location.href = `/quiz?battle_code=${battleCode}&player_name=${encodeURIComponent(playerName)}`;
                    }
                    
                    // Show success with options
                    openFriendlyInfoModal({
                        title: `⚔️ Welcome, ${playerName}!`,
                        message: `
                            <div style="text-align: center;">
                                <p style="margin-bottom: 1rem;">You've joined "${data.battle_name}"</p>
                                <div style="background: rgba(255,140,0,0.1); padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                                    👥 <strong>${data.player_count}</strong> players in battle<br/>
                                    📚 <strong>${data.word_count}</strong> words to spell
                                </div>
                                <p style="margin-top: 1rem; font-size: 0.95rem;">Choose what to do next:</p>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="window.location.href='/quiz?battle_code=${battleCode}&player_name=${encodeURIComponent(playerName)}'" style="
                                        background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 1.5rem;
                                        border-radius: 15px;
                                        font-size: 1rem;
                                        font-weight: 700;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
                                    ">
                                        🐝 Start Spelling Now!
                                    </button>
                                    <button onclick="window.location.href='/battle/${battleCode}'" style="
                                        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 1.5rem;
                                        border-radius: 15px;
                                        font-size: 1rem;
                                        font-weight: 700;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                    ">
                                        � View Leaderboard
                                    </button>
                                </div>
                            </div>
                        `,
                        buttonText: 'Close'
                    });
                } else {
                    throw new Error(data.message || 'Failed to join battle');
                }
            })
            .catch(error => {
                console.error('❌ Error joining battle:', error);
                
                if (window.loadingSystem && typeof window.loadingSystem.hide === 'function') {
                    try {
                        window.loadingSystem.hide();
                    } catch (e) {
                        console.warn('Loading system hide failed:', e);
                    }
                }

                openFriendlyInfoModal({
                    title: '😞 Oops!',
                    message: `Something went wrong: ${error.message}. Please check the battle code and try again!`,
                    buttonText: 'OK'
                });
            });
        }

        function openFriendlyInfoModal({ title, message, buttonText = 'Got it!' }) {
            let modal = document.getElementById('kidFriendlyModal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'kidFriendlyModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(255, 240, 245, 0.92);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10020;
                padding: 1.5rem;
            `;

            modal.innerHTML = `
                <div style="
                    max-width: 420px;
                    width: 100%;
                    background: linear-gradient(135deg, #FFF0F6 0%, #FFFAE3 100%);
                    border-radius: 24px;
                    padding: 2rem;
                    text-align: center;
                    box-shadow: 0 18px 40px rgba(255, 182, 193, 0.45);
                    border: 3px dashed rgba(255, 166, 201, 0.6);
                    position: relative;
                ">
                    <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">🐝</div>
                    <h2 style="
                        font-size: 1.6rem;
                        color: #FF6F91;
                        margin-bottom: 0.75rem;
                    ">${title}</h2>
                    <p style="
                        color: #5A2C15;
                        line-height: 1.6;
                        margin-bottom: 1.5rem;
                        font-weight: 500;
                    ">${message}</p>
                    <button id="kidFriendlyClose" style="
                        background: linear-gradient(135deg, #A5F3FC 0%, #FBCFE8 100%);
                        color: #1F2937;
                        border: none;
                        padding: 0.85rem 2rem;
                        border-radius: 999px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 12px 25px rgba(165, 243, 252, 0.45);
                        transition: transform 0.2s;
                    ">${buttonText}</button>
                    <div style="
                        position: absolute;
                        top: -12px;
                        right: -12px;
                        width: 55px;
                        height: 55px;
                        background: linear-gradient(135deg, #FF9AA2, #FFCCF9);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #FFF;
                        font-weight: 700;
                        font-size: 1.2rem;
                        box-shadow: 0 6px 15px rgba(255, 154, 162, 0.35);
                    ">✨</div>
                </div>
            `;

            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);

            const closeBtn = document.getElementById('kidFriendlyClose');
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.transform = 'scale(1.05)';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.transform = 'scale(1)';
            });
            closeBtn.addEventListener('click', () => modal.remove());
        }
        
        function showSpeedRoundInterface() {
            // Check if words are loaded
            fetch('/api/wordbank')
                .then(response => response.json())
                .then(data => {
                    const wordCount = data.count || 0;
                    
                    if (wordCount === 0) {
                        openFriendlyInfoModal({
                            title: '⚠️ No Words Yet!',
                            message: 'Please load some words first before starting the Speed Round Challenge! 📚',
                            buttonText: 'Got it!'
                        });
                        return;
                    }
                    
                    // Show Speed Round setup modal
                    let modal = document.getElementById('speedRoundModal');
                    if (modal) {
                        modal.remove();
                    }

                    modal = document.createElement('div');
                    modal.id = 'speedRoundModal';
                    modal.style.cssText = `
                        position: fixed;
                        inset: 0;
                        background: rgba(255, 215, 0, 0.08);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10020;
                        padding: 1.5rem;
                        animation: fadeIn 0.3s ease;
                    `;

                    modal.innerHTML = `
                        <div style="
                            max-width: 500px;
                            width: 100%;
                            background: linear-gradient(135deg, #FFF9E5 0%, #FFFEF5 100%);
                            border-radius: 24px;
                            padding: 2rem;
                            box-shadow: 0 20px 50px rgba(255, 215, 0, 0.3);
                            border: 3px solid rgba(255, 215, 0, 0.5);
                            position: relative;
                            animation: slideUp 0.3s ease;
                        ">
                            <button onclick="document.getElementById('speedRoundModal').remove()" style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: rgba(255, 255, 255, 0.9);
                                border: 2px solid rgba(255, 215, 0, 0.5);
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                font-size: 1.3rem;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s ease;
                            ">×</button>
                            
                            <div style="text-align: center;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">⚡</div>
                                <h2 style="
                                    font-size: 2rem;
                                    color: #FF8C00;
                                    margin: 0 0 1rem 0;
                                    font-weight: 700;
                                    text-shadow: 0 2px 4px rgba(255, 140, 0, 0.2);
                                ">Speed Round Challenge</h2>
                                <p style="
                                    color: #666;
                                    margin-bottom: 2rem;
                                    font-size: 1.05rem;
                                    line-height: 1.6;
                                ">
                                    ⏱️ Race against the clock!<br/>
                                    ⚡ Spell words as fast as you can!<br/>
                                    🏆 Beat your best time!
                                </p>
                                
                                <div style="
                                    background: rgba(255, 140, 0, 0.1);
                                    padding: 1.5rem;
                                    border-radius: 15px;
                                    margin-bottom: 2rem;
                                    border: 2px solid rgba(255, 140, 0, 0.2);
                                ">
                                    <p style="margin: 0; font-size: 1.1rem; color: #333;">
                                        📚 <strong>${wordCount} words</strong> loaded<br/>
                                        ⏰ Timer starts when you begin!
                                    </p>
                                </div>
                                
                                <button onclick="startSpeedRound()" style="
                                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                                    color: #333;
                                    border: none;
                                    padding: 1.2rem 2.5rem;
                                    border-radius: 999px;
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                    cursor: pointer;
                                    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
                                    transition: all 0.3s ease;
                                    width: 100%;
                                ">
                                    ⚡ Start Speed Round!
                                </button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                })
                .catch(error => {
                    console.error('Error checking wordbank:', error);
                    openFriendlyInfoModal({
                        title: '😞 Oops!',
                        message: 'Something went wrong checking your word list. Please try again!',
                        buttonText: 'OK'
                    });
                });
        }
        
        function startSpeedRound() {
            // Close modal
            const modal = document.getElementById('speedRoundModal');
            if (modal) {
                modal.remove();
            }
            
            // Navigate to dedicated Speed Round setup page (not regular quiz)
            window.location.href = '/speed-round/setup';
        }
        
        // Custom kid-friendly confirmation dialog
        function showBeeConfirm({ title, message, confirmText = 'Yes', cancelText = 'No' }) {
            return new Promise((resolve) => {
                let modal = document.getElementById('beeConfirmModal');
                if (modal) {
                    modal.remove();
                }

                modal = document.createElement('div');
                modal.id = 'beeConfirmModal';
                modal.style.cssText = `
                    position: fixed;
                    inset: 0;
                    background: rgba(255, 215, 0, 0.25);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10020;
                    padding: 1.5rem;
                    animation: fadeIn 0.3s ease;
                `;

                modal.innerHTML = `
                    <div class="modal-content subform" style="
                        max-width: 480px;
                        width: 100%;
                        max-height: 85vh;
                        background: linear-gradient(135deg, #FFF9E6 0%, #FFE8CC 50%, #FFDAB9 100%);
                        border-radius: 28px;
                        padding: 2.5rem;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(255, 140, 0, 0.35);
                        border: 4px solid #FFD700;
                        position: relative;
                        animation: slideUp 0.4s ease;
                        overflow-y: auto;
                        -webkit-overflow-scrolling: touch;
                    ">
                        <div style="font-size: 3.5rem; margin-bottom: 1rem; animation: bounce 1s infinite;">🐝</div>
                        <h2 style="
                            font-size: 1.8rem;
                            color: #D2691E;
                            margin-bottom: 1.25rem;
                            font-weight: 800;
                            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
                        ">${title}</h2>
                        <div class="modal-body" style="
                            color: #5A3A1A;
                            line-height: 1.7;
                            margin-bottom: 2rem;
                            font-weight: 600;
                            font-size: 1.05rem;
                            white-space: pre-line;
                            max-height: calc(65vh - 200px);
                            overflow-y: auto;
                            -webkit-overflow-scrolling: touch;
                            padding-right: 8px;
                        ">${message}</div>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button id="beeConfirmOk" style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                border: none;
                                padding: 1rem 2.5rem;
                                border-radius: 999px;
                                font-weight: 800;
                                font-size: 1.1rem;
                                cursor: pointer;
                                box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
                                transition: all 0.2s;
                                border: 3px solid #FF4757;
                            ">${confirmText}</button>
                            <button id="beeConfirmCancel" style="
                                background: linear-gradient(135deg, #A8E6CF 0%, #88D8B0 100%);
                                color: #2C5F2D;
                                border: none;
                                padding: 1rem 2.5rem;
                                border-radius: 999px;
                                font-weight: 800;
                                font-size: 1.1rem;
                                cursor: pointer;
                                box-shadow: 0 8px 20px rgba(168, 230, 207, 0.4);
                                transition: all 0.2s;
                                border: 3px solid #77DD77;
                            ">${cancelText}</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const okBtn = document.getElementById('beeConfirmOk');
                const cancelBtn = document.getElementById('beeConfirmCancel');

                okBtn.addEventListener('mouseenter', () => {
                    okBtn.style.transform = 'scale(1.08) translateY(-2px)';
                    okBtn.style.boxShadow = '0 12px 28px rgba(255, 107, 107, 0.6)';
                });
                okBtn.addEventListener('mouseleave', () => {
                    okBtn.style.transform = 'scale(1)';
                    okBtn.style.boxShadow = '0 8px 20px rgba(255, 107, 107, 0.4)';
                });
                okBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });

                cancelBtn.addEventListener('mouseenter', () => {
                    cancelBtn.style.transform = 'scale(1.08) translateY(-2px)';
                    cancelBtn.style.boxShadow = '0 12px 28px rgba(168, 230, 207, 0.6)';
                });
                cancelBtn.addEventListener('mouseleave', () => {
                    cancelBtn.style.transform = 'scale(1)';
                    cancelBtn.style.boxShadow = '0 8px 20px rgba(168, 230, 207, 0.4)';
                });
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
            });
        }
        
        // Custom kid-friendly input prompt dialog
        function showBeePrompt({ title, message, placeholder = '', expectedValue = '', caseSensitive = true, multiline = false }) {
            return new Promise((resolve) => {
                let modal = document.getElementById('beePromptModal');
                if (modal) {
                    modal.remove();
                }

                modal = document.createElement('div');
                modal.id = 'beePromptModal';
                modal.style.cssText = `
                    position: fixed;
                    inset: 0;
                    background: rgba(255, 215, 0, 0.25);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10020;
                    padding: 1.5rem;
                    animation: fadeIn 0.3s ease;
                `;

                modal.innerHTML = `
                    <div style="
                        max-width: 520px;
                        width: 100%;
                        background: linear-gradient(135deg, #FFF9E6 0%, #FFE8CC 50%, #FFDAB9 100%);
                        border-radius: 28px;
                        padding: 2.5rem;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(255, 140, 0, 0.35), 0 0 40px rgba(255, 215, 0, 0.2);
                        border: 4px solid #FFD700;
                        position: relative;
                        animation: slideUp 0.4s ease;
                        overflow: hidden;
                    ">
                        <!-- Floating sparkles decoration -->
                        <div style="position: absolute; top: 20px; left: 20px; font-size: 1.2rem; animation: sparkleFloat 3s ease-in-out infinite; color: #FFD700;">✨</div>
                        <div style="position: absolute; top: 30px; right: 30px; font-size: 1rem; animation: sparkleFloat 3s ease-in-out infinite 0.5s; color: #FFA500;">⭐</div>
                        <div style="position: absolute; bottom: 30px; left: 30px; font-size: 1rem; animation: sparkleFloat 3s ease-in-out infinite 1s; color: #FF6B9D;">🌟</div>
                        <div style="position: absolute; bottom: 20px; right: 20px; font-size: 1.2rem; animation: sparkleFloat 3s ease-in-out infinite 1.5s; color: #87CEEB;">✨</div>
                        
                        <!-- Animated bee mascot -->
                        <div style="
                            font-size: 3.5rem; 
                            margin-bottom: 1rem; 
                            animation: beeHover 2s ease-in-out infinite;
                            filter: drop-shadow(0 4px 8px rgba(255, 140, 0, 0.3));
                        ">🐝</div>
                        <h2 style="
                            font-size: 1.8rem;
                            color: #D2691E;
                            margin-bottom: 1.25rem;
                            font-weight: 800;
                            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
                        ">${title}</h2>
                        <div style="
                            color: #5A3A1A;
                            line-height: 1.7;
                            margin-bottom: 1.5rem;
                            font-weight: 600;
                            font-size: 1.05rem;
                            white-space: pre-line;
                        ">${message}</div>
                        ${multiline ? `
                            <textarea id="beePromptInput" placeholder="${placeholder}" rows="8" style="
                                width: 100%;
                                padding: 1rem 1.5rem;
                                border: 3px solid #FFD700;
                                border-radius: 16px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                background: white;
                                color: #D2691E;
                                margin-bottom: 1.5rem;
                                box-shadow: inset 0 2px 8px rgba(210, 105, 30, 0.15);
                                transition: all 0.2s;
                                resize: vertical;
                                overflow-y: auto;
                                max-height: 300px;
                            "></textarea>
                        ` : `
                            <input type="text" id="beePromptInput" placeholder="${placeholder}" style="
                                width: 100%;
                                padding: 1rem 1.5rem;
                                border: 3px solid #FFD700;
                                border-radius: 16px;
                                font-size: 1.2rem;
                                font-weight: 700;
                                text-align: center;
                                background: white;
                                color: #D2691E;
                                margin-bottom: 1.5rem;
                                box-shadow: inset 0 2px 8px rgba(210, 105, 30, 0.15);
                                transition: all 0.2s;
                            " />
                        `}
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button id="beePromptOk" style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                border: none;
                                padding: 1rem 2.5rem;
                                border-radius: 999px;
                                font-weight: 800;
                                font-size: 1.1rem;
                                cursor: pointer;
                                box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
                                transition: all 0.2s;
                                border: 3px solid #FF4757;
                            ">OK</button>
                            <button id="beePromptCancel" style="
                                background: linear-gradient(135deg, #A8E6CF 0%, #88D8B0 100%);
                                color: #2C5F2D;
                                border: none;
                                padding: 1rem 2.5rem;
                                border-radius: 999px;
                                font-weight: 800;
                                font-size: 1.1rem;
                                cursor: pointer;
                                box-shadow: 0 8px 20px rgba(168, 230, 207, 0.4);
                                transition: all 0.2s;
                                border: 3px solid #77DD77;
                            ">Cancel</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const inputField = document.getElementById('beePromptInput');
                const okBtn = document.getElementById('beePromptOk');
                const cancelBtn = document.getElementById('beePromptCancel');

                // Focus the input field
                setTimeout(() => inputField.focus(), 100);

                // Input field focus effects
                inputField.addEventListener('focus', () => {
                    inputField.style.borderColor = '#FFA500';
                    inputField.style.boxShadow = '0 0 0 4px rgba(255, 165, 0, 0.2), inset 0 2px 8px rgba(210, 105, 30, 0.15)';
                });
                inputField.addEventListener('blur', () => {
                    inputField.style.borderColor = '#FFD700';
                    inputField.style.boxShadow = 'inset 0 2px 8px rgba(210, 105, 30, 0.15)';
                });

                // Allow Enter key to submit (single-line input only)
                // For multiline textarea, Enter adds a new line
                inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !multiline) {
                        okBtn.click();
                    }
                });

                okBtn.addEventListener('mouseenter', () => {
                    okBtn.style.transform = 'scale(1.08) translateY(-2px)';
                    okBtn.style.boxShadow = '0 12px 28px rgba(255, 107, 107, 0.6)';
                });
                okBtn.addEventListener('mouseleave', () => {
                    okBtn.style.transform = 'scale(1)';
                    okBtn.style.boxShadow = '0 8px 20px rgba(255, 107, 107, 0.4)';
                });
                okBtn.addEventListener('click', () => {
                    const value = inputField.value;
                    modal.remove();
                    resolve(value);
                });

                cancelBtn.addEventListener('mouseenter', () => {
                    cancelBtn.style.transform = 'scale(1.08) translateY(-2px)';
                    cancelBtn.style.boxShadow = '0 12px 28px rgba(168, 230, 207, 0.6)';
                });
                cancelBtn.addEventListener('mouseleave', () => {
                    cancelBtn.style.transform = 'scale(1)';
                    cancelBtn.style.boxShadow = '0 8px 20px rgba(168, 230, 207, 0.4)';
                });
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(null);
                });
            });
        }
        
        function uploadTextFile(file) {
            // First check if there are existing words
            fetch('/api/wordbank')
                .then(response => response.json())
                .then(data => {
                    const existingWordCount = data.words ? data.words.length : 0;
                    
                    if (existingWordCount > 0) {
                        // Show kid-friendly confirmation
                        showBeeConfirm({
                            title: '🐝 Hold on, little bee! 🐝',
                            message: 
                                `You already have ${existingWordCount} word(s) loaded in the hive!\n\n` +
                                '📝 If you upload a new list, your current words will fly away! 🦋\n\n' +
                                '❓ Do you want to:\n' +
                                '• Replace your current words with the new file?\n' +
                                '• Or keep practicing your current words?\n\n' +
                                '🍯 Choose wisely, spelling bee!',
                            confirmText: 'Replace with New Words',
                            cancelText: 'Keep Current Words'
                        }).then(confirmed => {
                            if (confirmed) {
                                // User wants to replace, proceed with upload
                                proceedWithTextUpload(file);
                            } else {
                                showNotification('✅ Your current words are safe in the hive! 🐝🍯', 'info');
                            }
                        });
                    } else {
                        // No existing words, proceed directly
                        proceedWithTextUpload(file);
                    }
                })
                .catch(error => {
                    console.error('Error checking wordbank:', error);
                    // If error checking, proceed with upload anyway
                    proceedWithTextUpload(file);
                });
        }
        
        // Show animated progress for file upload
        function showFileUploadProgress(filename) {
            // Remove any existing progress UI
            const existingProgress = document.querySelector('.upload-progress-container');
            if (existingProgress) existingProgress.remove();
            
            // Create animated progress UI
            const progressContainer = document.createElement('div');
            progressContainer.className = 'upload-progress-container';
            progressContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #fff8dc 0%, #fffacd 100%);
                border: 4px solid #ffd700;
                border-radius: 25px;
                padding: 40px;
                box-shadow: 0 20px 60px rgba(255, 193, 7, 0.4);
                z-index: 10001;
                min-width: 400px;
                max-width: 500px;
                text-align: center;
            `;
            
            progressContainer.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">🐝</div>
                <div style="font-size: 1.4rem; font-weight: bold; color: #ff8c00; margin-bottom: 10px;">
                    Processing Your Words
                </div>
                <div style="font-size: 0.95rem; color: #8b6914; margin-bottom: 20px; font-style: italic;">
                    ${filename}
                </div>
                
                <!-- Animated honey jar -->
                <div style="position: relative; width: 100%; height: 120px; margin: 20px auto;">
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 100%; 
                                background: linear-gradient(180deg, rgba(255,193,7,0.1) 0%, rgba(255,193,7,0.3) 100%);
                                border: 3px solid #ff8c00;
                                border-radius: 15px;
                                overflow: hidden;">
                        <!-- Honey filling animation -->
                        <div class="honey-fill" style="position: absolute; bottom: 0; left: 0; right: 0; 
                                                       background: linear-gradient(180deg, #ffb300 0%, #ff8c00 50%, #ff6f00 100%);
                                                       height: 0%;
                                                       transition: height 0.3s ease-out;
                                                       box-shadow: inset 0 2px 10px rgba(255,255,255,0.5);">
                        </div>
                        <!-- Floating bees -->
                        <div style="position: absolute; top: 10px; left: 20%; animation: float 2s ease-in-out infinite;">🐝</div>
                        <div style="position: absolute; top: 40px; right: 25%; animation: float 2.5s ease-in-out infinite 0.5s;">🐝</div>
                        <div style="position: absolute; bottom: 30px; left: 30%; animation: float 3s ease-in-out infinite 1s;">🐝</div>
                    </div>
                </div>
                
                <div class="progress-percentage" style="font-size: 2rem; font-weight: bold; 
                                                        color: #ff6f00; margin: 15px 0;">0%</div>
                <div class="progress-message" style="font-size: 1.1rem; color: #8b6914; 
                                                     min-height: 30px; font-weight: 500;">
                    📚 Reading your file...
                </div>
                <div class="progress-detail" style="font-size: 0.9rem; color: #a0826d; 
                                                    margin-top: 10px; min-height: 25px; font-style: italic;">
                    Starting up...
                </div>
            `;
            
            document.body.appendChild(progressContainer);
            
            // Add floating animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0%, 100% { transform: translateY(0px); }
                    50% { transform: translateY(-15px); }
                }
            `;
            document.head.appendChild(style);
            
            return progressContainer;
        }
        
        // Update progress UI with backend data
        function updateFileUploadProgress(percent, message, detail = '') {
            const container = document.querySelector('.upload-progress-container');
            if (!container) return;
            
            const honeyFill = container.querySelector('.honey-fill');
            const percentageEl = container.querySelector('.progress-percentage');
            const messageEl = container.querySelector('.progress-message');
            const detailEl = container.querySelector('.progress-detail');
            
            if (honeyFill) honeyFill.style.height = `${percent}%`;
            if (percentageEl) percentageEl.textContent = `${Math.round(percent)}%`;
            if (messageEl) messageEl.textContent = message;
            if (detailEl && detail) detailEl.textContent = detail;
        }
        
        // Hide progress UI
        function hideFileUploadProgress() {
            const container = document.querySelector('.upload-progress-container');
            if (container) {
                container.style.opacity = '0';
                container.style.transform = 'translate(-50%, -50%) scale(0.8)';
                container.style.transition = 'all 0.3s ease-out';
                setTimeout(() => container.remove(), 300);
            }
        }

        function proceedWithTextUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            console.log('🧪 DEBUG: Starting upload for file:', file.name);
            
            // Show animated progress indicator
            showFileUploadProgress(file.name);
            
            // Simulate progress stages during upload (since backend is synchronous)
            let progress = 0;
            const progressStages = [
                { percent: 15, message: '📄 Reading file...', detail: 'Opening your word list' },
                { percent: 30, message: '🔍 Parsing words...', detail: 'Finding all the words' },
                { percent: 50, message: '🧹 Removing duplicates...', detail: 'Making sure each word is unique' },
                { percent: 65, message: '📖 Looking up definitions...', detail: 'Finding word meanings' },
                { percent: 80, message: '✨ Enriching word data...', detail: 'Adding hints and examples' },
                { percent: 90, message: '🐝 Storing in hive...', detail: 'Saving your word list' }
            ];
            
            let stageIndex = 0;
            const progressInterval = setInterval(() => {
                if (stageIndex < progressStages.length) {
                    const stage = progressStages[stageIndex];
                    updateFileUploadProgress(stage.percent, stage.message, stage.detail);
                    stageIndex++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 600); // Update every 600ms
            
            fetch('/api/upload?' + Date.now(), {
                method: 'POST',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin',  // Ensure session cookie is sent
                body: formData
            })
                .then(async response => {
                    console.log('🧪 DEBUG: Response status:', response.status);
                    let data;
                    try {
                        data = await response.clone().json();
                    } catch (e) {
                        const rawText = await response.text();
                        console.log('🧪 DEBUG: Raw non-JSON response text:', rawText);
                        showErrorMessage('Server returned non-JSON response. See console for details.');
                        throw e; // trigger catch
                    }
                    return data;
                })
                .then(data => {
                console.log('🧪 DEBUG: Response data:', data);
                
                // Stop simulated progress
                clearInterval(progressInterval);
                
                // Complete animation at 100%
                updateFileUploadProgress(100, '✅ Upload complete!', `Successfully loaded ${data.count || 0} words`);
                
                setTimeout(() => {
                    hideFileUploadProgress();
                    
                    if (data.ok) {
                        const encouragingMessages = [
                            `Fantastic! ${data.count} words loaded and ready to spell!`,
                            `Amazing! You've added ${data.count} new words to practice!`,
                            `Wonderful! ${data.count} words are now in your spelling collection!`,
                            `Great job! ${data.count} words uploaded successfully!`,
                            `Awesome! Your word list now has ${data.count} words to master!`
                        ];
                        const message = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                        showSuccessMessage(message);
                    
                    // Enable Start Quiz button IMMEDIATELY (mobile fix)
                    if (data.count > 0) {
                        const btn = document.getElementById('startQuizBtn');
                        btn.disabled = false;
                        btn.removeAttribute('disabled');
                        btn.innerHTML = `🚀 Start Quiz (${data.count} words)`;
                        btn.classList.add('ready-to-play');
                        btn.classList.remove('waiting-to-play');
                        
                        // Force style update for mobile
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                        
                        console.log('✅ Quiz button enabled after text upload:', {
                            disabled: btn.disabled,
                            hasDisabledAttr: btn.hasAttribute('disabled'),
                            classes: btn.className,
                            wordCount: data.count
                        });
                        
                        // Force immediate visual update
                        btn.offsetHeight; // Trigger reflow
                        
                        // Show quiz-ready notification
                        showQuizReadyNotification(data.count);
                    }
                    
                    // DON'T call updateWordCount() - it causes race condition and re-disables button
                    // The button is already enabled above with the correct count from upload response
                    console.log('✅ Text upload complete - quiz button enabled with', data.count, 'words');
                    } else {
                        console.log('🧪 DEBUG: Upload failed with data:', data);
                        
                        // Check if this is a content violation warning from file upload
                        if (data.violation_warning && data.error) {
                            // Show violation in modal popup (like "Attention, spelling bee!")
                            showViolationWarning(data.error);
                        } else {
                            showErrorMessage(data.error || "Oops! There was a problem uploading your file. Let's try again!");
                        }
                    }
                }, 500); // Show completion message briefly
            })
            .catch(error => {
                console.log('🧪 DEBUG: Upload error:', error);
                clearInterval(progressInterval);
                hideFileUploadProgress();
                showErrorMessage('Hmm, something went wrong. Check your file and try again! 😟 😟');
            });
        }
        
        function uploadImageFile(file) {
            // First check if there are existing words
            fetch('/api/wordbank')
                .then(response => response.json())
                .then(data => {
                    const existingWordCount = data.words ? data.words.length : 0;
                    
                    if (existingWordCount > 0) {
                        // Show kid-friendly confirmation
                        showBeeConfirm({
                            title: '🐝 Buzzy says wait! 🐝',
                            message: 
                                `You already have ${existingWordCount} word(s) in your spelling hive!\n\n` +
                                '📷 If you upload this picture, your current words will be replaced! 🦋\n\n' +
                                '❓ What would you like to do?\n' +
                                '• Upload the new picture and replace current words?\n' +
                                '• Or keep your current word list?\n\n' +
                                '🍯 Your choice, spelling champion!',
                            confirmText: 'Upload Picture',
                            cancelText: 'Keep Current Words'
                        }).then(confirmed => {
                            if (confirmed) {
                                // User wants to replace, proceed with upload
                                proceedWithImageUpload(file);
                            } else {
                                showNotification('✅ Your current words are safe! 🐝📚', 'info');
                            }
                        });
                    } else {
                        // No existing words, proceed directly
                        proceedWithImageUpload(file);
                    }
                })
                .catch(error => {
                    console.error('Error checking wordbank:', error);
                    // If error checking, proceed with upload anyway
                    proceedWithImageUpload(file);
                });
        }
        
        function proceedWithImageUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            console.log('🧪 DEBUG: Starting image upload for file:', file.name);
            
            // Show animated progress indicator
            showFileUploadProgress(file.name);
            
            // Simulate OCR progress stages (OCR takes longer)
            let progress = 0;
            const progressStages = [
                { percent: 10, message: '📷 Reading image...', detail: 'Loading your picture' },
                { percent: 25, message: '🔍 Scanning for text...', detail: 'Looking for words in the image' },
                { percent: 45, message: '🤖 Using OCR magic...', detail: 'Converting image to text' },
                { percent: 60, message: '📝 Extracting words...', detail: 'Finding all the words' },
                { percent: 75, message: '📖 Looking up definitions...', detail: 'Getting word meanings' },
                { percent: 90, message: '🐝 Storing in hive...', detail: 'Saving your word list' }
            ];
            
            let stageIndex = 0;
            const progressInterval = setInterval(() => {
                if (stageIndex < progressStages.length) {
                    const stage = progressStages[stageIndex];
                    updateFileUploadProgress(stage.percent, stage.message, stage.detail);
                    stageIndex++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 800); // Slower for OCR (800ms per stage)
            
            fetch('/api/upload?' + Date.now(), {
                method: 'POST',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin',  // Ensure session cookie is sent
                body: formData
            })
                .then(async response => {
                    console.log('🧪 DEBUG: Image response status:', response.status);
                    let data;
                    try {
                        data = await response.clone().json();
                    } catch (e) {
                        const rawText = await response.text();
                        console.log('🧪 DEBUG: Raw non-JSON image response text:', rawText);
                        showErrorMessage('Image upload returned non-JSON response (see console).');
                        throw e;
                    }
                    return data;
                })
                .then(data => {
                console.log('🧪 DEBUG: Image response data:', data);
                
                // Stop simulated progress
                clearInterval(progressInterval);
                
                if (data.ok) {
                    // Complete animation at 100%
                    updateFileUploadProgress(100, '✅ OCR complete!', `Found ${data.count || 0} words in image`);
                    
                    setTimeout(() => {
                        hideFileUploadProgress();
                        
                        const magicMessages = [
                            `Wow! Found ${data.count} words in your picture like magic!`,
                            `Amazing! Our word detector found ${data.count} words in your image!`,
                            `Incredible! ${data.count} words were hiding in your picture!`,
                            `Fantastic! We discovered ${data.count} words from your photo!`
                        ];
                        const message = magicMessages[Math.floor(Math.random() * magicMessages.length)];
                        showSuccessMessage(message);
                    
                        // Enable Start Quiz button IMMEDIATELY (mobile fix)
                        if (data.count > 0) {
                            const btn = document.getElementById('startQuizBtn');
                            btn.disabled = false;
                            btn.removeAttribute('disabled');
                            btn.innerHTML = `🚀 Start Quiz (${data.count} words)`;
                            btn.classList.add('ready-to-play');
                            btn.classList.remove('waiting-to-play');
                            
                            // Force style update for mobile
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                            btn.style.pointerEvents = 'auto';
                            
                            console.log('✅ Quiz button enabled after image upload:', {
                                disabled: btn.disabled,
                                hasDisabledAttr: btn.hasAttribute('disabled'),
                                classes: btn.className,
                                wordCount: data.count
                            });
                            
                            // Force immediate visual update
                            btn.offsetHeight; // Trigger reflow
                            
                            // Show quiz-ready notification
                            showQuizReadyNotification(data.count);
                        }
                        
                        // DON'T call updateWordCount() - causes race condition and re-disables button
                        // Button already enabled above with correct count from upload response
                        console.log('✅ Image upload complete - quiz button enabled with', data.count, 'words');
                    }, 500); // Show completion message briefly
                } else {
                    // Error occurred - hide progress immediately
                    hideFileUploadProgress();
                    
                    // Check for OCR-specific error
                    const errorMsg = data.error || "Unknown error occurred";
                    const isOCRError = errorMsg.includes('tesseract') || errorMsg.includes('Tesseract') || errorMsg.includes('OCR');
                    
                    if (isOCRError) {
                        // Show user-friendly OCR error with helpful alternatives
                        showBeeConfirm({
                            title: '📷 Image Upload Not Available',
                            message: 
                                "🐝 Oops! The word finder needs special software that isn't installed yet.\n\n" +
                                "💡 Here are other fun ways to add your words:\n\n" +
                                "✍️ Type your words manually (quick & easy!)\n" +
                                "📄 Upload a text file (.txt, .csv, .docx, .pdf)\n\n" +
                                "🍯 Your teacher or parent can install Tesseract OCR if you really need image uploads!",
                            confirmText: 'Type Words Instead',
                            cancelText: 'Upload File Instead'
                        }).then(confirmed => {
                            if (confirmed) {
                                // User chose manual entry
                                selectOption('manual', document.querySelector('.menu-option[onclick*="manual"]'));
                            } else {
                                // User chose file upload
                                selectOption('text', document.querySelector('.menu-option[onclick*="text"]'));
                            }
                        });
                    } else {
                        // Check if this is a content violation warning from image upload
                        if (data.violation_warning && data.error) {
                            // Show violation in modal popup (like "Attention, spelling bee!")
                            showViolationWarning(data.error);
                        } else {
                            // Other error - show standard error message
                            showErrorMessage(errorMsg || "Our word finder couldn't read this image clearly. Try a clearer photo! 📸");
                        }
                    }
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                hideFileUploadProgress();
                showErrorMessage("Oops! Something went wrong with the image. Let's try another one! 🤔");
            });
        }
        
        function searchDictionary(term) {
            showLoadingMessage('🔍 Looking up the word "' + term + '" in our magical dictionary...');
            
            fetch('/api/dictionary-lookup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ word: term })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingMessage();
                if (data.definition && data.definition.trim()) {
                    showDictionaryResult(data.word, data.definition, data.phonetic || '');
                } else {
                    showErrorMessage('Word not found in dictionary');
                }
            })
            .catch(error => {
                hideLoadingMessage();
                showErrorMessage('Error searching dictionary: ' + error.message);
            });
        }
        
        function startQuiz() {
            console.log('startQuiz called');
            
            // Verify wordbank exists before navigating
            fetch('/api/wordbank', {
                cache: 'no-store',
                credentials: 'same-origin',  // Ensure session cookie is sent
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
                .then(response => response.json())
                .then(data => {
                    const wordCount = data.count || data.words?.length || 0;
                    console.log('✅ Pre-quiz wordbank check:', wordCount, 'words');
                    
                    if (wordCount === 0) {
                        showErrorMessage('⚠️ No words loaded! Please upload a word list first.');
                        return;
                    }
                    
                    // Play magical sound
                    if (window.magicalEffects) {
                        window.magicalEffects.playChimeSounds();
                    }
                    
                    // Show loading briefly, then navigate
                    showLoadingMessage('🌟 Getting your spelling adventure ready...');
                    setTimeout(() => {
                        window.location.href = '/quiz';
                    }, 150);
                })
                .catch(error => {
                    console.error('❌ Pre-quiz wordbank check failed:', error);
                    showErrorMessage('Oops! Please try uploading your word list again.');
                });
        }
        
        function updateWordCount() {
            // Add cache-busting parameter for Safari
            const cacheBuster = Date.now();
            fetch(`/api/wordbank?_=${cacheBuster}`, {
                cache: 'no-store',
                credentials: 'same-origin',  // Ensure session cookie is sent
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => response.json())
                .then(data => {
                    const wordCount = data.words ? data.words.length : 0;
                    const startBtn = document.getElementById('startQuizBtn');
                    console.log('📊 Word count updated:', wordCount, 'Button element:', startBtn);
                    
                    if (wordCount > 0) {
                        startBtn.disabled = false;
                        startBtn.removeAttribute('disabled');
                        startBtn.innerHTML = `🐝 Let's Get Buzzing Spelling Some Words! (${wordCount} words)`;
                        startBtn.classList.add('ready-to-play');
                        startBtn.classList.remove('waiting-to-play');
                        
                        // Force inline styles for mobile (critical!)
                        startBtn.style.opacity = '1';
                        startBtn.style.cursor = 'pointer';
                        startBtn.style.pointerEvents = 'auto';
                        
                        // Force reflow
                        startBtn.offsetHeight;
                        
                        console.log('✅ Button enabled in updateWordCount:', {
                            disabled: startBtn.disabled,
                            hasDisabledAttr: startBtn.hasAttribute('disabled'),
                            classes: startBtn.className,
                            style: startBtn.style.cssText
                        });
                        
                        // Encourage the child
                        if (wordCount >= 5) {
                            showSuccessMessage(`Awesome! You have ${wordCount} words ready to practice! 🎯`);
                        } else {
                            showNotification(`Great start! ${wordCount} words loaded. Add more for longer practice! 📚`, 'info');
                        }
                    } else {
                        startBtn.disabled = true;
                        startBtn.setAttribute('disabled', 'disabled');
                        startBtn.innerHTML = "🌟 Let's Spell! (Add words first)";
                        startBtn.classList.remove('ready-to-play');
                        startBtn.classList.add('waiting-to-play');
                        
                        // Force disabled styles
                        startBtn.style.opacity = '0.6';
                        startBtn.style.cursor = 'not-allowed';
                        startBtn.style.pointerEvents = 'none';
                    }
                })
                .catch(error => {
                    console.log('Could not check word count:', error);
                });
        }
        
        // UI Helper Functions
        function showLoadingMessage(message) {
            // Create or update loading overlay
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 240, 245, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    color: #5A2C15;
                    font-size: 1.2rem;
                    backdrop-filter: blur(4px);
                `;
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = `
                <div style="
                    text-align: center;
                    background: linear-gradient(135deg, #FFF5D7 0%, #FFE1F2 100%);
                    padding: 2rem;
                    border-radius: 24px;
                    box-shadow: 0 18px 38px rgba(255, 182, 193, 0.45);
                    border: 3px dashed rgba(255, 166, 201, 0.5);
                    max-width: 360px;
                    width: calc(100% - 3rem);
                    position: relative;
                ">
                    <div id="beeHiveLoader" style="
                        width: 200px;
                        height: 200px;
                        margin: 0 auto 1rem;
                        position: relative;
                    "></div>
                    <div style="font-weight: 600; line-height: 1.6;">${message}</div>
                </div>
            `;
            overlay.style.display = 'flex';
            
            // Create 3D beehive with buzzing bees
            create3DBeeHiveAnimation();
        }
        
        function create3DBeeHiveAnimation() {
            const container = document.getElementById('beeHiveLoader');
            if (!container) return;
            
            // Clear any existing content
            container.innerHTML = '';
            
            // Create Three.js scene for 3D beehive
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(45, 200 / 200, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ 
                alpha: true, 
                antialias: true,
                powerPreference: 'low-power' // iOS battery-friendly
            });
            
            renderer.setSize(200, 200);
            renderer.setClearColor(0x000000, 0); // Transparent background
            container.appendChild(renderer.domElement);
            
            // Lighting - soft and warm like honey
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffd700, 0.6);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const fillLight = new THREE.DirectionalLight(0xffaa00, 0.3);
            fillLight.position.set(-5, 3, -5);
            scene.add(fillLight);
            
            // Load beehive 3D model
            const loader = new THREE.OBJLoader();
            const mtlLoader = new THREE.MTLLoader();
            
            // Set the base path for textures so MTL can find the PNG file
            mtlLoader.setPath('/static/3DFiles/HoneyComb/');
            
            // Load materials first, then model
            mtlLoader.load('Bee_Haven_1016134000_texture.mtl', function(materials) {
                materials.preload();
                loader.setMaterials(materials);
                
                // Set the base path for OBJ loader as well
                loader.setPath('/static/3DFiles/HoneyComb/');
                
                loader.load('Bee_Haven_1016134000_texture.obj', function(hiveModel) {
                    // Center and scale the hive
                    const box = new THREE.Box3().setFromObject(hiveModel);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 3.5 / maxDim;
                    
                    hiveModel.position.x = -center.x * scale;
                    hiveModel.position.y = -center.y * scale;
                    hiveModel.position.z = -center.z * scale;
                    hiveModel.scale.setScalar(scale);
                    
                    scene.add(hiveModel);
                    
                    // Store for animation
                    container.hiveModel = hiveModel;
                }, undefined, function(error) {
                    console.warn('Beehive model loading failed, using fallback:', error);
                    createFallbackHiveAnimation(container);
                });
            }, undefined, function(error) {
                console.warn('Beehive materials loading failed, using fallback:', error);
                createFallbackHiveAnimation(container);
            });
            
            // Position camera
            camera.position.z = 6;
            
            // Create buzzing bees (emoji overlays)
            const beeCount = 6;
            for (let i = 0; i < beeCount; i++) {
                const bee = document.createElement('div');
                const angle = (i / beeCount) * 2 * Math.PI;
                const delay = i * 0.2;
                
                bee.style.cssText = `
                    position: absolute;
                    font-size: 1.8rem;
                    animation: buzzAroundHive 3s ease-in-out ${delay}s infinite;
                    --angle: ${angle}rad;
                    pointer-events: none;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
                `;
                bee.textContent = '🐝';
                container.appendChild(bee);
            }
            
            // Add CSS animation for bees buzzing around hive
            if (!document.getElementById('beeHiveAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'beeHiveAnimationStyle';
                style.textContent = `
                    @keyframes buzzAroundHive {
                        0%, 100% {
                            left: calc(50% + 70px * cos(var(--angle)));
                            top: calc(50% + 70px * sin(var(--angle)));
                            transform: translate(-50%, -50%) rotate(0deg) scale(1);
                        }
                        25% {
                            left: calc(50% + 85px * cos(var(--angle) + 0.5));
                            top: calc(50% + 85px * sin(var(--angle) + 0.5));
                            transform: translate(-50%, -50%) rotate(15deg) scale(1.1);
                        }
                        50% {
                            left: calc(50% + 75px * cos(var(--angle) + 1));
                            top: calc(50% + 75px * sin(var(--angle) + 1));
                            transform: translate(-50%, -50%) rotate(-10deg) scale(0.95);
                        }
                        75% {
                            left: calc(50% + 65px * cos(var(--angle) + 1.5));
                            top: calc(50% + 65px * sin(var(--angle) + 1.5));
                            transform: translate(-50%, -50%) rotate(20deg) scale(1.05);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Animation loop
            let rotationSpeed = 0;
            function animate() {
                if (!container.isConnected) {
                    // Cleanup when removed from DOM
                    renderer.dispose();
                    return;
                }
                
                requestAnimationFrame(animate);
                
                // Gentle rotation and bobbing
                if (container.hiveModel) {
                    rotationSpeed += 0.003;
                    container.hiveModel.rotation.y = rotationSpeed;
                    container.hiveModel.position.y = Math.sin(rotationSpeed * 2) * 0.1;
                }
                
                renderer.render(scene, camera);
            }
            animate();
            
            // Store cleanup function
            container.cleanup = () => {
                renderer.dispose();
                if (container.hiveModel) {
                    scene.remove(container.hiveModel);
                }
            };
        }
        
        function createFallbackHiveAnimation(container) {
            // Fallback to emoji hive if 3D model fails to load
            container.innerHTML = '';
            
            const honeycomb = document.createElement('div');
            honeycomb.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3.5rem;
                animation: pulse 2s ease-in-out infinite;
            `;
            honeycomb.textContent = '🏠';
            container.appendChild(honeycomb);
            
            // Add pulse animation
            if (!document.getElementById('hivePulseStyle')) {
                const style = document.createElement('style');
                style.id = 'hivePulseStyle';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { transform: translate(-50%, -50%) scale(1); }
                        50% { transform: translate(-50%, -50%) scale(1.1); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function createBeeHiveAnimation() {
            // Legacy function - now redirects to 3D version
            create3DBeeHiveAnimation();
        }
        
        function hideLoadingMessage() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                // Cleanup 3D renderer if it exists
                const container = document.getElementById('beeHiveLoader');
                if (container && container.cleanup) {
                    container.cleanup();
                }
                overlay.style.display = 'none';
            }
        }
        
        function showSuccessMessage(message) {
            // Play celebration sound
            if (window.magicalEffects) {
                window.magicalEffects.playMagicalSound(523.25, 0.3, 'sine'); // C note
                setTimeout(() => window.magicalEffects.playMagicalSound(659.25, 0.3, 'sine'), 150); // E note
                setTimeout(() => window.magicalEffects.playMagicalSound(783.99, 0.3, 'sine'), 300); // G note
            }
            
            showNotification('🎉 ' + message, 'success');
            
            // Add celebration particles
            createCelebrationParticles();
        }
        
        function showErrorMessage(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1.2rem 1.8rem;
                border-radius: 20px;
                color: white;
                font-weight: 700;
                font-size: 1rem;
                z-index: 10001;
                animation: slideIn 0.3s ease-out;
                max-width: 350px;
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
                border: 3px solid rgba(255, 255, 255, 0.4);
                text-align: center;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #FFD93D 0%, #6BCF7F 100%)';
                notification.style.color = '#2d5016';
                notification.innerHTML = `<div style="font-size: 1.8rem; margin-bottom: 0.3rem;">🎉</div>${message}`;
                notification.style.animation = 'slideIn 0.3s ease-out, successPulse 0.5s ease-in-out 3';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #FF9AA2 0%, #FFB7B2 100%)';
                notification.style.color = '#5c1a1a';
                notification.innerHTML = `<div style="font-size: 1.8rem; margin-bottom: 0.3rem;">🤔</div>${message}`;
            } else {
                notification.style.background = 'linear-gradient(135deg, #A8E6CF 0%, #87CEEB 100%)';
                notification.style.color = '#1a3d5c';
                notification.innerHTML = `<div style="font-size: 1.8rem; margin-bottom: 0.3rem;">💡</div>${message}`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        function createCelebrationParticles() {
            const colors = ['#FFD700', '#FF69B4', '#87CEEB', '#98FB98', '#FFB6C1'];
            const emojis = ['🌟', '⭐', '✨', '🎉', '🎊', '🌈'];
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                const isEmoji = Math.random() > 0.6;
                
                if (isEmoji) {
                    particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    particle.style.fontSize = '1.5rem';
                } else {
                    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.borderRadius = '50%';
                }
                
                particle.style.position = 'fixed';
                particle.style.left = '50%';
                particle.style.top = '30%';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '10000';
                
                const angle = (Math.PI * 2 * i) / 15;
                const velocity = 200 + Math.random() * 100;
                const duration = 1500 + Math.random() * 500;
                
                particle.style.animation = `celebrationBurst ${duration}ms ease-out forwards`;
                particle.style.setProperty('--end-x', Math.cos(angle) * velocity + 'px');
                particle.style.setProperty('--end-y', Math.sin(angle) * velocity + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, duration);
            }
        }
        
        // Quiz Ready Notification System
        function showQuizReadyNotification(wordCount) {
            // Remove any existing notification
            const existing = document.querySelector('.quiz-ready-banner');
            if (existing) {
                existing.remove();
            }
            
            // Create banner
            const banner = document.createElement('div');
            banner.className = 'quiz-ready-banner';
            banner.innerHTML = `
                ✅ <strong>${wordCount} words loaded!</strong> 
                Ready to practice? 
                <button class="inline-link-btn" onclick="startQuiz()">
                    Start Quiz Now 🐝 →
                </button>
                <button class="close-btn" onclick="this.parentElement.remove()" title="Dismiss">×</button>
            `;
            
            document.body.appendChild(banner);
            
            // Make quiz button pulse
            const quizButton = document.getElementById('startQuizBtn');
            if (quizButton) {
                quizButton.classList.add('pulse-attention');
            }
            
            // Auto-remove after 7 seconds
            setTimeout(() => {
                if (banner.parentNode) {
                    banner.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        banner.remove();
                        if (quizButton) {
                            quizButton.classList.remove('pulse-attention');
                        }
                    }, 300);
                }
            }, 7000);
        }
        
        function scrollToQuizButton() {
            // Remove notification
            const banner = document.querySelector('.quiz-ready-banner');
            if (banner) {
                banner.remove();
            }
            
            // Scroll to quiz button
            const quizButton = document.getElementById('startQuizBtn');
            if (quizButton) {
                quizButton.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Flash highlight
                quizButton.classList.remove('pulse-attention');
                quizButton.classList.add('highlight-flash');
                
                // Remove highlight after animation
                setTimeout(() => {
                    quizButton.classList.remove('highlight-flash');
                }, 3000);
            }
        }
        
        function showDictionaryResult(word, definition, phonetic) {
            // Parse definition in dictionary style (matching quiz format)
            let cleanDef = definition.replace(/^[📖🔤📚]\s*/, '');
            let wordType = '';
            let mainDefinition = cleanDef;
            let exampleSentence = '';
            
            // Check if definition contains "Fill in the blank:"
            if (cleanDef.includes('Fill in the blank:')) {
                const parts = cleanDef.split('Fill in the blank:');
                mainDefinition = parts[0].trim();
                exampleSentence = parts[1] ? parts[1].trim() : '';
            }
            
            // Extract word type if present (verb, noun, etc.)
            const typeMatch = mainDefinition.match(/^\((verb|noun|adjective|adverb|pronoun|preposition|conjunction|interjection)\)/i);
            if (typeMatch) {
                wordType = typeMatch[1];
                mainDefinition = mainDefinition.replace(typeMatch[0], '').trim();
            }
            
            const modal = document.createElement('div');
            modal.id = 'dictionaryModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <style>
                    .dict-voice-visualizer {
                        width: 200px;
                        height: 80px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 6px;
                        margin: 1rem auto;
                        background: rgba(255, 107, 157, 0.1);
                        border-radius: 16px;
                        padding: 0.75rem;
                    }
                    .dict-voice-wave {
                        width: 6px;
                        height: 20px;
                        background: linear-gradient(180deg, #FF69B4 0%, #FF1493 100%);
                        border-radius: 10px;
                        transition: height 0.15s ease;
                    }
                    .dict-voice-visualizer.speaking .dict-voice-wave {
                        animation-duration: 0.6s;
                        animation-iteration-count: infinite;
                        animation-timing-function: ease-in-out;
                    }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(1) { animation-delay: 0.3s; animation-name: dictWaveShort; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(2) { animation-delay: 0.2s; animation-name: dictWaveMedium; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(3) { animation-delay: 0.1s; animation-name: dictWaveTall; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(4) { animation-delay: 0s; animation-name: dictWaveTallest; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(5) { animation-delay: 0.1s; animation-name: dictWaveTall; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(6) { animation-delay: 0.2s; animation-name: dictWaveMedium; }
                    .dict-voice-visualizer.speaking .dict-voice-wave:nth-child(7) { animation-delay: 0.3s; animation-name: dictWaveShort; }
                    
                    @keyframes dictWaveShort {
                        0%, 100% { height: 20px; }
                        50% { height: 35px; }
                    }
                    @keyframes dictWaveMedium {
                        0%, 100% { height: 25px; }
                        50% { height: 45px; }
                    }
                    @keyframes dictWaveTall {
                        0%, 100% { height: 30px; }
                        50% { height: 55px; }
                    }
                    @keyframes dictWaveTallest {
                        0%, 100% { height: 35px; }
                        50% { height: 65px; }
                    }
                    .phonetic-display {
                        background: rgba(255, 182, 193, 0.2);
                        padding: 0.75rem 1.5rem;
                        border-radius: 12px;
                        font-size: 1.3rem;
                        font-weight: 700;
                        letter-spacing: 3px;
                        color: #FF1493;
                        margin: 1rem 0;
                        font-family: 'Monaco', 'Courier New', monospace;
                    }
                    .dict-pronunciation {
                        font-family: 'Courier New', monospace;
                        color: #666;
                        font-size: 0.95rem;
                        margin-bottom: 0.5rem;
                        display: block;
                        text-align: left;
                    }
                    .dict-word-type {
                        display: inline-block;
                        background: linear-gradient(135deg, #E8A87C 0%, #C27BA0 100%);
                        color: white;
                        padding: 0.2rem 0.8rem;
                        border-radius: 12px;
                        font-size: 0.85rem;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 0.75rem;
                    }
                    .dict-word-definition {
                        font-weight: 500;
                        color: #2C3E50;
                        margin-bottom: 1rem;
                        display: block;
                        line-height: 1.7;
                        font-size: 1.1rem;
                        text-align: left;
                    }
                    .dict-definition-number {
                        font-weight: 700;
                        color: #E8A87C;
                        margin-right: 0.5rem;
                    }
                    .dict-sentence-example {
                        font-style: italic;
                        color: #5D6D7E;
                        display: block;
                        margin-top: 0.75rem;
                        padding: 0.75rem 1rem;
                        background: rgba(232, 168, 124, 0.08);
                        border-left: 3px solid #E8A87C;
                        border-radius: 0 8px 8px 0;
                        line-height: 1.6;
                        text-align: left;
                    }
                    .dict-example-label {
                        font-weight: 600;
                        color: #E8A87C;
                        font-style: normal;
                        margin-right: 0.5rem;
                    }
                    .pronounce-btn {
                        background: linear-gradient(45deg, #FFB6C1, #FF69B4);
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 10px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 1rem;
                        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
                    }
                    .pronounce-btn:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 16px rgba(255, 105, 180, 0.4);
                    }
                    .pronounce-btn:active {
                        transform: scale(0.98);
                    }
                    .dict-definition-container {
                        background: rgba(255, 250, 227, 0.5);
                        border-radius: 18px;
                        border: 2px dashed rgba(255, 193, 7, 0.6);
                        padding: 1.5rem;
                        margin: 1.5rem 0;
                        box-shadow: inset 0 0 14px rgba(255, 193, 7, 0.18);
                    }
                </style>
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 20px;
                    max-width: 550px;
                    width: 90%;
                    margin: 1rem;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                ">
                    <h2 style="color: #FF1493; margin-bottom: 1rem; font-size: 2rem;">${word}</h2>
                    
                    <button class="pronounce-btn" onclick="pronounceWord('${word}')" style="margin-bottom: 1.5rem;">
                        🔊 Hear the Word
                    </button>
                    
                    <div class="dict-definition-container">
                        ${wordType ? `<div class="dict-word-type">${wordType}</div>` : ''}
                        <div class="dict-word-definition">
                            <span class="dict-definition-number">1.</span>${mainDefinition}
                        </div>
                        ${exampleSentence ? `
                            <div class="dict-sentence-example">
                                <span class="dict-example-label">Example:</span>
                                <span class="example-text">${exampleSentence}</span>
                            </div>
                        ` : ''}
                        ${phonetic ? `<div class="dict-pronunciation" style="margin-top: 1rem;">🔊 [${phonetic}]</div>` : ''}
                    </div>
                    
                    <div class="dict-voice-visualizer" id="dictVoiceVisualizer" style="margin-top: 1.5rem;">
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                        <div class="dict-voice-wave"></div>
                    </div>
                    
                    <button onclick="closeDictionaryModal()" 
                            style="
                                background: linear-gradient(45deg, #FF69B4, #FF1493);
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: transform 0.2s;
                            "
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'"
                            >Close</button>
                </div>
            `;
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDictionaryModal();
                }
            });
            
            document.body.appendChild(modal);
            
            // iOS Safari fix: Pre-load voices on modal open
            if ('speechSynthesis' in window && window.speechSynthesis.getVoices) {
                // iOS requires voices to be loaded before use
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.addEventListener('voiceschanged', function() {
                        console.log('🗣️ Voices loaded for iOS');
                    }, { once: true });
                }
            }
        }
        
        function pronounceWord(word) {
            const visualizer = document.getElementById('dictVoiceVisualizer');
            if (!visualizer) return;
            
            // Animate visualizer
            visualizer.classList.add('speaking');
            
            // Use Web Speech API to pronounce the word
            if ('speechSynthesis' in window) {
                // iOS Safari fix: Initialize speechSynthesis early
                // iOS requires user interaction before speech can work
                if (!window.speechSynthesisInitialized) {
                    // Trigger speech synthesis initialization for iOS
                    const initUtterance = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(initUtterance);
                    window.speechSynthesisInitialized = true;
                }
                
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Small delay for iOS to process cancellation
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.rate = 0.8; // Slower for clarity
                    utterance.pitch = 1.1; // Slightly higher pitch for kid-friendly sound
                    utterance.volume = 1.0;
                    
                    // Select British English Female voice
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        // Priority 1: British English Female
                        let selectedVoice = voices.find(v => 
                            (v.lang.includes('en-GB') || v.lang.includes('en-UK')) && 
                            v.name.toLowerCase().includes('female')
                        );
                        
                        // Priority 2: British English (any)
                        if (!selectedVoice) {
                            selectedVoice = voices.find(v => 
                                v.lang.includes('en-GB') || v.lang.includes('en-UK')
                            );
                        }
                        
                        // Priority 3: Any English female voice
                        if (!selectedVoice) {
                            selectedVoice = voices.find(v => 
                                v.lang.startsWith('en-') &&
                                (v.name.toLowerCase().includes('female') ||
                                 v.name.includes('Kate') || v.name.includes('Susan'))
                            );
                        }
                        
                        // Priority 4: Any English voice (fallback)
                        if (!selectedVoice) {
                            selectedVoice = voices.find(v => v.lang.startsWith('en-'));
                        }
                        
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                    }
                    
                    utterance.onend = function() {
                        visualizer.classList.remove('speaking');
                    };
                    
                    utterance.onerror = function(event) {
                        console.error('Speech error:', event);
                        visualizer.classList.remove('speaking');
                    };
                    
                    window.speechSynthesis.speak(utterance);
                }, 100);
            } else {
                // Fallback: just show animation
                setTimeout(() => {
                    visualizer.classList.remove('speaking');
                }, 1500);
            }
        }
        
        function closeDictionaryModal() {
            const modal = document.getElementById('dictionaryModal');
            if (modal) {
                modal.remove();
            }
        }

        class MenuBeeSwarm3D {
            constructor(canvasId = 'beeSwarmCanvas') {
                this.canvas = document.getElementById(canvasId);
                this.isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                this.bees = [];
                this.loadedModels = { blossom: null, smiley: null };
                this.loadingProgress = 0;
                this.loadingMusicContext = null;
                this.loadingMusicOscillators = [];
                
                // Start cheerful loading music
                this.playLoadingMusic();
                
                // Check if Three.js and loaders are available
                if (typeof THREE === 'undefined') {
                    console.error('❌ THREE.js not loaded');
                    this.hideLoader();
                    this.fallbackToCSSBees();
                    return;
                }
                
                if (typeof THREE.OBJLoader === 'undefined' || typeof THREE.MTLLoader === 'undefined') {
                    console.error('❌ OBJLoader or MTLLoader not available');
                    this.hideLoader();
                    this.fallbackToCSSBees();
                    return;
                }
                
                if (!this.canvas || this.isReducedMotion) {
                    console.log('3D Bees disabled: reduced motion or no canvas');
                    this.hideLoader();
                    this.fallbackToCSSBees();
                    return;
                }

                console.log('✨ 3D Scene initialized');
                this.updateLoader(10, 'Loading mascot resources...');
                this.setupScene();
                this.updateLoader(20, 'Preparing mascot bee...');
                
                // Call async loadBeeModels properly using IIFE
                (async () => {
                    try {
                        await this.loadBeeModels();
                        this.animate();
                    } catch (error) {
                        console.error('❌ Failed to load bee models:', error);
                        this.hideLoader();
                        this.fallbackToCSSBees();
                    }
                })();
                
                window.addEventListener('resize', () => this.onWindowResize());
            }
            
            updateLoader(percentage, message = 'Loading...') {
                // Use LoadingSystem if available, otherwise fall back to direct DOM manipulation
                if (window.loadingSystem) {
                    // Map MenuBeeSwarm progress (0-100) to remaining 40% (60-100)
                    const mappedProgress = 60 + (percentage * 0.4);
                    window.loadingSystem.updateProgress(mappedProgress, message);
                    
                    // Finish loading when complete
                    if (percentage >= 100) {
                        setTimeout(() => window.loadingSystem.finishLoading(), 500);
                    }
                } else {
                    // Legacy direct DOM manipulation
                    const loader = document.getElementById('honeyLoader');
                    const honeyFill = document.getElementById('honeyFillLoader');
                    const percentText = document.getElementById('loadingPercentage');
                    const loadingText = document.getElementById('loadingText');
                    
                    if (honeyFill && percentText) {
                        honeyFill.style.height = percentage + '%';
                        percentText.textContent = Math.round(percentage) + '%';
                    }
                    
                    if (loadingText && message) {
                        loadingText.textContent = message;
                    }
                    
                    // Hide loader when complete
                    if (percentage >= 100) {
                        setTimeout(() => this.hideLoader(), 500);
                    }
                }
                
                this.loadingProgress = percentage;
            }
            
            hideLoader() {
                const loader = document.getElementById('honeyLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }
                // Stop loading music
                this.stopLoadingMusic();
            }

            playLoadingMusic() {
                try {
                    this.loadingMusicContext = new (window.AudioContext || window.webkitAudioContext)();
                    const ctx = this.loadingMusicContext;
                    
                    // iOS Safari fix: Resume AudioContext on user interaction
                    if (ctx.state === 'suspended') {
                        const resumeAudio = () => {
                            ctx.resume().then(() => {
                                console.log('🎵 Loading music AudioContext resumed for iOS');
                            });
                        };
                        document.addEventListener('touchstart', resumeAudio, { once: true });
                        document.addEventListener('click', resumeAudio, { once: true });
                    }
                    
                    // Create master gain for loading music
                    const masterGain = ctx.createGain();
                    masterGain.connect(ctx.destination);
                    masterGain.gain.value = 0.08; // Gentle volume for loading screen
                    
                    // Fun, cheerful melody in C major pentatonic (kid-friendly scale)
                    // Notes: C, D, E, G, A
                    const melody = [
                        {freq: 261.63, duration: 0.3}, // C4
                        {freq: 293.66, duration: 0.3}, // D4
                        {freq: 329.63, duration: 0.3}, // E4
                        {freq: 392.00, duration: 0.4}, // G4 (hold)
                        {freq: 329.63, duration: 0.2}, // E4
                        {freq: 293.66, duration: 0.2}, // D4
                        {freq: 261.63, duration: 0.4}, // C4 (hold)
                        {freq: 293.66, duration: 0.3}, // D4
                        {freq: 329.63, duration: 0.3}, // E4
                        {freq: 392.00, duration: 0.3}, // G4
                        {freq: 440.00, duration: 0.5}, // A4 (hold longer)
                        {freq: 392.00, duration: 0.3}, // G4
                        {freq: 329.63, duration: 0.3}, // E4
                        {freq: 261.63, duration: 0.6}, // C4 (end phrase)
                    ];
                    
                    const playMelody = () => {
                        let currentTime = ctx.currentTime;
                        
                        melody.forEach((note, i) => {
                            const osc = ctx.createOscillator();
                            const noteGain = ctx.createGain();
                            
                            osc.type = 'sine'; // Gentle sine wave for kid-friendly sound
                            osc.frequency.value = note.freq;
                            
                            // Envelope: gentle attack and release
                            noteGain.gain.setValueAtTime(0, currentTime);
                            noteGain.gain.linearRampToValueAtTime(0.3, currentTime + 0.05); // Attack
                            noteGain.gain.setValueAtTime(0.3, currentTime + note.duration - 0.1);
                            noteGain.gain.linearRampToValueAtTime(0, currentTime + note.duration); // Release
                            
                            osc.connect(noteGain);
                            noteGain.connect(masterGain);
                            
                            osc.start(currentTime);
                            osc.stop(currentTime + note.duration);
                            
                            this.loadingMusicOscillators.push(osc);
                            
                            currentTime += note.duration;
                        });
                        
                        // Loop the melody - schedule next iteration
                        const totalDuration = melody.reduce((sum, note) => sum + note.duration, 0);
                        setTimeout(() => {
                            if (this.loadingProgress < 100) {
                                this.loadingMusicOscillators = []; // Clear old oscillators
                                playMelody(); // Play again
                            }
                        }, totalDuration * 1000);
                    };
                    
                    playMelody();
                    console.log('🎵 Cheerful loading music started!');
                    
                } catch (e) {
                    console.log('Loading music not supported:', e);
                }
            }

            stopLoadingMusic() {
                if (this.loadingMusicContext) {
                    try {
                        // Stop all oscillators
                        this.loadingMusicOscillators.forEach(osc => {
                            try {
                                osc.stop();
                            } catch (e) {
                                // Already stopped
                            }
                        });
                        
                        // Close audio context
                        this.loadingMusicContext.close();
                        this.loadingMusicContext = null;
                        this.loadingMusicOscillators = [];
                        
                        console.log('🎵 Loading music stopped');
                    } catch (e) {
                        console.log('Error stopping loading music:', e);
                    }
                }
            }

            setupScene() {
                // Create scene
                this.scene = new THREE.Scene();
                
                // Create camera
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                this.camera.position.z = 5;
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    alpha: true,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
                directionalLight.position.set(5, 5, 5);
                this.scene.add(directionalLight);
            }

            async loadBeeModels() {
                if (!THREE.OBJLoader || !THREE.MTLLoader) {
                    console.error('❌ OBJLoader or MTLLoader not available on THREE object');
                    this.hideLoader();
                    this.fallbackToCSSBees();
                    return;
                }
                
                console.log('🐝 Initializing 3D bee swarm...');
                this.updateLoader(10, '🐝 Preparing bee models...');
                const mtlLoader = new THREE.MTLLoader();
                const objLoader = new THREE.OBJLoader();
                
                // Set base path for texture loading
                mtlLoader.setPath('/static/3DFiles/LittleBees/NewBees/');
                
                try {
                    // Load Bee Blossom MTL
                    console.log('🐝 Loading Bee Blossom materials...');
                    this.updateLoader(20, '🌸 Loading Bee Blossom materials...');
                    const blossomMaterials = await new Promise((resolve, reject) => {
                        mtlLoader.load(
                            'Bee_Blossom_1015233630_texture.mtl',
                            resolve,
                            undefined,
                            reject
                        );
                    });
                    this.updateLoader(35, '✨ Processing Blossom textures...');
                    blossomMaterials.preload();
                    objLoader.setMaterials(blossomMaterials);
                    
                    // Set base path for OBJ loading
                    objLoader.setPath('/static/3DFiles/LittleBees/NewBees/');
                    
                    // Load Bee Blossom OBJ
                    this.updateLoader(45, '🐝 Loading Bee Blossom model...');
                    this.loadedModels.blossom = await new Promise((resolve, reject) => {
                        objLoader.load(
                            'Bee_Blossom_1015233630_texture.obj',
                            resolve,
                            undefined,
                            reject
                        );
                    });
                    
                    console.log('✅ Bee Blossom loaded');
                    this.updateLoader(55, '✅ Bee Blossom ready!');
                    
                    // Load Bee Smiley MTL
                    console.log('🐝 Loading Bee Smiley materials...');
                    this.updateLoader(60, '😊 Loading Bee Smiley materials...');
                    const smileyMaterials = await new Promise((resolve, reject) => {
                        mtlLoader.load(
                            'Bee_Smiley_1015233733_texture.mtl',
                            resolve,
                            undefined,
                            reject
                        );
                    });
                    this.updateLoader(70, '✨ Processing Smiley textures...');
                    smileyMaterials.preload();
                    
                    const smileyObjLoader = new THREE.OBJLoader();
                    smileyObjLoader.setMaterials(smileyMaterials);
                    
                    // Set base path for Smiley OBJ loading
                    smileyObjLoader.setPath('/static/3DFiles/LittleBees/NewBees/');
                    
                    // Load Bee Smiley OBJ
                    this.updateLoader(80, '🐝 Loading Bee Smiley model...');
                    this.loadedModels.smiley = await new Promise((resolve, reject) => {
                        smileyObjLoader.load(
                            'Bee_Smiley_1015233733_texture.obj',
                            resolve,
                            undefined,
                            reject
                        );
                    });
                    
                    console.log('✅ Bee Smiley loaded');
                    this.updateLoader(90, '✅ Bee Smiley ready!');
                    
                    // Spawn bees after models loaded
                    this.updateLoader(95, '🌟 Creating bee swarm...');
                    this.spawnBees();
                    this.updateLoader(100, '🎉 All bees ready to buzz!');
                    
                } catch (error) {
                    console.error('❌ Error loading 3D bee models:', error);
                    console.log('Falling back to CSS bees...');
                    this.hideLoader();
                    this.fallbackToCSSBees();
                }
            }

            spawnBees() {
                // Fewer bees - subtle and not overwhelming
                const beeCount = window.innerWidth > 1024 ? 3 : 2;  // Reduced: 3 on desktop, 2 on mobile
                
                for (let i = 0; i < beeCount; i++) {
                    const beeType = Math.random() > 0.5 ? 'blossom' : 'smiley';
                    const model = this.loadedModels[beeType];
                    
                    if (!model) continue;
                    
                    // Clone the model
                    const bee = model.clone();
                    
                    // Slightly smaller, more subtle size
                    const scale = 0.12 + Math.random() * 0.06;  // Smaller: 0.12-0.18
                    bee.scale.set(scale, scale, scale);
                    
                    // Random starting position
                    bee.position.x = -10 + Math.random() * 20;
                    bee.position.y = -3 + Math.random() * 6;
                    bee.position.z = -2 + Math.random() * 2;
                    
                    // Random rotation
                    bee.rotation.y = Math.random() * Math.PI * 2;
                    
                    // Animation properties - gentle, playful, kid-friendly
                    bee.userData = {
                        // Wider, lazier circles for peaceful movement
                        circleRadius: 3 + Math.random() * 4,          // Larger radius: 3-7 units (wider circles)
                        circleSpeed: 0.15 + Math.random() * 0.2,      // Much slower: 0.15-0.35 (gentle pace)
                        circlePhase: Math.random() * Math.PI * 2,     // Random starting angle
                        centerX: -6 + Math.random() * 12,             // Centered better
                        centerY: -1 + Math.random() * 2,              // More centered vertically
                        // Very gentle bobbing - barely noticeable
                        bobSpeed: 0.5 + Math.random() * 0.3,          // Very slow bob: 0.5-0.8
                        bobHeight: 0.1 + Math.random() * 0.15,        // Very subtle: 0.1-0.25
                        bobOffset: Math.random() * Math.PI * 2,
                        // Minimal rotation for calm effect
                        rotationSpeed: 0.002 + Math.random() * 0.003, // Very slow rotation
                        tiltAmount: 0.08 + Math.random() * 0.05,      // Gentle tilt: 0.08-0.13
                        // Direction
                        clockwise: Math.random() > 0.5 ? 1 : -1       // Random direction for variety
                    };
                    
                    this.scene.add(bee);
                    this.bees.push(bee);
                    
                    console.log(`🐝 Spawned gentle ${beeType} bee in peaceful circular pattern`);
                }
            }

            animate() {
                if (!this.renderer || !this.scene || !this.camera) return;
                
                requestAnimationFrame(() => this.animate());
                
                // Animate each bee in circular patterns
                this.bees.forEach(bee => {
                    const time = Date.now() * 0.001; // Time in seconds
                    const userData = bee.userData;
                    
                    // Update circular motion phase
                    userData.circlePhase += userData.circleSpeed * userData.clockwise * 0.01;
                    
                    // Calculate position on circle
                    bee.position.x = userData.centerX + 
                        Math.cos(userData.circlePhase) * userData.circleRadius;
                    bee.position.z = Math.sin(userData.circlePhase) * userData.circleRadius * 0.3; // Flatter ellipse
                    
                    // Gentle vertical bobbing while flying in circle
                    bee.position.y = userData.centerY + 
                        Math.sin(time * userData.bobSpeed + userData.bobOffset) * userData.bobHeight;
                    
                    // Rotate bee to face direction of travel
                    // Calculate tangent to circle for natural heading
                    const tangentAngle = userData.circlePhase + (Math.PI / 2) * userData.clockwise;
                    bee.rotation.y = tangentAngle;
                    
                    // Bank/tilt into the turn (like a real bee)
                    bee.rotation.z = -Math.sin(userData.circlePhase) * userData.tiltAmount * userData.clockwise;
                    
                    // Gentle pitch variation (up and down tilt)
                    bee.rotation.x = Math.sin(time * userData.bobSpeed * 0.5) * 0.1;
                    
                    // Keep bees within view bounds (wrap or reset if they drift too far)
                    if (Math.abs(bee.position.x) > 15) {
                        userData.centerX = -8 + Math.random() * 16;
                    }
                    if (Math.abs(bee.position.y) > 8) {
                        userData.centerY = -2 + Math.random() * 4;
                    }
                });
                
                this.renderer.render(this.scene, this.camera);
            }

            onWindowResize() {
                if (!this.camera || !this.renderer) return;
                
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            fallbackToCSSBees() {
                // Create fallback CSS bee container if 3D fails
                const container = document.createElement('div');
                container.id = 'beeSwarm';
                container.className = 'bee-swarm';
                document.body.appendChild(container);
                
                // Use old CSS bee class
                new MenuBeeSwarmCSS('beeSwarm');
            }
        }
        
        // Keep old CSS bee class as fallback
        class MenuBeeSwarmCSS {
            constructor(containerId = 'beeSwarm') {
                this.container = document.getElementById(containerId);
                this.isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                this.bees = [];

                if (!this.container || this.isReducedMotion) {
                    return;
                }

                this.populate();
                window.addEventListener('resize', () => this.populate(true));
            }

            populate(reset = false) {
                if (!this.container) {
                    return;
                }

                const targetCount = window.innerWidth > 1024 ? 6 : 4;

                if (reset) {
                    this.container.innerHTML = '';
                    this.bees = [];
                }

                while (this.bees.length < targetCount) {
                    this.spawnBee();
                }
            }

            spawnBee() {
                if (!this.container) {
                    return;
                }

                const bee = document.createElement('div');
                bee.className = 'bee';
                bee.innerHTML = '<span></span>';

                const top = 10 + Math.random() * 70;
                const left = -15 + Math.random() * 25;
                const flight = 14 + Math.random() * 6;
                const buzzDelay = (Math.random() * 0.6).toFixed(2);

                bee.style.top = `${top}vh`;
                bee.style.left = `${left}vw`;
                bee.style.animationDuration = `${flight}s, 1.6s`;
                bee.style.animationDelay = `${-Math.random() * flight}s, ${buzzDelay}s`;

                bee.addEventListener('animationiteration', event => {
                    if (event.animationName === 'beeFlight') {
                        const newTop = 10 + Math.random() * 70;
                        bee.style.top = `${newTop}vh`;
                    }
                });

                this.container.appendChild(bee);
                this.bees.push(bee);
            }
        }
        
        // Add CSS animations
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes successPulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            @keyframes celebrationBurst {
                0% {
                    transform: translate(0, 0) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--end-x), var(--end-y)) scale(0.3);
                    opacity: 0;
                }
            }
            .ready-to-play {
                animation: readyPulse 2s ease-in-out infinite !important;
            }
            @keyframes readyPulse {
                0%, 100% {
                    box-shadow: 0 10px 25px rgba(46, 204, 113, 0.35);
                }
                50% {
                    box-shadow: 0 15px 35px rgba(46, 204, 113, 0.65), 0 0 30px rgba(250, 255, 189, 0.45);
                }
            }
            @keyframes beeGlow {
                0%, 100% {
                    box-shadow: 0 8px 24px rgba(46, 204, 113, 0.55), 0 0 12px rgba(255, 255, 255, 0.25);
                }
                50% {
                    box-shadow: 0 12px 32px rgba(39, 174, 96, 0.75), 0 0 16px rgba(255, 255, 255, 0.45);
                }
            }
        `;
        document.head.appendChild(animationStyles);
        
        function clearAll() {
            console.log('🔧 clearAll function called');
            
            // First check if there are any words to clear
            fetch('/api/wordbank')
                .then(response => {
                    console.log('Wordbank response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Wordbank data:', data);
                    const wordCount = data.words ? data.words.length : 0;
                    console.log('Word count:', wordCount);
                    
                    if (wordCount === 0) {
                        showErrorMessage('📝 No words to clear! Your word list is already empty.');
                        return;
                    }
                    
                    // Play magical sound
                    if (window.magicalEffects) {
                        window.magicalEffects.playChimeSounds();
                    }
                    
                    // Kid-friendly confirmation with bee theme using custom modal
                    showBeeConfirm({
                        title: '🐝 BEEE CAREFUL! 🐝',
                        message: 
                            `You currently have ${wordCount} word(s) loaded.\n\n` +
                            '🧹 This will permanently clear:\n' +
                            '• Your current word list (all ' + wordCount + ' words)\n' +
                            '• All quiz progress and scores\n' +
                            '• Analytics and history data\n\n' +
                            '❗ This action CANNOT be undone!\n\n' +
                            'Would you like to continue?',
                        confirmText: 'OK',
                        cancelText: 'Cancel'
                    }).then(firstConfirm => {
                        if (!firstConfirm) {
                            console.log('User cancelled first confirmation');
                            return;
                        }
                        
                        // Second confirmation - type to confirm with bee theme using custom modal
                        return showBeePrompt({
                            title: '🐝 BUZZ BUZZ! One more check! 🐝',
                            message: 
                                'To help the bees remember this is really what you want,\n' +
                                'please type the word: DELETE\n\n' +
                                'This will clear all ' + wordCount + ' words from the hive!\n\n' +
                                '(Type DELETE in all caps to confirm)',
                            placeholder: 'Type DELETE here...'
                        });
                    }).then(secondConfirm => {
                        if (secondConfirm !== 'DELETE') {
                            if (secondConfirm !== null) {
                                showErrorMessage('✅ Whew! Your words are safe in the hive! 🐝🍯');
                            }
                            console.log('User did not type DELETE correctly');
                            return;
                        }
                        
                        // User confirmed twice, proceed with deletion
                        showLoadingMessage('🧹 Clearing all word lists and progress...');
                        
                        fetch('/api/clear', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            },
                            body: JSON.stringify({
                                confirmed: true,
                                word_count: wordCount
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            hideLoadingMessage();
                            if (data.ok) {
                                showSuccessMessage('✨ All clean! Ready for your next set of spelling words! 🌟');
                            
                                // Reset UI to initial state - with null checks
                                const wordCountEl = document.getElementById('wordCount');
                                if (wordCountEl) {
                                    wordCountEl.textContent = '0 words loaded';
                                }
                                
                                const startQuizBtn = document.getElementById('startQuiz');
                                if (startQuizBtn) {
                                    startQuizBtn.disabled = true;
                                }
                                
                                // Clear any displayed word lists in the UI
                                const wordListDisplay = document.getElementById('wordListDisplay');
                                if (wordListDisplay) {
                                    wordListDisplay.innerHTML = '';
                                }
                                
                                // Reset analytics if displayed
                                if (window.updateAnalytics) {
                                    window.updateAnalytics();
                                }
                                
                                // Reset any other UI elements
                                const uploaders = document.querySelectorAll('.file-uploader, .text-uploader');
                                uploaders.forEach(uploader => {
                                    if (uploader.querySelector('input[type="file"]')) {
                                        uploader.querySelector('input[type="file"]').value = '';
                                    }
                                    if (uploader.querySelector('textarea')) {
                                        uploader.querySelector('textarea').value = '';
                                    }
                                });
                                
                                // Reload page to refresh state
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                                
                            } else {
                                showErrorMessage('❌ Error: ' + (data.error || data.message || 'Failed to clear data'));
                            }
                        })
                        .catch(error => {
                            hideLoadingMessage();
                            console.error('Clear error:', error);
                            showErrorMessage('❌ Failed to clear data. Please try again.');
                        });
                    }); // End of promise chain (showBeeConfirm -> showBeePrompt)
            })
            .catch(error => {
                console.error('Error checking wordbank:', error);
                showErrorMessage('❌ Could not check word list. Please try again.');
            });
        }
        
    // Export word list functionality
    function exportWordList() {
            console.log('exportWordList called');
            
            // Check if words exist
            fetch('/api/wordbank')
                .then(response => response.json())
                .then(async data => {
                    const wordCount = data.words ? data.words.length : 0;
                    if (wordCount === 0) {
                        showErrorMessage('No words to export! Upload some words first. 📝');
                        return;
                    }
                    
                    // Show format selection
                    const format = await showBeePrompt({
                        title: '📊 Export Format',
                        message: '🍯 Choose your export format:\n\n📋 Type "json" for JSON (recommended)\n📈 Type "csv" for CSV spreadsheet',
                        placeholder: 'json',
                        expectedValue: ''
                    }) || 'json';
                    
                    if (!format) return; // User cancelled
                    
                    const exportFormat = format.toLowerCase().trim();
                    if (exportFormat !== 'json' && exportFormat !== 'csv') {
                        showErrorMessage('Please choose "json" or "csv" format');
                        return;
                    }
                    
                    showLoadingMessage(`📦 Preparing your ${exportFormat.toUpperCase()} export...`);
                    
                    // Download the export file
                    window.location.href = `/api/export?format=${exportFormat}&t=${Date.now()}`;
                    
                    setTimeout(() => {
                        hideLoadingMessage();
                        showSuccessMessage(`✅ Downloaded! Your word list has been saved as .${exportFormat} file 🎉`);
                    }, 1000);
                })
                .catch(error => {
                    showErrorMessage("Couldn't check word list. Please try again! 🤔");
                });
        }
        
        // Import word list functionality
        function importWordList() {
            console.log('importWordList called');
            document.getElementById('importFileInput').click();
        }
        
        function handleImportFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const filename = file.name;
            const ext = filename.substring(filename.lastIndexOf('.')).toLowerCase();
            
            if (ext !== '.json' && ext !== '.csv') {
                showErrorMessage('Please upload a .json or .csv file');
                input.value = ''; // Reset file input
                return;
            }
            
            // Show animated progress indicator
            showFileUploadProgress(filename);
            
            // Simulate progress stages during import
            const progressStages = [
                { percent: 20, message: '📥 Importing file...', detail: 'Reading your word list' },
                { percent: 40, message: '📋 Parsing data...', detail: 'Understanding the format' },
                { percent: 60, message: '� Validating words...', detail: 'Checking word structure' },
                { percent: 80, message: '🐝 Adding to hive...', detail: 'Storing your words' }
            ];
            
            let stageIndex = 0;
            const progressInterval = setInterval(() => {
                if (stageIndex < progressStages.length) {
                    const stage = progressStages[stageIndex];
                    updateFileUploadProgress(stage.percent, stage.message, stage.detail);
                    stageIndex++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 500); // Update every 500ms
            
            const formData = new FormData();
            formData.append('file', file);
            
            // First, initiate the import
            fetch('/api/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Stop simulated progress
                clearInterval(progressInterval);
                
                // Complete animation at 100%
                updateFileUploadProgress(100, '✅ Import complete!', `Loaded ${data.count || 0} words`);
                
                setTimeout(() => {
                    hideFileUploadProgress();
                    input.value = ''; // Reset file input
                
                if (data.ok) {
                    showSuccessMessage(`🎉 ${data.message || 'Successfully imported!'}`);
                    
                    // Enable Start Quiz button IMMEDIATELY (mobile fix)
                    if (data.count > 0) {
                        const btn = document.getElementById('startQuizBtn');
                        btn.disabled = false;
                        btn.removeAttribute('disabled');
                        btn.innerHTML = `🚀 Start Quiz (${data.count} words)`;
                        btn.classList.add('ready-to-play');
                        btn.classList.remove('waiting-to-play');
                        
                        // Force style update for mobile
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                        
                        // Force reflow
                        btn.offsetHeight;
                        
                        // Show quiz-ready notification
                        showQuizReadyNotification(data.count);
                        
                        console.log('✅ Quiz button enabled after import:', {
                            disabled: btn.disabled,
                            hasDisabledAttr: btn.hasAttribute('disabled'),
                            classes: btn.className,
                            wordCount: data.count
                        });
                    }
                    
                        // Then update word count display (redundant but ensures consistency)
                        setTimeout(() => updateWordCount(), 500);
                    } else {
                        showErrorMessage(data.error || 'Import failed. Please check your file format.');
                    }
                }, 500); // Show completion message briefly
            })
            .catch(error => {
                clearInterval(progressInterval);
                hideFileUploadProgress();
                input.value = ''; // Reset file input
                showErrorMessage('Oops! Import failed. Please try again! 🤔');
                console.error('Import error:', error);
            });
        }
        
        // Simple check for existing words on page load (no-cache + cache-buster)
        const initialCacheBuster = Date.now();
        fetch(`/api/wordbank?_=${initialCacheBuster}`, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        })
            .then(response => response.json())
            .then(data => {
                const wordCount = data.words ? data.words.length : 0;
                if (wordCount > 0) {
                    const btn = document.getElementById('startQuizBtn');
                    btn.disabled = false;
                    btn.removeAttribute('disabled');
                    btn.innerHTML = `🚀 Start Quiz (${wordCount} words)`;
                    btn.classList.add('ready-to-play');
                    btn.classList.remove('waiting-to-play');
                    
                    // Force style update (same as upload methods)
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.pointerEvents = 'auto';
                    
                    // Force reflow
                    btn.offsetHeight;
                    
                    console.log('✅ Quiz button enabled on page load:', {
                        disabled: btn.disabled,
                        hasDisabledAttr: btn.hasAttribute('disabled'),
                        classes: btn.className,
                        wordCount: wordCount
                    });
                }
            })
            .catch(error => {
                console.log('Could not check word count:', error);
            });
        
        // Background Music System
        let musicAudioContext = null;
        let musicPlaying = false;
        let musicGainNode = null;
        let musicOscillators = [];
        
        function initBackgroundMusic() {
            try {
                musicAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicGainNode = musicAudioContext.createGain();
                musicGainNode.connect(musicAudioContext.destination);
                musicGainNode.gain.value = 0.15; // Soft background volume
                
                // iOS Safari fix: Resume AudioContext on user interaction
                if (musicAudioContext.state === 'suspended') {
                    const resumeAudio = () => {
                        musicAudioContext.resume().then(() => {
                            console.log('🎵 AudioContext resumed for iOS');
                        });
                        document.removeEventListener('touchstart', resumeAudio);
                        document.removeEventListener('click', resumeAudio);
                    };
                    document.addEventListener('touchstart', resumeAudio, { once: true });
                    document.addEventListener('click', resumeAudio, { once: true });
                }
                
                console.log('🎵 Background music system initialized');
            } catch (e) {
                console.log('Background music not supported');
            }
        }
        
        function playBackgroundMusic() {
            if (!musicAudioContext) initBackgroundMusic();
            if (!musicAudioContext || musicPlaying) return;
            
            musicPlaying = true;
            
            // Simple cheerful melody using C major scale
            const notes = [
                {freq: 261.63, duration: 0.5}, // C
                {freq: 293.66, duration: 0.5}, // D
                {freq: 329.63, duration: 0.5}, // E
                {freq: 349.23, duration: 0.5}, // F
                {freq: 392.00, duration: 1.0}, // G (hold)
                {freq: 349.23, duration: 0.5}, // F
                {freq: 329.63, duration: 0.5}, // E
                {freq: 293.66, duration: 1.0}, // D (hold)
                {freq: 261.63, duration: 0.5}, // C
                {freq: 329.63, duration: 0.5}, // E
                {freq: 392.00, duration: 0.5}, // G
                {freq: 523.25, duration: 1.5}, // High C (hold longer)
            ];
            
            let currentTime = musicAudioContext.currentTime;
            
            function playMelody() {
                if (!musicPlaying) return;
                
                notes.forEach((note, i) => {
                    const osc = musicAudioContext.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(note.freq, currentTime);
                    
                    const noteGain = musicAudioContext.createGain();
                    noteGain.connect(musicGainNode);
                    noteGain.gain.setValueAtTime(0, currentTime);
                    noteGain.gain.linearRampToValueAtTime(0.1, currentTime + 0.05);
                    noteGain.gain.exponentialRampToValueAtTime(0.01, currentTime + note.duration);
                    
                    osc.connect(noteGain);
                    osc.start(currentTime);
                    osc.stop(currentTime + note.duration);
                    
                    currentTime += note.duration;
                });
                
                // Loop the melody with a pause
                const totalDuration = notes.reduce((sum, n) => sum + n.duration, 0);
                setTimeout(playMelody, (totalDuration + 2) * 1000); // 2 second pause between loops
            }
            
            playMelody();
            updateMusicIcon();
        }
        
        function stopBackgroundMusic() {
            musicPlaying = false;
            musicOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            musicOscillators = [];
            updateMusicIcon();
        }
        
        function toggleMusic() {
            if (musicPlaying) {
                stopBackgroundMusic();
            } else {
                playBackgroundMusic();
            }
            
            // Animate button
            const btn = document.getElementById('musicControls');
            btn.style.transform = 'scale(0.9)';
            setTimeout(() => btn.style.transform = 'scale(1)', 200);
        }
        
        function updateMusicIcon() {
            const icon = document.getElementById('musicIcon');
            const btn = document.getElementById('musicControls');
            if (musicPlaying) {
                // Show animated music notes when playing
                icon.innerHTML = `
                    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <span style="position: absolute; animation: floatNote1 1.5s ease-in-out infinite;">♪</span>
                        <span style="position: absolute; animation: floatNote2 1.5s ease-in-out infinite 0.3s;">♫</span>
                        <span style="position: absolute; animation: floatNote3 1.5s ease-in-out infinite 0.6s;">♪</span>
                    </div>
                `;
                btn.style.background = 'linear-gradient(135deg, #FFD93D 0%, #FFA500 100%)';
                btn.style.animation = 'musicPulse 2s ease-in-out infinite';
            } else {
                // Show muted icon when not playing
                icon.innerHTML = '🔇';
                btn.style.background = 'linear-gradient(135deg, #CCCCCC 0%, #999999 100%)';
                btn.style.animation = 'none';
            }
        }
        
        // ✨🐝 MASCOT INTERACTIVE SHOW - Fun animations, sounds, and explosions! 🎉💥
        let mascotShowPlaying = false;
        
        function playMascotShow() {
            // Prevent multiple shows from playing simultaneously
            if (mascotShowPlaying) return;
            mascotShowPlaying = true;
            
            console.log('🎪 Starting mascot show!');
            
            // Update caption
            const caption = document.getElementById('mascotCaption');
            if (caption) {
                caption.textContent = '🎪 Enjoy the show! 🎪';
                caption.style.animation = 'none';
            }
            
            // Get mascot bee (try both possible references)
            const mascot = window.mascotBee || window.mascotBeePreloaded;
            const mascotContainer = document.getElementById('mascotBee3D');
            
            if (!mascot || !mascot.model) {
                console.log('⚠️ Mascot not available for show, using fallback effects');
                playFallbackShow(mascotContainer);
                return;
            }
            
            // Random show sequence
            const showTypes = ['spin', 'bounce', 'figure8', 'explosion', 'combo'];
            const randomShow = showTypes[Math.floor(Math.random() * showTypes.length)];
            
            console.log(`🎭 Playing show type: ${randomShow}`);
            
            // Play sound effects
            playShowSounds(randomShow);
            
            // Create particle effects
            createShowParticles(mascotContainer);
            
            // Execute animation sequence
            switch (randomShow) {
                case 'spin':
                    performSpinShow(mascot);
                    break;
                case 'bounce':
                    performBounceShow(mascot);
                    break;
                case 'figure8':
                    performFigure8Show(mascot);
                    break;
                case 'explosion':
                    performExplosionShow(mascot, mascotContainer);
                    break;
                case 'combo':
                    performComboShow(mascot);
                    break;
            }
            
            // Reset after show (3-5 seconds depending on show type)
            const showDuration = randomShow === 'combo' ? 5000 : 3500;
            setTimeout(() => {
                mascotShowPlaying = false;
                if (caption) {
                    caption.textContent = '✨ Click on me to see what I do! ✨';
                    caption.style.animation = 'gentlePulse 2s ease-in-out infinite';
                }
                console.log('✅ Mascot show complete!');
            }, showDuration);
        }
        
        function performSpinShow(mascot) {
            const model = mascot.model;
            const originalRotation = model.rotation.y;
            let spins = 0;
            const spinSpeed = 0.15;
            
            const spinInterval = setInterval(() => {
                model.rotation.y += spinSpeed;
                if (model.rotation.y >= originalRotation + Math.PI * 2) {
                    spins++;
                    if (spins >= 3) {
                        clearInterval(spinInterval);
                        model.rotation.y = originalRotation;
                    }
                }
            }, 16);
        }
        
        function performBounceShow(mascot) {
            const model = mascot.model;
            const originalY = model.position.y;
            let bounces = 0;
            let time = 0;
            
            const bounceInterval = setInterval(() => {
                time += 0.1;
                model.position.y = originalY + Math.abs(Math.sin(time * 3)) * 0.8;
                
                if (time >= Math.PI * 2) {
                    bounces++;
                    time = 0;
                    if (bounces >= 4) {
                        clearInterval(bounceInterval);
                        model.position.y = originalY;
                    }
                }
            }, 16);
        }
        
        function performFigure8Show(mascot) {
            const model = mascot.model;
            const originalX = model.position.x;
            const originalY = model.position.y;
            let time = 0;
            
            const figure8Interval = setInterval(() => {
                time += 0.05;
                model.position.x = originalX + Math.sin(time) * 0.5;
                model.position.y = originalY + Math.sin(time * 2) * 0.4;
                model.rotation.y += 0.05;
                
                if (time >= Math.PI * 4) {
                    clearInterval(figure8Interval);
                    model.position.x = originalX;
                    model.position.y = originalY;
                }
            }, 16);
        }
        
        function performExplosionShow(mascot, container) {
            // Create massive particle explosion
            const particles = 50;
            const emojis = ['✨', '⭐', '🌟', '💥', '🎉', '🎊', '🐝', '🍯', '💛', '🌈'];
            
            for (let i = 0; i < particles; i++) {
                const particle = document.createElement('div');
                particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                particle.style.cssText = `
                    position: fixed;
                    font-size: ${20 + Math.random() * 30}px;
                    pointer-events: none;
                    z-index: 10000;
                    left: 50%;
                    top: 30%;
                    animation: explosionParticle ${1 + Math.random()}s ease-out forwards;
                `;
                
                const angle = (Math.PI * 2 * i) / particles;
                const distance = 150 + Math.random() * 150;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1500);
            }
            
            // Flash effect
            container.style.filter = 'brightness(2)';
            setTimeout(() => container.style.filter = 'brightness(1)', 100);
        }
        
        function performComboShow(mascot) {
            // Combo of all animations!
            performSpinShow(mascot);
            setTimeout(() => performBounceShow(mascot), 1000);
            setTimeout(() => performFigure8Show(mascot), 2000);
        }
        
        function playFallbackShow(container) {
            // If 3D mascot not available, do fun 2D effects
            container.style.transform = 'scale(1.5) rotate(360deg)';
            container.style.transition = 'all 0.8s ease-in-out';
            
            createShowParticles(container);
            playShowSounds('explosion');
            
            setTimeout(() => {
                container.style.transform = 'scale(1) rotate(0deg)';
                mascotShowPlaying = false;
            }, 3000);
        }
        
        function playShowSounds(showType) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const sounds = [];
                
                // Different sounds for different show types
                const soundSequences = {
                    spin: [262, 330, 392, 523],  // C, E, G, C (ascending)
                    bounce: [392, 330, 392, 330],  // G, E, G, E (bouncy)
                    figure8: [262, 294, 330, 349, 392, 440, 494, 523],  // C major scale
                    explosion: [784, 659, 523],  // G, E, C (descending dramatic)
                    combo: [262, 330, 392, 523, 659, 784]  // Full range
                };
                
                const sequence = soundSequences[showType] || soundSequences.explosion;
                
                sequence.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        
                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        
                        oscillator.start(audioCtx.currentTime);
                        oscillator.stop(audioCtx.currentTime + 0.3);
                    }, index * 150);
                });
            } catch (e) {
                console.log('Sound effects not available:', e);
            }
        }
        
        function createShowParticles(container) {
            const rect = container.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Create sparkles and confetti
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                const isEmoji = Math.random() > 0.5;
                
                if (isEmoji) {
                    particle.textContent = ['✨', '⭐', '💫', '🌟'][Math.floor(Math.random() * 4)];
                    particle.style.fontSize = '20px';
                } else {
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.background = ['#FFD700', '#FF69B4', '#87CEEB', '#98FB98'][Math.floor(Math.random() * 4)];
                    particle.style.borderRadius = '50%';
                }
                
                particle.style.cssText += `
                    position: fixed;
                    left: ${centerX}px;
                    top: ${centerY}px;
                    pointer-events: none;
                    z-index: 9999;
                    animation: showParticle 1.5s ease-out forwards;
                `;
                
                const angle = (Math.PI * 2 * i) / 30;
                const distance = 100 + Math.random() * 100;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1500);
            }
        }
        
        // Add music pulse and note float animations
        const musicStyle = document.createElement('style');
        musicStyle.textContent = `
            @keyframes musicPulse {
                0%, 100% { box-shadow: 0 8px 20px rgba(255, 165, 0, 0.4); }
                50% { box-shadow: 0 8px 30px rgba(255, 165, 0, 0.7), 0 0 20px rgba(255, 193, 7, 0.5); }
            }
            
            @keyframes floatNote1 {
                0%, 100% { 
                    transform: translate(-8px, 5px) scale(0.9);
                    opacity: 0.8;
                }
                50% { 
                    transform: translate(-8px, -5px) scale(1.1);
                    opacity: 1;
                }
            }
            
            @keyframes floatNote2 {
                0%, 100% { 
                    transform: translate(0px, -5px) scale(1);
                    opacity: 0.9;
                }
                50% { 
                    transform: translate(0px, 5px) scale(1.2);
                    opacity: 1;
                }
            }
            
            @keyframes floatNote3 {
                0%, 100% { 
                    transform: translate(8px, 3px) scale(0.85);
                    opacity: 0.7;
                }
                50% { 
                    transform: translate(8px, -3px) scale(1.15);
                    opacity: 1;
                }
            }
            
            @keyframes showParticle {
                0% {
                    transform: translate(0, 0) scale(1) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--tx), var(--ty)) scale(0) rotate(720deg);
                    opacity: 0;
                }
            }
            
            @keyframes explosionParticle {
                0% {
                    transform: translate(-50%, -50%) scale(0) rotate(0deg);
                    opacity: 1;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1.5) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(musicStyle);
        
        // Magical Effects Manager
        class MagicalEffects {
            constructor() {
                this.audioContext = null;
                this.initializeAudio();
                this.createSparkleParticles();
                this.createFairyAnimations();
                this.addMagicalSounds();
            }
            
            initializeAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio context not supported');
                }
            }
            
            createSparkleParticles() {
                const magicBackground = document.querySelector('.magic-background');
                if (!magicBackground) return;
                
                // Create 30 sparkle particles
                for (let i = 0; i < 30; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.animationDelay = Math.random() * 8 + 's';
                    sparkle.style.animationDuration = (6 + Math.random() * 4) + 's';
                    magicBackground.appendChild(sparkle);
                }
            }
            
            createFairyAnimations() {
                const fairyContainer = document.querySelector('.fairy-container');
                if (!fairyContainer) return;
                
                // Create 3 fairy trails
                for (let i = 0; i < 3; i++) {
                    const fairy = document.createElement('div');
                    fairy.className = 'fairy';
                    fairy.style.animationDelay = (i * 5) + 's';
                    fairy.style.top = (20 + Math.random() * 60) + '%';
                    fairyContainer.appendChild(fairy);
                }
            }
            
            playMagicalSound(frequency = 523.25, duration = 0.2, type = 'triangle') {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
            
            playChimeSounds() {
                const notes = [523.25, 659.25, 783.99]; // C, E, G
                notes.forEach((note, i) => {
                    setTimeout(() => this.playMagicalSound(note, 0.3, 'sine'), i * 100);
                });
            }
            
            addMagicalSounds() {
                // Add sound effects to menu options (hover only)
                document.querySelectorAll('.menu-option').forEach(option => {
                    option.addEventListener('mouseenter', () => {
                        this.playMagicalSound(440, 0.15, 'triangle');
                    });
                    
                    // Don't add click listeners here - let onclick handlers work
                });
                
                // Add sound effects to buttons (hover only)
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('mouseenter', () => {
                        if (!btn.disabled) {
                            this.playMagicalSound(659.25, 0.1, 'triangle');
                        }
                    });
                    
                    // Don't add click listeners here - let onclick handlers work
                });
                
                // Add magical hover particles
                this.addHoverParticles();
            }
            
            addHoverParticles() {
                document.querySelectorAll('.menu-option, .action-btn').forEach(element => {
                    element.addEventListener('mouseenter', (e) => {
                        this.createHoverParticles(e.target);
                    });
                });
            }
            
            createHoverParticles(element) {
                const rect = element.getBoundingClientRect();
                const particles = 5;
                
                for (let i = 0; i < particles; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'fixed';
                    particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                    particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                    particle.style.width = '4px';
                    particle.style.height = '4px';
                    particle.style.background = '#FFD700';
                    particle.style.borderRadius = '50%';
                    particle.style.pointerEvents = 'none';
                    particle.style.zIndex = '1000';
                    particle.style.animation = 'particleFloat 1s ease-out forwards';
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 1000);
                }
            }
        }
        
        // Add particle float animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes particleFloat {
                0% {
                    opacity: 1;
                    transform: translateY(0px) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-30px) scale(0.5);
                }
            }
        `;
        document.head.appendChild(style);
        
        // Loading System with Progress Tracking and System Checks
        class LoadingSystem {
            constructor() {
                this.progress = 0;
                this.checks = [];
                this.startTime = Date.now();
            }
            
            updateProgress(percent, status) {
                this.progress = Math.min(percent, 100);
                const fillElement = document.getElementById('honeyFillLoader');
                const percentElement = document.getElementById('loadingPercentage');
                const statusElement = document.getElementById('loadingStatus');
                
                if (fillElement) fillElement.style.height = `${this.progress}%`;
                if (percentElement) percentElement.textContent = `${Math.floor(this.progress)}%`;
                if (statusElement) statusElement.textContent = status;
                
                console.log(`📊 Loading: ${Math.floor(this.progress)}% - ${status}`);
            }

            refreshCheckPercentages() {
                // No longer needed - each check gets its own percentage when completed
            }
            
            addCheck(name, status, icon = '⏳') {
                const checksList = document.getElementById('checksList');
                if (!checksList) return;
                
                const checkId = `check-${this.checks.length}`;
                this.checks.push({ name, status, icon });
                
                const checkEl = document.createElement('div');
                checkEl.id = checkId;
                checkEl.style.cssText = `
                    display: grid;
                    grid-template-columns: 28px 1fr auto 64px;
                    align-items: center;
                    padding: 0.6rem 0.7rem;
                    background: rgba(0, 255, 136, 0.08);
                    border: 1px solid rgba(0, 255, 136, 0.18);
                    border-radius: 8px;
                    transition: background 0.3s ease, border-color 0.3s ease;
                `;
                checkEl.innerHTML = `
                    <span style="font-size: 1.1rem; margin-right: 0.25rem; filter: drop-shadow(0 0 2px rgba(0,255,136,0.6));">${icon}</span>
                    <span style="opacity: 0.95;">${name}</span>
                    <span id="${checkId}-status" style="font-weight: 800; color: #a6ffce; margin-right: 0.5rem;">${status}</span>
                    <span id="${checkId}-pct" style="text-align: right; font-weight: 800; color: #00ff88;">${Math.floor(this.progress)}%</span>
                `;
                checksList.appendChild(checkEl);
                
                return checkId;
            }
            
            updateCheck(checkId, status, icon, percentage = null) {
                const checkEl = document.getElementById(checkId);
                const statusEl = document.getElementById(`${checkId}-status`);
                const pctEl = document.getElementById(`${checkId}-pct`);
                if (!checkEl || !statusEl) return;
                
                checkEl.querySelector('span:first-child').textContent = icon;
                statusEl.textContent = status;
                // Use provided percentage or current progress
                if (pctEl) pctEl.textContent = `${Math.floor(percentage !== null ? percentage : this.progress)}%`;
                
                if (icon === '✅') {
                    checkEl.style.background = 'rgba(0, 255, 136, 0.15)';
                    checkEl.style.borderColor = 'rgba(0, 255, 136, 0.35)';
                } else if (icon === '❌') {
                    checkEl.style.background = 'rgba(255, 64, 64, 0.12)';
                    checkEl.style.borderColor = 'rgba(255, 64, 64, 0.35)';
                }
            }
            
            async runSystemChecks() {
                // Check 1: Three.js Support
                const check1 = this.addCheck('3D Graphics (Three.js)', 'Checking...', '⏳');
                await this.delay(200);
                if (typeof THREE !== 'undefined') {
                    this.updateCheck(check1, 'Ready', '✅', 15);
                    this.updateProgress(15, '✨ 3D graphics engine loaded');
                } else {
                    this.updateCheck(check1, 'Missing', '⚠️', 15);
                    this.updateProgress(15, '⚠️ 3D graphics unavailable');
                }
                
                // Check 2: User Avatar Detection (determine which avatar to load)
                const check2 = this.addCheck('User Avatar', 'Detecting...', '⏳');
                this.updateProgress(20, '� Checking avatar...');
                try {
                    // Check authentication status first
                    const isAuthenticated = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
                    
                    if (isAuthenticated) {
                        // Authenticated user - check for custom avatar
                        if (window.userAvatarLoader) {
                            await window.userAvatarLoader.init();
                            const hasCustomAvatar = window.userAvatarLoader.userAvatar && 
                                                  window.userAvatarLoader.userAvatar.urls;
                            if (hasCustomAvatar) {
                                const avatarName = window.userAvatarLoader.userAvatar.name || 
                                                 window.userAvatarLoader.userAvatar.avatar_id;
                                this.updateCheck(check2, `${avatarName}`, '✅', 30);
                                this.updateProgress(30, `🎨 Will load ${avatarName}`);
                                console.log('✅ Custom avatar detected for authenticated user:', avatarName);
                            } else {
                                this.updateCheck(check2, 'Default Mascot', '⚠️', 30);
                                this.updateProgress(30, '⚠️ Authenticated user missing avatar');
                                console.log('⚠️ Authenticated user has no custom avatar');
                            }
                        } else {
                            this.updateCheck(check2, 'Avatar System Error', '❌', 30);
                            this.updateProgress(30, '❌ Avatar loader not available');
                            console.error('❌ Avatar loader not available for authenticated user');
                        }
                    } else {
                        // Guest user - always use MascotBee
                        this.updateCheck(check2, 'MascotBee (Guest)', '✅', 30);
                        this.updateProgress(30, '� Will load MascotBee for guest');
                        console.log('👋 Guest user detected, will use MascotBee');
                    }
                } catch (error) {
                    console.warn('Avatar detection failed:', error);
                    this.updateCheck(check2, 'Default Mascot', '⚠️', 30);
                    this.updateProgress(30, '🐝 Using fallback');
                }
                
                // Check 3: Web Audio API
                const check3 = this.addCheck('Audio System', 'Checking...', '⏳');
                await this.delay(200);
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    this.updateCheck(check3, 'Ready', '✅', 40);
                    this.updateProgress(40, '🎵 Audio system ready');
                } else {
                    this.updateCheck(check3, 'Unavailable', '❌', 40);
                    this.updateProgress(40, '🔇 Audio unavailable');
                }
                
                // Check 4: Session Storage
                const check4 = this.addCheck('Session Storage', 'Checking...', '⏳');
                await this.delay(200);
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    this.updateCheck(check4, 'Working', '✅', 50);
                    this.updateProgress(50, '💾 Storage available');
                } catch (e) {
                    this.updateCheck(check4, 'Blocked', '⚠️', 50);
                    this.updateProgress(50, '⚠️ Storage limited');
                }
                
                // Check 5: Network Connection
                const check5 = this.addCheck('Network Connection', 'Checking...', '⏳');
                await this.delay(200);
                if (navigator.onLine) {
                    this.updateCheck(check5, 'Online', '✅', 55);
                    this.updateProgress(55, '🌐 Connected');
                } else {
                    this.updateCheck(check5, 'Offline', '⚠️', 55);
                    this.updateProgress(55, '📴 Offline mode');
                }
                
                // Check 6: Speech API (removed from display)
                await this.delay(200);
                this.updateProgress(60, '🎯 Systems ready');
                
                // Check 7: Word List (Session Check)
                const check7 = this.addCheck('Word List', 'Checking...', '⏳');
                await this.delay(200);
                try {
                    const response = await fetch('/api/wordbank', {
                        credentials: 'same-origin',
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    if (data.success && data.count > 0) {
                        this.updateCheck(check7, `${data.count} words ready`, '✅', 65);
                        this.updateProgress(65, `📚 ${data.count} words loaded`);
                    } else {
                        this.updateCheck(check7, 'No words loaded', '⚠️', 65);
                        this.updateProgress(65, '⚠️ Upload word list to start');
                    }
                } catch (e) {
                    this.updateCheck(check7, 'Check failed', '⚠️', 65);
                    this.updateProgress(65, '⚠️ Session check failed');
                    console.error('Session check error:', e);
                }
                
                return true;
            }
            
            async preload3DMascot() {
                // Preload 3D mascot assets early so they're ready when menu appears
                return new Promise(async (resolve, reject) => {
                    try {
                        // Initialize avatar loader early
                        if (window.userAvatarLoader) {
                            await window.userAvatarLoader.init();
                        }
                        
                        // Get avatar options
                        const avatarOptions = window.userAvatarLoader ? 
                            window.userAvatarLoader.getAvatarOptions({
                                width: 250,
                                height: 250,
                                autoRotate: true,
                                enableInteraction: true
                            }) : {
                                width: 250,
                                height: 250,
                                autoRotate: false,
                                enableInteraction: true
                            };
                        
                        // Create hidden container for preloading
                        let preloadContainer = document.getElementById('mascot3DPreload');
                        if (!preloadContainer) {
                            preloadContainer = document.createElement('div');
                            preloadContainer.id = 'mascot3DPreload';
                            preloadContainer.style.cssText = 'position:fixed;top:-9999px;left:-9999px;visibility:hidden;pointer-events:none;';
                            document.body.appendChild(preloadContainer);
                        }
                        
                        // Preload the 3D model
                        if (typeof SmartyBee3D !== 'undefined' && typeof THREE !== 'undefined') {
                            window.mascotBeePreloaded = new SmartyBee3D('mascot3DPreload', avatarOptions);
                            console.log('✅ 3D Mascot preloaded successfully during loading screen');
                            resolve();
                        } else {
                            console.warn('⚠️ 3D libraries not available for preload');
                            resolve(); // Still resolve to not block loading
                        }
                    } catch (error) {
                        console.warn('⚠️ 3D mascot preload failed:', error);
                        resolve(); // Don't reject, use fallback
                    }
                });
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            async finishLoading() {
                const elapsed = Date.now() - this.startTime;
                console.log(`✅ Loading complete in ${elapsed}ms`);
                
                this.updateProgress(100, '🎉 Ready to spell!');
                await this.delay(800);
                
                const loader = document.getElementById('honeyLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                    setTimeout(() => { loader.style.display = 'none'; }, 500);
                }
            }
        }
        
        // Initialize magical effects when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Show loader immediately
            const loader = document.getElementById('honeyLoader');
            if (loader) {
                loader.style.display = 'flex';
                loader.style.opacity = '1';
                loader.style.visibility = 'visible';
            }
            
            // Initialize loading system
            window.loadingSystem = new LoadingSystem();
            window.loadingSystem.updateProgress(5, '🚀 Starting up...');
            
            // Run system checks
            await window.loadingSystem.runSystemChecks();
            
            // 60% complete after system checks, now initialize UI components
            window.loadingSystem.updateProgress(60, '🎨 Initializing interface...');
            
            if (!window.DISABLE_FLOATING_DECOR) {
                window.magicalEffects = new MagicalEffects();
            } else {
                // Ensure any pre-existing containers are hidden if present
                const mb = document.querySelector('.magic-background');
                const fc = document.querySelector('.fairy-container');
                if (mb) mb.style.display = 'none';
                if (fc) fc.style.display = 'none';
            }
            
            // Update Saved Lists badge in the menu
            refreshSavedListsBadge();
            
            // 70% - UI components ready
            window.loadingSystem.updateProgress(70, '✨ Loading effects...');
            
            // Note: Initial wordbank check happens earlier in the code (after handleImportFile)
            // No need to call updateWordCount() here as it causes race conditions
            
            // Check for error parameter in URL (e.g., from /quiz redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const errorType = urlParams.get('error');
            if (errorType === 'no_words') {
                showErrorMessage('⚠️ No words loaded! Please upload a word list before starting the quiz.');
                // Clear the error from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Load saved student name
            const savedName = localStorage.getItem('studentName');
            if (savedName) {
                const nameInput = document.getElementById('studentName');
                if (nameInput) {
                    nameInput.value = savedName;
                    console.log('📝 Loaded student name:', savedName);
                }
            }
            
            // 75% - Preload and validate avatar system
            window.loadingSystem.updateProgress(75, '🔍 Checking avatar system...');
            
            // Initialize avatar loader and run preload validation
            try {
                if (!window.userAvatarLoader) {
                    window.userAvatarLoader = new UserAvatarLoader();
                }
                
                // Run comprehensive avatar system preload
                const preloadResults = await window.userAvatarLoader.preloadAvatarSystem();
                
                // Update progress based on preload results
                if (preloadResults.systemReady) {
                    window.loadingSystem.updateProgress(78, `✅ Avatar system ready (${preloadResults.successfulAvatars}/${preloadResults.totalAvatars} avatars)`);
                    console.log('🎉 Avatar system preload completed successfully');
                } else {
                    window.loadingSystem.updateProgress(78, `⚠️ Avatar system partial (${preloadResults.successfulAvatars}/${preloadResults.totalAvatars} avatars)`);
                    console.warn('⚠️ Avatar system has issues but will continue with fallbacks');
                }
                
                // Store preload results for later use
                window.avatarPreloadResults = preloadResults;
                
                // Update the visual status badge
                setTimeout(() => {
                    if (typeof updateAvatarSystemStatus === 'function') {
                        updateAvatarSystemStatus();
                    }
                }, 100);
                
            } catch (preloadError) {
                console.error('❌ Avatar preload failed:', preloadError);
                window.loadingSystem.updateProgress(78, '❌ Avatar system check failed - using emergency mode');
                
                // Set emergency mode flag
                window.avatarEmergencyMode = true;
            }
            
            // 80% - Load and wait for 3D mascot to fully initialize
            window.loadingSystem.updateProgress(80, '🐝 Loading your bee...');
            
            // Initialize 3D Avatar/Mascot and WAIT for it to complete
            const mascotContainer = document.getElementById('mascotBee3D');
            let avatarLoadSuccess = false;
            
            if (mascotContainer) {
                try {
                    // Try to load the avatar
                    window.loadingSystem.updateProgress(85, '🎨 Loading avatar...');
                    
                    // Prefer using presence of a loaded avatar over auth gating
                    // If the API returned an avatar with URLs, load it regardless of server auth flag
                    const hasCustomAvatar = window.userAvatarLoader && 
                                          window.userAvatarLoader.userAvatar &&
                                          window.userAvatarLoader.userAvatar.urls;
                    
                    if (hasCustomAvatar) {
                        try {
                            await initUserAvatar3D(window.userAvatarLoader.userAvatar);
                            avatarLoadSuccess = true;
                            console.log('✅ Custom avatar loaded successfully:', window.userAvatarLoader.userAvatar.avatar_id);
                            
                            // Update user info display with avatar name
                            updateUserInfoDisplay();
                        } catch (avatarError) {
                            console.error('❌ Custom avatar failed to load:', avatarError);
                            
                            // Show refresh button for manual retry
                            const refreshBtn = document.getElementById('avatarRefreshBtn');
                            if (refreshBtn) {
                                refreshBtn.style.display = 'block';
                            }
                            
                            // Generate enhanced error message using preload results
                            let errorMessage = '🐝 Oops! Your custom avatar couldn\'t load properly.\n\n';
                            
                            // Add preload diagnostics if available
                            if (window.avatarPreloadResults) {
                                const results = window.avatarPreloadResults;
                                errorMessage += `📊 Avatar System Status:\n`;
                                errorMessage += `• Total Avatars: ${results.totalAvatars}\n`;
                                errorMessage += `• Working: ${results.successfulAvatars}\n`;
                                errorMessage += `• Failed: ${results.failedAvatars.length}\n`;
                                errorMessage += `• Fallback System: ${results.fallbackReady ? '✅ Ready' : '❌ Failed'}\n\n`;
                                
                                if (results.failedAvatars.length > 0) {
                                    errorMessage += `❌ Failed Avatars: ${results.failedAvatars.map(f => f.avatar).join(', ')}\n\n`;
                                }
                            }
                            
                            errorMessage += '❓ Would you like to:\n';
                            errorMessage += '• Continue with the default bee avatar?\n';
                            errorMessage += '• Or contact an admin to fix the issue?\n\n';
                            errorMessage += 'Error: ' + (avatarError.message || 'Unknown error');
                            
                            // Show alert during loading screen
                            const userChoice = await showBeeConfirm({
                                title: '⚠️ Avatar Loading Issue',
                                message: errorMessage,
                                confirmText: 'Continue with Default',
                                cancelText: 'Contact Admin'
                            });
                            
                            if (userChoice) {
                                // User chose to continue with default
                                console.log('✅ User chose to use default avatar');
                                await initDefaultMascot();
                                avatarLoadSuccess = true;
                            } else {
                                // User chose to contact admin - redirect to help/contact
                                window.location.href = '/help';
                                return; // Stop loading
                            }
                        }
                    } else {
                        // No avatar returned by API; use MascotBee as default
                        console.log('👋 Using MascotBee (no custom avatar detected)');
                        await initDefaultMascot();
                        avatarLoadSuccess = true;
                        
                        // Update user info display
                        updateUserInfoDisplay();
                    }
                    
                    if (avatarLoadSuccess) {
                        window.loadingSystem.updateProgress(90, '✨ Avatar ready!');
                    }
                } catch (error) {
                    console.error('❌ Avatar system error:', error);
                    window.loadingSystem.updateProgress(90, '⚠️ Using basic fallback...');
                    
                    // Show refresh button for manual retry
                    const refreshBtn = document.getElementById('avatarRefreshBtn');
                    if (refreshBtn) {
                        refreshBtn.style.display = 'block';
                    }
                }
            } else {
                window.loadingSystem.updateProgress(90, '✨ Ready!');
            }
            
            // 95% - Final setup
            window.loadingSystem.updateProgress(95, '🎯 Final touches...');
            
            // Small delay to ensure everything is rendered
            await window.loadingSystem.delay(300);
            
            // 100% - Complete!
            await window.loadingSystem.finishLoading();
            
            // Themed avatar effects system
            function playThemedAvatarEffect(avatarId, container) {
                console.log('🎭 Playing themed effect for:', avatarId);
                
                // Create effect overlay
                const effectOverlay = document.createElement('div');
                effectOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 10;
                    overflow: hidden;
                `;
                container.style.position = 'relative';
                container.appendChild(effectOverlay);
                
                // Remove after animation
                setTimeout(() => effectOverlay.remove(), 3000);
                
                // Avatar-specific effects
                switch(avatarId) {
                    case 'cool-bee':
                        // Sunglasses sparkle
                        createSparkles(effectOverlay, '😎', '#00d4ff');
                        playSound('cool');
                        break;
                    case 'explorer-bee':
                        // Compass spin
                        createSpinningIcon(effectOverlay, '🧭', 1080);
                        playSound('adventure');
                        break;
                    case 'rockstar-bee':
                        // Electric guitar + stage lights
                        createFlashingLights(effectOverlay, ['#ff00ff', '#ff0000', '#ffff00']);
                        createFloatingIcon(effectOverlay, '🎸', 3);
                        playSound('guitar-riff');
                        break;
                    case 'doctor-bee':
                        // Healing particles
                        createHealingParticles(effectOverlay);
                        playSound('healing');
                        break;
                    case 'scientist-bee':
                        // Chemistry bubbles
                        createBubbles(effectOverlay, '⚗️🧪', 10);
                        playSound('bubbling');
                        break;
                    case 'professor-bee':
                        // Flying books
                        createFloatingIcon(effectOverlay, '📚📖', 5);
                        playSound('wise-hmm');
                        break;
                    case 'superhero-bee':
                        // Cape swoosh
                        createSwooshEffect(effectOverlay);
                        playSound('whoosh');
                        break;
                    case 'knight-bee':
                        // Sword slash
                        createSlashEffect(effectOverlay);
                        playSound('sword-clang');
                        break;
                    case 'robot-bee':
                        // Digital glitch
                        createGlitchEffect(container);
                        playSound('robot-beep');
                        break;
                    case 'bee-diva':
                        // Sparkles and stars
                        createSparkles(effectOverlay, '✨⭐💫', '#ff69b4');
                        playSound('fabulous');
                        break;
                    case 'queen-bee':
                        // Crown glow
                        createGlowEffect(effectOverlay, '#ffd700');
                        createFloatingIcon(effectOverlay, '👑', 1);
                        playSound('fanfare');
                        break;
                    case 'sea-bee':
                        // Water splash
                        createWaterSplash(effectOverlay);
                        playSound('ocean-waves');
                        break;
                    case 'biker-bee':
                        // Tire tracks and smoke
                        createSmokeEffect(effectOverlay);
                        playSound('engine-rev');
                        break;
                    case 'builder-bee':
                        // Hammer sparks
                        createSparkles(effectOverlay, '🔨🔧⚙️', '#ff8c00');
                        playSound('hammer');
                        break;
                    case 'brother-bee':
                        // High-five effect
                        createHighFiveEffect(effectOverlay);
                        playSound('yo-bro');
                        break;
                    case 'killer-bee':
                        // Lightning storm
                        createLightningEffect(effectOverlay);
                        playSound('roar');
                        break;
                    case 'anxious-bee':
                        // Thought bubbles
                        createThoughtBubbles(effectOverlay);
                        playSound('nervous-hmm');
                        break;
                    default:
                        // Generic bounce sparkle
                        createSparkles(effectOverlay, '✨', '#ffeb3b');
                        break;
                }
            }
            
            // Effect helper functions
            function createSparkles(container, emoji, color) {
                // Split emoji properly using Array.from to handle multi-byte characters
                const emojiArray = Array.from(emoji);
                for (let i = 0; i < 8; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.textContent = emojiArray[i % emojiArray.length];
                    sparkle.style.cssText = `
                        position: absolute;
                        left: 50%;
                        top: 50%;
                        font-size: 24px;
                        animation: sparkle-${i} 1.5s ease-out;
                    `;
                    container.appendChild(sparkle);
                }
                addKeyframes(`
                    @keyframes sparkle-0 { to { transform: translate(-60px, -60px); opacity: 0; } }
                    @keyframes sparkle-1 { to { transform: translate(60px, -60px); opacity: 0; } }
                    @keyframes sparkle-2 { to { transform: translate(-60px, 60px); opacity: 0; } }
                    @keyframes sparkle-3 { to { transform: translate(60px, 60px); opacity: 0; } }
                    @keyframes sparkle-4 { to { transform: translate(-80px, 0); opacity: 0; } }
                    @keyframes sparkle-5 { to { transform: translate(80px, 0); opacity: 0; } }
                    @keyframes sparkle-6 { to { transform: translate(0, -80px); opacity: 0; } }
                    @keyframes sparkle-7 { to { transform: translate(0, 80px); opacity: 0; } }
                `);
            }
            
            function createFloatingIcon(container, emoji, count) {
                // Split emoji properly using Array.from to handle multi-byte characters
                const emojiArray = Array.from(emoji);
                for (let i = 0; i < count; i++) {
                    const icon = document.createElement('div');
                    icon.textContent = emojiArray[i % emojiArray.length];
                    icon.style.cssText = `
                        position: absolute;
                        left: ${20 + Math.random() * 60}%;
                        top: 100%;
                        font-size: ${20 + Math.random() * 20}px;
                        animation: float-up ${2 + Math.random()}s ease-out ${i * 0.2}s;
                    `;
                    container.appendChild(icon);
                }
                addKeyframes(`
                    @keyframes float-up {
                        to { transform: translateY(-300px) rotate(${Math.random() * 360}deg); opacity: 0; }
                    }
                `);
            }
            
            function createSpinningIcon(container, emoji, degrees) {
                const icon = document.createElement('div');
                icon.textContent = emoji;
                icon.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 48px;
                    animation: spin-icon 1.5s ease-in-out;
                `;
                container.appendChild(icon);
                addKeyframes(`@keyframes spin-icon { to { transform: translate(-50%, -50%) rotate(${degrees}deg) scale(2); opacity: 0; } }`);
            }
            
            function createFlashingLights(container, colors) {
                for (let i = 0; i < 6; i++) {
                    const light = document.createElement('div');
                    light.style.cssText = `
                        position: absolute;
                        left: ${i * 20}%;
                        top: -20%;
                        width: 40px;
                        height: 200px;
                        background: linear-gradient(to bottom, ${colors[i % colors.length]} 0%, transparent 100%);
                        animation: flash-light 0.5s infinite alternate;
                        animation-delay: ${i * 0.1}s;
                    `;
                    container.appendChild(light);
                }
                addKeyframes(`@keyframes flash-light { to { opacity: 0.3; } }`);
            }
            
            function createHealingParticles(container) {
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.textContent = '✚';
                    particle.style.cssText = `
                        position: absolute;
                        left: ${Math.random() * 100}%;
                        top: 100%;
                        color: #00ff00;
                        font-size: 16px;
                        animation: heal-rise ${1 + Math.random()}s ease-out ${Math.random() * 0.5}s;
                    `;
                    container.appendChild(particle);
                }
                addKeyframes(`@keyframes heal-rise { to { transform: translateY(-250px); opacity: 0; } }`);
            }
            
            function createBubbles(container, emoji, count) {
                // Split emoji properly using Array.from to handle multi-byte characters
                const emojiArray = Array.from(emoji);
                for (let i = 0; i < count; i++) {
                    const bubble = document.createElement('div');
                    bubble.textContent = emojiArray[i % emojiArray.length];
                    bubble.style.cssText = `
                        position: absolute;
                        left: ${Math.random() * 100}%;
                        top: 100%;
                        font-size: ${12 + Math.random() * 20}px;
                        animation: bubble-rise ${2 + Math.random() * 2}s ease-in-out ${Math.random() * 0.5}s;
                    `;
                    container.appendChild(bubble);
                }
                addKeyframes(`
                    @keyframes bubble-rise {
                        to { transform: translateY(-300px) translateX(${Math.random() * 40 - 20}px); opacity: 0; }
                    }
                `);
            }
            
            function createSwooshEffect(container) {
                const swoosh = document.createElement('div');
                swoosh.style.cssText = `
                    position: absolute;
                    left: -100%;
                    top: 50%;
                    width: 200%;
                    height: 4px;
                    background: linear-gradient(to right, transparent, #ffeb3b, transparent);
                    animation: swoosh 0.6s ease-out;
                `;
                container.appendChild(swoosh);
                addKeyframes(`@keyframes swoosh { to { left: 100%; } }`);
            }
            
            function createSlashEffect(container) {
                const slash = document.createElement('div');
                slash.textContent = '⚔️';
                slash.style.cssText = `
                    position: absolute;
                    left: -10%;
                    top: 10%;
                    font-size: 64px;
                    animation: slash 0.4s ease-out;
                `;
                container.appendChild(slash);
                addKeyframes(`@keyframes slash { to { left: 110%; transform: rotate(360deg); opacity: 0; } }`);
            }
            
            function createGlitchEffect(container) {
                container.style.animation = 'glitch 0.5s';
                setTimeout(() => container.style.animation = '', 500);
                addKeyframes(`
                    @keyframes glitch {
                        0%, 100% { transform: translate(0); filter: none; }
                        20% { transform: translate(-5px, 2px); filter: hue-rotate(90deg); }
                        40% { transform: translate(5px, -2px); filter: hue-rotate(180deg); }
                        60% { transform: translate(-2px, 5px); filter: hue-rotate(270deg); }
                        80% { transform: translate(2px, -5px); filter: hue-rotate(360deg); }
                    }
                `);
            }
            
            function createGlowEffect(container, color) {
                const glow = document.createElement('div');
                glow.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    width: 100%;
                    height: 100%;
                    transform: translate(-50%, -50%);
                    border-radius: 50%;
                    box-shadow: 0 0 60px 30px ${color};
                    animation: glow-pulse 1.5s ease-out;
                `;
                container.appendChild(glow);
                addKeyframes(`@keyframes glow-pulse { to { transform: translate(-50%, -50%) scale(2); opacity: 0; } }`);
            }
            
            function createWaterSplash(container) {
                for (let i = 0; i < 12; i++) {
                    const drop = document.createElement('div');
                    drop.textContent = '💧';
                    drop.style.cssText = `
                        position: absolute;
                        left: 50%;
                        top: 50%;
                        font-size: 20px;
                        animation: splash-${i} 1s ease-out;
                    `;
                    container.appendChild(drop);
                }
                addKeyframes(`
                    @keyframes splash-0 { to { transform: translate(-60px, -80px); opacity: 0; } }
                    @keyframes splash-1 { to { transform: translate(60px, -80px); opacity: 0; } }
                    @keyframes splash-2 { to { transform: translate(-80px, -40px); opacity: 0; } }
                    @keyframes splash-3 { to { transform: translate(80px, -40px); opacity: 0; } }
                    @keyframes splash-4 { to { transform: translate(-90px, 0); opacity: 0; } }
                    @keyframes splash-5 { to { transform: translate(90px, 0); opacity: 0; } }
                `);
            }
            
            function createSmokeEffect(container) {
                for (let i = 0; i < 6; i++) {
                    const smoke = document.createElement('div');
                    smoke.textContent = '💨';
                    smoke.style.cssText = `
                        position: absolute;
                        left: ${10 + i * 15}%;
                        top: 70%;
                        font-size: 28px;
                        opacity: 0.7;
                        animation: smoke-drift ${1 + Math.random()}s ease-out ${i * 0.1}s;
                    `;
                    container.appendChild(smoke);
                }
                addKeyframes(`@keyframes smoke-drift { to { transform: translateX(100px) scale(2); opacity: 0; } }`);
            }
            
            function createHighFiveEffect(container) {
                const hand = document.createElement('div');
                hand.textContent = '✋';
                hand.style.cssText = `
                    position: absolute;
                    right: -50px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 48px;
                    animation: high-five 0.6s ease-out;
                `;
                container.appendChild(hand);
                
                const impact = document.createElement('div');
                impact.textContent = '💥';
                impact.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%) scale(0);
                    font-size: 48px;
                    animation: impact 0.4s ease-out 0.3s;
                `;
                container.appendChild(impact);
                
                addKeyframes(`
                    @keyframes high-five { to { right: 50%; opacity: 0; } }
                    @keyframes impact { to { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
                `);
            }
            
            function createLightningEffect(container) {
                for (let i = 0; i < 4; i++) {
                    const bolt = document.createElement('div');
                    bolt.textContent = '⚡';
                    bolt.style.cssText = `
                        position: absolute;
                        left: ${20 + i * 20}%;
                        top: -20%;
                        font-size: 42px;
                        color: #ffeb3b;
                        animation: lightning-strike 0.3s ease-in ${i * 0.15}s;
                    `;
                    container.appendChild(bolt);
                }
                addKeyframes(`@keyframes lightning-strike { to { top: 100%; opacity: 0; } }`);
            }
            
            function createThoughtBubbles(container) {
                const thoughts = ['💭', '🤔', '...', '?'];
                for (let i = 0; i < 4; i++) {
                    const bubble = document.createElement('div');
                    bubble.textContent = thoughts[i];
                    bubble.style.cssText = `
                        position: absolute;
                        left: ${30 + i * 15}%;
                        top: ${60 - i * 20}%;
                        font-size: ${16 + i * 4}px;
                        animation: thought-rise 2s ease-out ${i * 0.3}s;
                    `;
                    container.appendChild(bubble);
                }
                addKeyframes(`@keyframes thought-rise { to { transform: translateY(-80px); opacity: 0; } }`);
            }
            
            function addKeyframes(css) {
                const styleId = 'themed-effects-styles';
                let style = document.getElementById(styleId);
                if (!style) {
                    style = document.createElement('style');
                    style.id = styleId;
                    document.head.appendChild(style);
                }
                style.textContent += css;
            }
            
            function playSound(soundType) {
                // Sound playback - will use Web Audio API or Audio elements
                // Note: Sound files are optional - effects work without them
                try {
                    const audio = new Audio(`/static/sounds/${soundType}.mp3`);
                    audio.volume = 0.3;
                    
                    // Silently fail if sound file doesn't exist
                    audio.addEventListener('error', () => {
                        // Sound file not found - this is OK, effects still work visually
                    }, { once: true });
                    
                    audio.play().catch(e => {
                        // Sound play blocked by browser or file missing - ignore silently
                    });
                } catch(e) {
                    // Sound not available - ignore silently
                }
            }
            
            function initUserAvatar3D(avatar) {
                // Load user's custom 3D avatar - returns promise for validation
                return new Promise((resolveAvatar, rejectAvatar) => {
                    const container = document.getElementById('mascotBee3D');
                    if (!container) {
                        rejectAvatar(new Error('Container not found'));
                        return;
                    }
                    
                    try {
                        // Create Three.js scene for user avatar
                        const scene = new THREE.Scene();
                        const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
                        
                        // Enhanced camera positioning for optimal avatar visibility
                        camera.position.set(0, 1.2, 3.2);
                        camera.lookAt(new THREE.Vector3(0, 0.8, 0));
                        
                        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                        renderer.setSize(250, 250);
                        renderer.setClearColor(0x000000, 0); // Fully transparent background
                        
                        // Configure container and canvas for proper layering
                        container.style.position = 'relative';
                        container.style.zIndex = '10';
                        container.style.overflow = 'visible';
                        
                        // Configure the canvas element
                        const canvas = renderer.domElement;
                        canvas.style.position = 'absolute';
                        canvas.style.top = '0';
                        canvas.style.left = '50%';
                        canvas.style.transform = 'translateX(-50%)';
                        canvas.style.pointerEvents = 'none'; // Allow clicks through to UI
                        canvas.style.zIndex = '10';
                        
                        container.appendChild(canvas);
                        
                        // Lighting
                        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                        scene.add(ambientLight);
                        
                        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                        directionalLight.position.set(5, 5, 5);
                        scene.add(directionalLight);
                    
                    // Load user's avatar OBJ model with proper URL handling
                    const mtlLoader = new THREE.MTLLoader();
                    
                    // Get full MTL URL and extract base path for textures
                    const mtlUrl = avatar.urls.model_mtl;
                    const objUrl = avatar.urls.model_obj;
                    
                    // Extract directory path (everything before the last slash)
                    const basePath = mtlUrl.substring(0, mtlUrl.lastIndexOf('/') + 1);
                    
                    // Extract just the filenames
                    const mtlFilename = mtlUrl.substring(mtlUrl.lastIndexOf('/') + 1);
                    const objFilename = objUrl.substring(objUrl.lastIndexOf('/') + 1);
                    
                    console.log('🎨 Avatar loading config:');
                    console.log('  - Base path:', basePath);
                    console.log('  - MTL file:', mtlFilename);
                    console.log('  - OBJ file:', objFilename);
                    console.log('  - Avatar ID:', avatar.avatar_id);
                    console.log('  - Avatar.id:', avatar.id);
                    console.log('  - Avatar Name:', avatar.name);
                    console.log('  - Full avatar object:', avatar);
                    console.log('  - Full MTL URL:', mtlUrl);
                    console.log('  - Full OBJ URL:', objUrl);
                    
                    // Set the base path for texture resolution - critical for proper loading!
                    mtlLoader.setPath(basePath);
                    
                    // Set texture path as well (for older MTLLoader versions)
                    if (mtlLoader.setTexturePath) {
                        mtlLoader.setTexturePath(basePath);
                    }
                    
                    // Set resource path for better texture handling
                    if (mtlLoader.setResourcePath) {
                        mtlLoader.setResourcePath(basePath);
                    }
                    
                    console.log('🎨 MTL Loader configured with base path:', basePath);
                    
                    mtlLoader.load(
                        mtlFilename,
                        (materials) => {
                            console.log('✅ Materials loaded successfully for', avatar.avatar_id || avatar.id);
                            console.log('📦 Materials object:', materials);
                            window.loadingSystem?.updateProgress(88, '🎨 Textures loaded...');
                            materials.preload();
                            
                            const objLoader = new THREE.OBJLoader();
                            objLoader.setMaterials(materials);
                            objLoader.setPath(basePath);
                            
                            console.log('🐝 Loading OBJ model with materials...');
                            window.loadingSystem?.updateProgress(90, '🐝 Building 3D model...');
                            
                            objLoader.load(objFilename, (object) => {
                            // Enhanced object positioning and scaling for visibility
                            
                            // Disable shadows for performance
                            object.traverse((child) => { 
                                if (child.isMesh) { 
                                    child.castShadow = false;
                                    child.receiveShadow = false;
                                } 
                            });
                            
                            // Professional centering and scaling
                            const box = new THREE.Box3().setFromObject(object);
                            const size = box.getSize(new THREE.Vector3()).length();
                            const center = box.getCenter(new THREE.Vector3());
                            
                            // Center at origin
                            object.position.sub(center);
                            
                            // Scale to consistent size (tune for visibility)
                            const targetSize = 2.5;  // Increased for better visibility
                            object.scale.setScalar(targetSize / size);
                            
                            scene.add(object);
                            
                            // Static rendering - no auto-animation
                            let isAnimating = false;
                            let animationStartTime = 0;
                            const ANIMATION_DURATION = 800; // ms
                            
                            function render() {
                                requestAnimationFrame(render);
                                
                                if (isAnimating) {
                                    const elapsed = Date.now() - animationStartTime;
                                    const progress = Math.min(elapsed / ANIMATION_DURATION, 1);
                                    
                                    // Bounce animation
                                    object.rotation.y = Math.sin(progress * Math.PI * 2) * 0.3;
                                    object.position.y = Math.abs(Math.sin(progress * Math.PI * 4)) * 0.5;
                                    
                                    if (progress >= 1) {
                                        // Reset to neutral position
                                        isAnimating = false;
                                        object.rotation.y = 0;
                                        object.position.y = 0;
                                    }
                                }
                                
                                renderer.render(scene, camera);
                            }
                            render();
                            
                            // Click handler for themed animation
                            container.style.cursor = 'pointer';
                            container.addEventListener('click', () => {
                                if (!isAnimating) {
                                    isAnimating = true;
                                    animationStartTime = Date.now();
                                    console.log('🐝 Avatar clicked - playing themed animation');
                                    
                                    // Play themed effect based on avatar type (use avatar_id from avatar object)
                                    const avatarId = avatar.avatar_id || avatar.id || 'cool-bee';
                                    console.log('🎭 Using avatar ID for effect:', avatarId);
                                    playThemedAvatarEffect(avatarId, container);
                                }
                            });
                            
                            console.log('✨ User avatar loaded on menu:', avatar.name);
                            resolveAvatar(true);
                        }, 
                        // Progress callback for OBJ loading
                        (xhr) => {
                            if (xhr.lengthComputable) {
                                const percentComplete = (xhr.loaded / xhr.total) * 100;
                                const displayPercent = Math.floor(percentComplete);
                                console.log('📦 Model loading:', displayPercent + '%');
                                // Update loading screen with actual progress
                                window.loadingSystem?.updateProgress(
                                    90 + (displayPercent * 0.05), // Map 0-100% to 90-95%
                                    `🐝 Loading model: ${displayPercent}%`
                                );
                            }
                        },
                        // Error callback
                        (error) => {
                            console.error('❌ Error loading OBJ model:', error);
                            console.error('   - OBJ URL attempted:', objUrl);
                            console.error('   - Base path:', basePath);
                            console.error('   - OBJ filename:', objFilename);
                            console.error('   - Avatar ID:', avatar.avatar_id || avatar.id);
                            
                            // Try to provide helpful error message
                            if (error.message && error.message.includes('404')) {
                                console.error('🚨 DIAGNOSIS: 404 Not Found - Check if OBJ file exists at:', basePath + objFilename);
                            }
                            
                            rejectAvatar(error);
                        });
                    }, 
                    // Progress callback for MTL (materials/textures)
                    (xhr) => {
                        if (xhr.lengthComputable) {
                            const percentComplete = (xhr.loaded / xhr.total) * 100;
                            const displayPercent = Math.floor(percentComplete);
                            console.log('🎨 Materials loading:', displayPercent + '%');
                            // Update loading screen with texture progress
                            window.loadingSystem?.updateProgress(
                                85 + (displayPercent * 0.03), // Map 0-100% to 85-88%
                                `🎨 Loading textures: ${displayPercent}%`
                            );
                        }
                    },
                    // Error callback for MTL
                    (error) => {
                        console.error('❌ Error loading MTL materials:', error);
                        console.error('   - MTL URL attempted:', mtlUrl);
                        console.error('   - Base path:', basePath);
                        console.error('   - MTL filename:', mtlFilename);
                        console.error('   - Avatar ID:', avatar.avatar_id || avatar.id);
                        
                        // Try to provide helpful error message
                        if (error.message && error.message.includes('404')) {
                            console.error('🚨 DIAGNOSIS: 404 Not Found - Check if MTL file exists at:', basePath + mtlFilename);
                        }
                        
                        rejectAvatar(error);
                    });
                    } catch (error) {
                        console.warn('Could not load user avatar 3D:', error);
                        rejectAvatar(error);
                    }
                });
            }
            
            async function initDefaultMascot() {
                // Initialize Mascot Bee with user's selected avatar (or default)
                const container = document.getElementById('mascotBee3D');
                if (!container) return;
                
                // Make sure container is visible
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                
                if (typeof SmartyBee3D !== 'undefined') {
                    try {
                        // Wait for avatar loader to fetch user's avatar
                        await window.userAvatarLoader.init();
                        
                        // Get avatar options from loader - NO auto-rotation or idle animation
                        const avatarOptions = window.userAvatarLoader.getAvatarOptions({
                            width: 250,
                            height: 250,
                            autoRotate: false,
                            enableInteraction: false, // Disable default interactions
                            idleAnimation: false // No auto-animation
                        });
                        
                        window.mascotBee = new SmartyBee3D('mascotBee3D', avatarOptions);
                        
                        // Add click handler for themed animation (≤800ms as requested)
                        container.style.cursor = 'pointer';
                        container.addEventListener('click', () => {
                            if (window.mascotBee && window.mascotBee.playAnimation) {
                                console.log('🐝 Mascot clicked - playing themed animation');
                                window.mascotBee.playAnimation('bounce', { duration: 800 });
                                
                                // Play themed effect based on avatar type
                                const avatarId = window.userAvatarLoader ? 
                                    window.userAvatarLoader.getAvatarId() : 'cool-bee';
                                playThemedAvatarEffect(avatarId, container);
                            }
                        });
                        
                        const avatarId = window.userAvatarLoader.getAvatarId();
                        console.log(`✨ Mascot Bee initialized (static) on menu page with avatar: ${avatarId}`);
                    } catch (error) {
                        console.warn('Could not initialize 3D mascot:', error);
                        // Show fallback emoji bee if 3D fails
                        container.innerHTML = '<div style="font-size: 120px; text-align: center; padding: 50px 0;">🐝</div>';
                    }
                } else {
                    console.warn('3D mascot library not loaded, showing fallback bee');
                    // Show fallback emoji bee if 3D library not loaded
                    container.innerHTML = '<div style="font-size: 120px; text-align: center; padding: 50px 0; animation: bounce 2s infinite;">🐝</div>';
                }
            }
            
            // Avatar Refresh Function
            async function refreshAvatar() {
                const container = document.getElementById('mascotBee3D');
                const refreshBtn = document.getElementById('avatarRefreshBtn');
                
                if (!container) return;
                
                try {
                    console.log('🔄 Manually refreshing avatar...');
                    
                    // Hide refresh button during reload
                    if (refreshBtn) {
                        refreshBtn.style.display = 'none';
                        refreshBtn.disabled = true;
                    }
                    
                    // Clear the container and show loading
                    container.innerHTML = '';
                    if (window.userAvatarLoader) {
                        window.userAvatarLoader.showLoadingState();
                    }
                    
                    // Re-initialize avatar loader
                    if (window.userAvatarLoader) {
                        await window.userAvatarLoader.init();
                    }
                    
                    // Check if user has custom avatar
                    const hasCustomAvatar = window.userAvatarLoader && 
                                          window.userAvatarLoader.userAvatar &&
                                          window.userAvatarLoader.userAvatar.urls;
                    
                    if (hasCustomAvatar) {
                        await initUserAvatar3D(window.userAvatarLoader.userAvatar);
                        console.log('✅ Avatar refreshed successfully');
                        if (window.userAvatarLoader) {
                            window.userAvatarLoader.showLoadedState();
                        }
                    } else {
                        await initDefaultMascot();
                        console.log('✅ Default mascot refreshed');
                        if (window.userAvatarLoader) {
                            window.userAvatarLoader.showLoadedState();
                        }
                    }
                } catch (error) {
                    console.error('❌ Avatar refresh failed:', error);
                    if (window.userAvatarLoader) {
                        window.userAvatarLoader.showErrorState('mascotBee3D', error);
                    }
                    container.innerHTML = '<div style="font-size: 100px; text-align: center; padding: 25px 0;">🐝</div>';
                    if (refreshBtn) {
                        refreshBtn.style.display = 'block';
                    }
                } finally {
                    if (refreshBtn) refreshBtn.disabled = false;
                }
            }
            
            // Mobile Touch Event Enhancement
            // Add touch support for all onclick elements
            if ('ontouchstart' in window) {
                console.log('📱 Mobile device detected - enhancing touch events');
                
                // Prevent double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
                
                // Add active state for buttons on touch
                document.addEventListener('touchstart', function(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('menu-option')) {
                        e.target.style.opacity = '0.7';
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', function(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('menu-option')) {
                        setTimeout(() => {
                            e.target.style.opacity = '';
                        }, 150);
                    }
                }, { passive: true });
                
                // Fix for iOS Safari button click delay
                document.addEventListener('touchstart', function() {}, { passive: true });
            }
            
            // Avatar Loading Monitor
            function monitorAvatarLoading() {
                const container = document.getElementById('mascotBee3D');
                const refreshBtn = document.getElementById('avatarRefreshBtn');
                
                if (!container) return;
                
                // Set up MutationObserver to watch for class changes
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const classList = container.classList;
                            
                            if (classList.contains('avatar-error')) {
                                console.log('🚨 Avatar error detected - showing refresh button');
                                if (refreshBtn) {
                                    refreshBtn.style.display = 'block';
                                }
                            } else if (classList.contains('avatar-loaded')) {
                                console.log('✅ Avatar loaded successfully - hiding refresh button');
                                if (refreshBtn) {
                                    refreshBtn.style.display = 'none';
                                }
                            }
                        }
                    });
                });
                
                // Start observing
                observer.observe(container, {
                    attributes: true,
                    attributeFilter: ['class']
                });
                
                console.log('👁️ Avatar loading monitor started');
            }
            
            // Start monitoring when page loads
            monitorAvatarLoading();
        });
        
        // 🎪 Interactive Mascot Show - Spin, Bounce, Fly, and Explode!
        function playMascotShow() {
            const mascot = document.getElementById('mascotBee3D');
            const caption = document.getElementById('mascotCaption');
            
            if (!mascot) return;
            
            console.log('🎪 Starting mascot show!');

            // Themed FX: enable background decor briefly and pop/glow the bee
            document.body.classList.add('fx-enabled');
            setTimeout(() => document.body.classList.remove('fx-enabled'), 1600);
            mascot.classList.add('bee-pop', 'bee-glow');
            if (typeof createBeeBursts === 'function') {
                createBeeBursts(mascot, 14);
            }
            setTimeout(() => mascot.classList.remove('bee-pop'), 900);
            setTimeout(() => mascot.classList.remove('bee-glow'), 1400);
            
            // Hide caption during show
            if (caption) {
                caption.style.opacity = '0';
            }
            
            // Random animation sequence
            const animations = ['spin', 'bounce', 'fly', 'explode', 'dance'];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            
            console.log('🎭 Playing animation:', randomAnimation);
            
            // Play sound effect
            playMascotSound(randomAnimation);
            
            // Execute animation
            switch(randomAnimation) {
                case 'spin':
                    performSpin(mascot);
                    break;
                case 'bounce':
                    performBounce(mascot);
                    break;
                case 'fly':
                    performFly(mascot);
                    break;
                case 'explode':
                    performExplosion(mascot);
                    break;
                case 'dance':
                    performDance(mascot);
                    break;
            }
            
            // Show caption again after animation
            setTimeout(() => {
                if (caption) {
                    caption.style.opacity = '0.8';
                }
            }, 3000);
        }

        // Deterministic combo when clicking the caption: bounce then spin
        function playMascotCaptionCombo() {
            const mascot = document.getElementById('mascotBee3D');
            const caption = document.getElementById('mascotCaption');
            if (!mascot) return;

            // Theme FX
            document.body.classList.add('fx-enabled');
            setTimeout(() => document.body.classList.remove('fx-enabled'), 1600);
            mascot.classList.add('bee-pop', 'bee-glow');
            if (typeof createBeeBursts === 'function') createBeeBursts(mascot, 14);
            setTimeout(() => mascot.classList.remove('bee-pop'), 900);
            setTimeout(() => mascot.classList.remove('bee-glow'), 1400);

            // Caption pulse feedback
            if (caption) {
                caption.classList.add('caption-highlight');
                setTimeout(() => caption.classList.remove('caption-highlight'), 700);
            }

            // Play bounce then spin
            performBounce(mascot);
            setTimeout(() => performSpin(mascot), 1000);

            // Optional sound
            try { playMascotSound('bounce'); setTimeout(() => playMascotSound('spin'), 800); } catch (e) {}
        }
        
        // Animation: Spinning mascot
        function performSpin(mascot) {
            mascot.style.animation = 'mascotSpin 1.5s ease-in-out';
            setTimeout(() => {
                mascot.style.animation = '';
            }, 1500);
        }
        
        // Animation: Bouncing mascot
        function performBounce(mascot) {
            mascot.style.animation = 'mascotBounce 1s ease-in-out 3';
            setTimeout(() => {
                mascot.style.animation = '';
            }, 3000);
        }
        
        // Animation: Flying around
        function performFly(mascot) {
            mascot.style.animation = 'mascotFly 2.5s ease-in-out';
            setTimeout(() => {
                mascot.style.animation = '';
            }, 2500);
        }
        
        // Animation: Explosion effect with particles
        function performExplosion(mascot) {
            // Create explosion particles
            createExplosionParticles(mascot);
            
            // Shake mascot
            mascot.style.animation = 'mascotShake 0.5s ease-in-out';
            setTimeout(() => {
                mascot.style.animation = '';
            }, 500);
        }
        
        // Animation: Dance moves
        function performDance(mascot) {
            mascot.style.animation = 'mascotDance 2s ease-in-out';
            setTimeout(() => {
                mascot.style.animation = '';
            }, 2000);
        }
        
        // Create explosion particles around mascot
        function createExplosionParticles(mascot) {
            const rect = mascot.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const particles = 30;
            const emojis = ['🐝', '✨', '⭐', '💥', '🌟', '💛', '🍯', '🎉'];
            
            for (let i = 0; i < particles; i++) {
                const particle = document.createElement('div');
                const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                
                particle.textContent = emoji;
                particle.style.cssText = `
                    position: fixed;
                    left: ${centerX}px;
                    top: ${centerY}px;
                    font-size: ${20 + Math.random() * 20}px;
                    pointer-events: none;
                    z-index: 10000;
                `;
                
                document.body.appendChild(particle);
                
                // Animate particle
                const angle = (Math.PI * 2 * i) / particles;
                const velocity = 150 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.animate([
                    { transform: 'translate(0, 0) scale(1) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0.3) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 500,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                });
                
                // Remove after animation
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }
        }

        // Create short-lived burst sparkles tightly around mascot
        function createBeeBursts(container, count = 12) {
            try {
                for (let i = 0; i < count; i++) {
                    const s = document.createElement('span');
                    const colors = ['pink', 'blue', 'orange'];
                    s.className = 'bee-burst ' + colors[i % colors.length];
                    const angle = (i / count) * Math.PI * 2;
                    const radius = 80 + Math.random() * 40;
                    s.style.setProperty('--dx', Math.cos(angle) * radius + 'px');
                    s.style.setProperty('--dy', Math.sin(angle) * radius + 'px');
                    container.appendChild(s);
                    setTimeout(() => s.remove(), 950);
                }
            } catch (e) { console.warn('bee bursts error', e); }
        }
        
        // Play sound effects for mascot animations
        function playMascotSound(animationType) {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Resume context if suspended (iOS fix)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.value = 0.3;
                
                let notes = [];
                
                switch(animationType) {
                    case 'spin':
                        // Ascending spiral sound
                        notes = [
                            {freq: 261.63, time: 0, duration: 0.1},      // C
                            {freq: 329.63, time: 0.1, duration: 0.1},    // E
                            {freq: 392.00, time: 0.2, duration: 0.1},    // G
                            {freq: 523.25, time: 0.3, duration: 0.2}     // C (high)
                        ];
                        break;
                    case 'bounce':
                        // Bouncy sound
                        notes = [
                            {freq: 392.00, time: 0, duration: 0.15},
                            {freq: 392.00, time: 0.3, duration: 0.15},
                            {freq: 392.00, time: 0.6, duration: 0.15}
                        ];
                        break;
                    case 'fly':
                        // Swooshing sound
                        notes = [
                            {freq: 220.00, time: 0, duration: 0.3},
                            {freq: 440.00, time: 0.2, duration: 0.3},
                            {freq: 880.00, time: 0.4, duration: 0.3}
                        ];
                        break;
                    case 'explode':
                        // Explosion sound
                        notes = [
                            {freq: 100, time: 0, duration: 0.1},
                            {freq: 80, time: 0.05, duration: 0.15},
                            {freq: 60, time: 0.1, duration: 0.2}
                        ];
                        break;
                    case 'dance':
                        // Funky dance beat
                        notes = [
                            {freq: 261.63, time: 0, duration: 0.2},
                            {freq: 329.63, time: 0.2, duration: 0.2},
                            {freq: 392.00, time: 0.4, duration: 0.2},
                            {freq: 329.63, time: 0.6, duration: 0.2}
                        ];
                        break;
                }
                
                // Play notes
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const noteGain = audioContext.createGain();
                    
                    oscillator.type = animationType === 'explode' ? 'sawtooth' : 'sine';
                    oscillator.frequency.value = note.freq;
                    
                    noteGain.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    noteGain.gain.linearRampToValueAtTime(1, audioContext.currentTime + note.time + 0.01);
                    noteGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + note.duration);
                    
                    oscillator.connect(noteGain);
                    noteGain.connect(masterGain);
                    
                    oscillator.start(audioContext.currentTime + note.time);
                    oscillator.stop(audioContext.currentTime + note.time + note.duration);
                });
                
            } catch (e) {
                console.log('Sound playback not available:', e);
            }
        }
        
        // Add animation keyframes to page
        const mascotAnimations = document.createElement('style');
        mascotAnimations.textContent = `
            @keyframes mascotSpin {
                0% { transform: translateY(-10px) rotate(0deg) scale(1); }
                50% { transform: translateY(-30px) rotate(360deg) scale(1.2); }
                100% { transform: translateY(-10px) rotate(720deg) scale(1); }
            }
            
            @keyframes mascotBounce {
                0%, 100% { transform: translateY(-10px); }
                50% { transform: translateY(-80px); }
            }
            
            @keyframes mascotFly {
                0% { transform: translate(0, -10px) scale(1); }
                25% { transform: translate(100px, -100px) scale(0.8) rotate(15deg); }
                50% { transform: translate(0, -150px) scale(1.2) rotate(0deg); }
                75% { transform: translate(-100px, -100px) scale(0.8) rotate(-15deg); }
                100% { transform: translate(0, -10px) scale(1) rotate(0deg); }
            }
            
            @keyframes mascotShake {
                0%, 100% { transform: translateY(-10px) translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateY(-10px) translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateY(-10px) translateX(10px); }
            }
            
            @keyframes mascotDance {
                0%, 100% { transform: translateY(-10px) rotate(0deg) scale(1); }
                10% { transform: translateY(-30px) rotate(-10deg) scale(1.1); }
                20% { transform: translateY(-10px) rotate(10deg) scale(1); }
                30% { transform: translateY(-40px) rotate(-15deg) scale(1.15); }
                40% { transform: translateY(-10px) rotate(15deg) scale(1); }
                50% { transform: translateY(-50px) rotate(0deg) scale(1.2); }
                60% { transform: translateY(-10px) rotate(-15deg) scale(1); }
                70% { transform: translateY(-40px) rotate(15deg) scale(1.15); }
                80% { transform: translateY(-10px) rotate(-10deg) scale(1); }
                90% { transform: translateY(-30px) rotate(10deg) scale(1.1); }
            }
        `;
        document.head.appendChild(mascotAnimations);
        
        console.log('✨ Interactive mascot system loaded');

        // Avatar Info Modal (shows name + fun backstory)
        function showAvatarInfoModal() {
            try {
                const loader = window.userAvatarLoader;
                const id = (loader && typeof loader.getAvatarId === 'function') ? loader.getAvatarId() : 'mascot-bee';
                const displayName = (loader && typeof loader.getAvatarDisplayName === 'function') ? loader.getAvatarDisplayName() : 'Bee Avatar';
                const thumb = (loader && typeof loader.getThumbnailUrl === 'function') ? loader.getThumbnailUrl() : '/static/bee.png';

                const BACKSTORIES = {
                    'albee': {
                        title: 'AlBee',
                        tagline: 'Always algebra-ready and alphabetical!',
                        story: 'AlBee arranges letters in perfect order. From A to Z, this bee loves patterns, puzzles, and tidy spelling lines.'
                    },
                    'anxious-bee': {
                        title: 'Anxious Bee',
                        tagline: 'Takes a deep breath—and spells anyway.',
                        story: 'Anxious Bee gets a little wiggly before big words, but bravery is buzzing inside. One letter at a time and—ta-da!—victory.'
                    },
                    'astro-bee': {
                        title: 'Astro Bee',
                        tagline: 'Spelling among the stars.',
                        story: 'Astro Bee rockets through space dictionaries, mapping constellations like “C-A-T” to “C-O-N-S-T-E-L-L-A-T-I-O-N.”'
                    },
                    'biker-bee': {
                        title: 'Biker Bee',
                        tagline: 'Rolls over rough words like a champ.',
                        story: 'With a tiny helmet and roaring “vroom-buzz,” Biker Bee speeds past typos and sticks the landing on tricky endings.'
                    },
                    'brother-bee': {
                        title: 'Brother Bee',
                        tagline: 'Team player of the hive.',
                        story: 'Brother Bee always shares tips and high-fives. When a friend forgets a letter, he’s there with a cheerful nudge.'
                    },
                    'builder-bee': {
                        title: 'Builder Bee',
                        tagline: 'Constructs words one block at a time.',
                        story: 'With a toolbelt full of vowels and consonants, Builder Bee stacks syllables into sturdy spelling skyscrapers.'
                    },
                    'cool-bee': {
                        title: 'Cool Bee',
                        tagline: 'Too chill to miss a silent letter.',
                        story: 'Cool Bee wears shades and keeps it smooth. Whether it’s “knight” or “knowledge,” this bee never breaks a sweat.'
                    },
                    'detective-bee': {
                        title: 'Detective Bee',
                        tagline: 'Solves spelling mysteries with honey-sweet logic!',
                        story: 'Detective Bee carries a tiny magnifying glass and loves to inspect every letter. If there\'s a silent e on the loose, Detective Bee will find it!'
                    },
                    'diva-bee': {
                        title: 'Diva Bee',
                        tagline: 'Big voice, bigger vocabulary.',
                        story: 'Diva Bee loves center stage and dazzling definitions. Every correct word gets a fabulous “Bravo!”'
                    },
                    'doctor-bee': {
                        title: 'Doctor Bee',
                        tagline: 'Fixes sick words and heals typos.',
                        story: 'Doctor Bee prescribes the right letters, adds careful commas, and sends wobbly words home feeling better.'
                    },
                    'explorer-bee': {
                        title: 'Explorer Bee',
                        tagline: 'Adventures through jungle words and desert dictionaries!',
                        story: 'Explorer Bee finds new words in wild places. From “cactus” to “canoe,” this bee loves discovering how words traveled to our hive.'
                    },
                    'frankenbee': {
                        title: 'FrankenBee',
                        tagline: 'Stitches syllables into super words!',
                        story: 'With lightning-bright ideas, FrankenBee assembles prefixes and suffixes into a marvelous masterpiece of spelling.'
                    },
                    'knight-bee': {
                        title: 'Knight Bee',
                        tagline: 'Defender of vowels and vanquisher of typos!',
                        story: 'Clad in shiny armor, Knight Bee protects every vowel order with bravery. Hyphens beware—order in the kingdom of words will be kept!'
                    },
                    'mascot-bee': {
                        title: 'Mascot Bee',
                        tagline: 'Your cheerful coach in the hive!',
                        story: 'Mascot Bee cheers you on, buzz by buzz. When words get tricky, Mascot Bee brings the pep and keeps the hive smiling.'
                    },
                    'monster-bee': {
                        title: 'Monster Bee',
                        tagline: 'Big heart, bigger spelling.',
                        story: 'Monster Bee looks tough but is a gentle giant. Loves long words and friendly roars for every success.'
                    },
                    'professor-bee': {
                        title: 'Professor Bee',
                        tagline: 'Knows the history of every word.',
                        story: 'Professor Bee tells tales of roots and origins—Latin, Greek, and beyond—making every word feel like a mini adventure.'
                    },
                    'queen-bee': {
                        title: 'Queen Bee',
                        tagline: 'Rules the hive with kind letters and fair spelling.',
                        story: 'With a crown that sparkles like a comma in the right place, Queen Bee loves neat handwriting and royal spelling performances.'
                    },
                    'robo-bee': {
                        title: 'Robo Bee',
                        tagline: 'Beep-boop-buzz! Optimized for spelling power.',
                        story: 'Robo Bee scans each word with laser focus. When a letter is missing, Robo Bee beeps a friendly reminder.'
                    },
                    'rocker-bee': {
                        title: 'Rocker Bee',
                        tagline: 'Cranks up the volume on vocabulary.',
                        story: 'With a mini guitar and mega rhythm, Rocker Bee turns spelling practice into a chart-topping hit.'
                    },
                    'seabea': {
                        title: 'SeaBea',
                        tagline: 'Sails the seven C’s (and all the other letters).',
                        story: 'SeaBea charts courses through tricky homophones—there, their, and they’re—like a true captain of words.'
                    },
                    'superbee': {
                        title: 'SuperBee',
                        tagline: 'Up, up, and away with amazing spelling!',
                        story: 'With a swoosh of the cape, SuperBee rescues words in distress and lifts spirits all across the hive.'
                    },
                    'vamp-bee': {
                        title: 'Vamp Bee',
                        tagline: 'A night owl who loves bright ideas.',
                        story: 'Vamp Bee practices in the moonlight and never misses a vowel—especially a, e, i, ooo, and u.'
                    },
                    'ware-bee': {
                        title: 'Ware Bee',
                        tagline: 'Techy and clever with word-ware.',
                        story: 'Ware Bee debugs spelling glitches and keeps every sentence running smooth as honey.'
                    },
                    'zom-bee': {
                        title: 'Zom Bee',
                        tagline: 'Slow and steady… but unstoppable.',
                        story: 'Zom Bee takes it letter by letter. Even the longest words give up and become friends.'
                    }
                };

                const info = BACKSTORIES[id] || {
                    title: displayName,
                    tagline: 'A brave little buzzer with big spelling energy!',
                    story: 'Every avatar in our hive has a special talent. This one helps you focus, practice, and have fun while you master new words.'
                };

                // Build modal
                let modal = document.getElementById('avatarInfoModal');
                if (modal) modal.remove();
                modal = document.createElement('div');
                modal.id = 'avatarInfoModal';
                modal.style.cssText = `
                    position: fixed; inset: 0; z-index: 10040;
                    background: rgba(0,0,0,0.4);
                    display: flex; align-items: center; justify-content: center;
                    padding: 1rem; backdrop-filter: blur(2px);
                `;

                const card = document.createElement('div');
                card.className = 'modal-content';
                card.style.cssText = `
                    width: min(520px, 92vw);
                    background: linear-gradient(135deg, #FFF8E1, #FFE0B2);
                    border: 3px solid rgba(255, 193, 7, 0.6);
                    border-radius: 18px; box-shadow: 0 12px 30px rgba(0,0,0,0.2);
                    overflow: hidden; animation: modalBounceIn 0.45s ease-out;
                `;

                card.innerHTML = `
                    <div style="display:flex; gap:14px; padding:16px; align-items:center; border-bottom: 2px solid rgba(0,0,0,0.05); background: linear-gradient(135deg, #FFD54F, #FFB300); color:#5A2C15;">
                        <img src="${thumb}" alt="${info.title}" style="width:56px;height:56px;border-radius:12px;border:2px solid rgba(255,255,255,0.8);background:#fff;object-fit:cover;"/>
                        <div style="flex:1;">
                            <div style="font-weight:800; font-size:1.1rem;">${info.title}</div>
                            <div style="opacity:0.9; font-weight:600;">${info.tagline}</div>
                        </div>
                        <button id="avatarInfoClose" aria-label="Close" style="background:none;border:none;font-size:22px;color:#5A2C15;cursor:pointer;">×</button>
                    </div>
                    <div style="padding:16px; color:#5A2C15; line-height:1.5;">
                        <p style="margin:0; font-size:1rem;">${info.story}</p>
                        <div style="margin-top:12px; font-size:0.9rem; opacity:0.8;">
                            Tip: Click your avatar to see a little show!
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; background: rgba(255,255,255,0.5); border-top:2px solid rgba(0,0,0,0.05);">
                        <button id="avatarInfoOk" style="
                            background: linear-gradient(135deg, #FFD700, #FFA000);
                            color:#5A2C15; border:none; padding:10px 16px; border-radius:12px;
                            font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(255,165,0,0.35);
                        ">Got it!</button>
                    </div>
                `;

                modal.appendChild(card);
                document.body.appendChild(modal);

                // Keyboard support (ESC to close) - define before using in handlers
                const onKeyDown = (ev) => { if (ev.key === 'Escape') onClose(); };

                // Close handlers
                const onClose = () => { modal.remove(); document.removeEventListener('keydown', onKeyDown); };
                document.getElementById('avatarInfoClose').onclick = onClose;
                document.getElementById('avatarInfoOk').onclick = onClose;

                // Click outside to close
                modal.addEventListener('click', (e) => { if (e.target === modal) onClose(); });
                document.addEventListener('keydown', onKeyDown);
            } catch (e) {
                console.error('Avatar info modal failed:', e);
                showErrorMessage('Could not load avatar info right now.');
            }
        }

        // Update User Info Display (Welcome message and Avatar name)
        async function updateUserInfoDisplay() {
            try {
                // Fetch user info and avatar info in parallel
                const [userResponse, avatarResponse] = await Promise.all([
                    fetch('/api/users/me'),
                    fetch('/api/users/me/avatar')
                ]);
                
                const userData = await userResponse.json();
                const avatarData = await avatarResponse.json();
                
                // Update welcome message with user's name
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (welcomeMsg && userData.status === 'success') {
                    const displayName = userData.user.display_name || 'NewBee';
                    welcomeMsg.textContent = `Welcome, ${displayName}!`;
                    console.log('✅ Welcome message updated:', displayName);
                }
                
                // Update avatar name badge
                const avatarNameBadge = document.getElementById('avatarNameBadge');
                const avatarNameDisplay = document.getElementById('avatarNameDisplay');
                
                if (avatarData.status === 'success' && avatarData.avatar) {
                    const avatarName = avatarData.avatar.name || avatarData.avatar.avatar_id || 'Bee Avatar';
                    
                    if (avatarNameDisplay) {
                        avatarNameDisplay.textContent = avatarName;
                    }
                    
                    // Show the badge
                    if (avatarNameBadge) {
                        avatarNameBadge.style.display = 'block';
                    }
                    
                    console.log('✅ Avatar name display updated:', avatarName);
                } else {
                    // Hide badge if no avatar
                    if (avatarNameBadge) {
                        avatarNameBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('❌ Error updating user info display:', error);
                // Set defaults on error
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (welcomeMsg) {
                    welcomeMsg.textContent = 'Welcome, NewBee!';
                }
                
                // Hide badge on error
                const avatarNameBadge = document.getElementById('avatarNameBadge');
                if (avatarNameBadge) {
                    avatarNameBadge.style.display = 'none';
                }
            }
        }

        // Avatar System Status Management
        function updateAvatarSystemStatus() {
            const statusBadge = document.getElementById('avatarSystemStatus');
            const statusText = document.getElementById('avatarStatusText');
            
            if (!statusBadge || !statusText) return;
            
            if (window.userAvatarLoader && window.avatarPreloadResults) {
                const health = window.userAvatarLoader.getSystemHealthBadge();
                
                statusBadge.style.display = 'block';
                statusBadge.style.backgroundColor = health.color;
                statusBadge.style.color = 'white';
                statusText.textContent = health.text;
                
                // Add pulsing animation for issues
                if (health.status !== 'healthy') {
                    statusBadge.style.animation = 'pulse 2s infinite';
                } else {
                    statusBadge.style.animation = 'none';
                }
                
                console.log('📊 Avatar system status updated:', health);
            } else {
                statusText.textContent = 'Not Ready';
                statusBadge.style.backgroundColor = '#999';
            }
        }

        function showAvatarSystemDetails() {
            if (!window.userAvatarLoader) {
                showErrorMessage('Avatar system not initialized');
                return;
            }
            
            const statusReport = window.userAvatarLoader.displaySystemStatus();
            
            if (!statusReport || statusReport === 'No preload results available - system may not be initialized') {
                showErrorMessage('No avatar system data available');
                return;
            }
            
            let detailsHTML = `
                <div style="text-align: left; font-family: monospace; font-size: 12px;">
                    <h3>🐝 Avatar System Status Report</h3>
                    <p><strong>Overall Status:</strong> ${statusReport.details.systemStatus}</p>
                    <p><strong>Success Rate:</strong> ${statusReport.details.successRate}</p>
                    <p><strong>Working Avatars:</strong> ${statusReport.details.workingAvatars}/${statusReport.details.totalAvatars}</p>
                    <p><strong>Fallback System:</strong> ${statusReport.details.fallbackStatus}</p>
            `;
            
            if (statusReport.failedList.length > 0) {
                detailsHTML += `
                    <hr>
                    <h4>❌ Failed Avatars:</h4>
                    <ul style="font-size: 10px;">
                `;
                statusReport.failedList.forEach(failure => {
                    detailsHTML += `<li>${failure.avatar}: ${failure.error}</li>`;
                });
                detailsHTML += '</ul>';
            }
            
            detailsHTML += '</div>';
            
            showBeeAlert({
                title: '📊 Avatar System Diagnostics',
                message: detailsHTML,
                allowHTML: true,
                confirmText: 'Close'
            });
        }

        // Update status after avatar preload completes
        document.addEventListener('DOMContentLoaded', () => {
            // Update user info display
            updateUserInfoDisplay();
            
            // Wait a bit for preload to complete, then update status
            setTimeout(updateAvatarSystemStatus, 2000);
            
            // Update status periodically
            setInterval(updateAvatarSystemStatus, 10000);
        });

    </script>
</body>
</html>